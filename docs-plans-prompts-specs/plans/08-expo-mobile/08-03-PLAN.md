---
phase: 08-expo-mobile
plan: 03
type: execute
domain: react-native
---

<objective>
Create home screen with story list and new story creation flow with GitHub URL input.
</objective>

<context>
@BRIEF.md
@codestory/mobile/lib/api.ts
@codestory/mobile/contexts/AuthContext.tsx
</context>

<tasks>

<task type="auto">
  <n>Task 1: Create home screen</n>
  <files>codestory/mobile/app/(app)/home.tsx, codestory/mobile/app/(app)/_layout.tsx</files>
  <action>
(app)/_layout.tsx:
```tsx
import { Stack } from "expo-router";

export default function AppLayout() {
  return (
    <Stack screenOptions={{ headerShown: false }}>
      <Stack.Screen name="home" />
      <Stack.Screen name="new" />
      <Stack.Screen name="story/[id]" />
      <Stack.Screen name="player/[id]" />
    </Stack>
  );
}
```

(app)/home.tsx:
```tsx
import { useState, useCallback } from "react";
import { View, Text, FlatList, TouchableOpacity, RefreshControl, ActivityIndicator } from "react-native";
import { useRouter } from "expo-router";
import { useQuery } from "@tanstack/react-query";
import { Plus, Headphones, Clock, CheckCircle, AlertCircle, Settings } from "lucide-react-native";
import { api } from "@/lib/api";
import { useAuth } from "@/contexts/AuthContext";
import { formatDistanceToNow } from "date-fns";

interface Story {
  id: string;
  title: string;
  repository_url: string;
  status: string;
  style: string;
  created_at: string;
  total_duration_seconds: number | null;
}

export default function HomeScreen() {
  const router = useRouter();
  const { user, logout } = useAuth();
  const [refreshing, setRefreshing] = useState(false);

  const { data, isLoading, refetch } = useQuery({
    queryKey: ["stories"],
    queryFn: async () => {
      const response = await api.get("/stories");
      return response.data.stories as Story[];
    },
  });

  const onRefresh = useCallback(async () => {
    setRefreshing(true);
    await refetch();
    setRefreshing(false);
  }, [refetch]);

  const stories = data || [];

  return (
    <View className="flex-1 bg-slate-900">
      {/* Header */}
      <View className="bg-slate-800 px-4 pt-14 pb-4 flex-row items-center justify-between">
        <View className="flex-row items-center">
          <Headphones size={24} color="#818cf8" />
          <Text className="text-xl font-bold text-white ml-2">Code Story</Text>
        </View>
        <TouchableOpacity onPress={logout}>
          <Settings size={24} color="#94a3b8" />
        </TouchableOpacity>
      </View>

      {/* Content */}
      <View className="flex-1 px-4 pt-4">
        <View className="flex-row items-center justify-between mb-4">
          <Text className="text-lg font-semibold text-white">Your Stories</Text>
          <TouchableOpacity
            onPress={() => router.push("/(app)/new")}
            className="bg-indigo-600 rounded-full px-4 py-2 flex-row items-center"
          >
            <Plus size={18} color="white" />
            <Text className="text-white font-medium ml-1">New</Text>
          </TouchableOpacity>
        </View>

        {isLoading ? (
          <View className="flex-1 items-center justify-center">
            <ActivityIndicator color="#818cf8" size="large" />
          </View>
        ) : stories.length === 0 ? (
          <EmptyState onNewStory={() => router.push("/(app)/new")} />
        ) : (
          <FlatList
            data={stories}
            keyExtractor={(item) => item.id}
            renderItem={({ item }) => (
              <StoryCard
                story={item}
                onPress={() => {
                  if (item.status === "complete") {
                    router.push(`/(app)/player/${item.id}`);
                  } else {
                    router.push(`/(app)/story/${item.id}`);
                  }
                }}
              />
            )}
            refreshControl={
              <RefreshControl
                refreshing={refreshing}
                onRefresh={onRefresh}
                tintColor="#818cf8"
              />
            }
            contentContainerStyle={{ paddingBottom: 20 }}
          />
        )}
      </View>
    </View>
  );
}

function StoryCard({ story, onPress }: { story: Story; onPress: () => void }) {
  const repoName = story.repository_url.split("/").slice(-2).join("/");
  
  const statusConfig: Record<string, { color: string; icon: any }> = {
    pending: { color: "#eab308", icon: Clock },
    analyzing: { color: "#3b82f6", icon: Clock },
    generating: { color: "#a855f7", icon: Clock },
    synthesizing: { color: "#6366f1", icon: Clock },
    complete: { color: "#22c55e", icon: CheckCircle },
    failed: { color: "#ef4444", icon: AlertCircle },
  };

  const config = statusConfig[story.status] || statusConfig.pending;
  const StatusIcon = config.icon;

  return (
    <TouchableOpacity
      onPress={onPress}
      className="bg-slate-800 rounded-xl p-4 mb-3"
    >
      <View className="flex-row items-start justify-between">
        <View className="flex-1">
          <Text className="text-white font-medium text-base" numberOfLines={1}>
            {story.title || repoName}
          </Text>
          <Text className="text-slate-400 text-sm mt-1">{repoName}</Text>
        </View>
        <StatusIcon size={20} color={config.color} />
      </View>

      <View className="flex-row items-center mt-3">
        <View className="bg-slate-700 rounded-full px-2 py-1">
          <Text className="text-slate-400 text-xs capitalize">{story.style}</Text>
        </View>
        {story.total_duration_seconds && (
          <View className="flex-row items-center ml-3">
            <Clock size={12} color="#64748b" />
            <Text className="text-slate-500 text-xs ml-1">
              {Math.round(story.total_duration_seconds / 60)} min
            </Text>
          </View>
        )}
        <Text className="text-slate-500 text-xs ml-auto">
          {formatDistanceToNow(new Date(story.created_at), { addSuffix: true })}
        </Text>
      </View>
    </TouchableOpacity>
  );
}

function EmptyState({ onNewStory }: { onNewStory: () => void }) {
  return (
    <View className="flex-1 items-center justify-center">
      <Headphones size={64} color="#334155" />
      <Text className="text-xl font-semibold text-white mt-4">No stories yet</Text>
      <Text className="text-slate-400 mt-2 text-center">
        Create your first code story{"\n"}to get started
      </Text>
      <TouchableOpacity
        onPress={onNewStory}
        className="bg-indigo-600 rounded-lg px-6 py-3 mt-6"
      >
        <Text className="text-white font-semibold">Create Story</Text>
      </TouchableOpacity>
    </View>
  );
}
```
  </action>
  <verify>Check home screen renders</verify>
  <done>Home screen created</done>
</task>

<task type="auto">
  <n>Task 2: Create new story screen</n>
  <files>codestory/mobile/app/(app)/new.tsx</files>
  <action>
Create new story screen:

```tsx
import { useState } from "react";
import { View, Text, TextInput, TouchableOpacity, ScrollView, ActivityIndicator, Alert } from "react-native";
import { useRouter } from "expo-router";
import { ArrowLeft, Github, Zap, MessageSquare, ChevronRight } from "lucide-react-native";
import { api } from "@/lib/api";

const GITHUB_URL_REGEX = /^https?:\/\/(www\.)?github\.com\/[\w-]+\/[\w.-]+\/?$/;

export default function NewStoryScreen() {
  const router = useRouter();
  const [repoUrl, setRepoUrl] = useState("");
  const [mode, setMode] = useState<"quick" | "custom">("quick");
  const [expertiseLevel, setExpertiseLevel] = useState("intermediate");
  const [style, setStyle] = useState("documentary");
  const [isLoading, setIsLoading] = useState(false);

  function validateUrl(url: string): boolean {
    return GITHUB_URL_REGEX.test(url.trim());
  }

  async function handleSubmit() {
    if (!validateUrl(repoUrl)) {
      Alert.alert("Invalid URL", "Please enter a valid GitHub repository URL");
      return;
    }

    setIsLoading(true);

    try {
      const response = await api.post("/stories", {
        repository_url: repoUrl.trim(),
        mode,
        expertise_level: expertiseLevel,
        style,
      });

      const { story_id } = response.data;

      if (mode === "custom") {
        router.replace(`/(app)/story/${story_id}/intent`);
      } else {
        router.replace(`/(app)/story/${story_id}`);
      }
    } catch (error: any) {
      Alert.alert("Error", error.response?.data?.detail || "Failed to create story");
    } finally {
      setIsLoading(false);
    }
  }

  return (
    <View className="flex-1 bg-slate-900">
      {/* Header */}
      <View className="bg-slate-800 px-4 pt-14 pb-4 flex-row items-center">
        <TouchableOpacity onPress={() => router.back()}>
          <ArrowLeft size={24} color="white" />
        </TouchableOpacity>
        <Text className="text-xl font-bold text-white ml-4">New Story</Text>
      </View>

      <ScrollView className="flex-1 px-4 pt-6">
        {/* URL Input */}
        <View className="bg-slate-800 rounded-xl p-4 mb-4">
          <View className="flex-row items-center mb-3">
            <Github size={20} color="#818cf8" />
            <Text className="text-white font-medium ml-2">GitHub Repository</Text>
          </View>
          <TextInput
            value={repoUrl}
            onChangeText={setRepoUrl}
            placeholder="https://github.com/owner/repo"
            placeholderTextColor="#64748b"
            autoCapitalize="none"
            autoCorrect={false}
            className="bg-slate-700 rounded-lg px-4 py-3 text-white"
          />
        </View>

        {/* Mode Selection */}
        <View className="bg-slate-800 rounded-xl p-4 mb-4">
          <Text className="text-white font-medium mb-3">Generation Mode</Text>
          
          <TouchableOpacity
            onPress={() => setMode("quick")}
            className={`p-4 rounded-lg mb-2 border ${
              mode === "quick" ? "border-indigo-500 bg-indigo-500/10" : "border-slate-600"
            }`}
          >
            <View className="flex-row items-center">
              <Zap size={24} color={mode === "quick" ? "#818cf8" : "#64748b"} />
              <View className="ml-3 flex-1">
                <Text className="text-white font-medium">Quick Mode</Text>
                <Text className="text-slate-400 text-sm">Fast generation with smart defaults</Text>
              </View>
            </View>
          </TouchableOpacity>

          <TouchableOpacity
            onPress={() => setMode("custom")}
            className={`p-4 rounded-lg border ${
              mode === "custom" ? "border-indigo-500 bg-indigo-500/10" : "border-slate-600"
            }`}
          >
            <View className="flex-row items-center">
              <MessageSquare size={24} color={mode === "custom" ? "#818cf8" : "#64748b"} />
              <View className="ml-3 flex-1">
                <Text className="text-white font-medium">Custom Mode</Text>
                <Text className="text-slate-400 text-sm">Guided conversation for tailored story</Text>
              </View>
            </View>
          </TouchableOpacity>
        </View>

        {/* Quick Mode Options */}
        {mode === "quick" && (
          <View className="bg-slate-800 rounded-xl p-4 mb-4">
            <Text className="text-white font-medium mb-3">Expertise Level</Text>
            <View className="flex-row flex-wrap gap-2 mb-4">
              {["beginner", "intermediate", "advanced"].map((level) => (
                <TouchableOpacity
                  key={level}
                  onPress={() => setExpertiseLevel(level)}
                  className={`px-4 py-2 rounded-lg border ${
                    expertiseLevel === level
                      ? "border-indigo-500 bg-indigo-500/20"
                      : "border-slate-600"
                  }`}
                >
                  <Text className={`capitalize ${
                    expertiseLevel === level ? "text-indigo-300" : "text-slate-400"
                  }`}>
                    {level}
                  </Text>
                </TouchableOpacity>
              ))}
            </View>

            <Text className="text-white font-medium mb-3">Narrative Style</Text>
            <View className="flex-row flex-wrap gap-2">
              {["documentary", "tutorial", "podcast", "fiction", "technical"].map((s) => (
                <TouchableOpacity
                  key={s}
                  onPress={() => setStyle(s)}
                  className={`px-4 py-2 rounded-lg border ${
                    style === s
                      ? "border-indigo-500 bg-indigo-500/20"
                      : "border-slate-600"
                  }`}
                >
                  <Text className={`capitalize ${
                    style === s ? "text-indigo-300" : "text-slate-400"
                  }`}>
                    {s}
                  </Text>
                </TouchableOpacity>
              ))}
            </View>
          </View>
        )}

        {/* Submit Button */}
        <TouchableOpacity
          onPress={handleSubmit}
          disabled={isLoading || !repoUrl}
          className={`rounded-xl py-4 flex-row items-center justify-center mb-8 ${
            isLoading || !repoUrl ? "bg-slate-700" : "bg-indigo-600"
          }`}
        >
          {isLoading ? (
            <ActivityIndicator color="white" />
          ) : (
            <>
              <Text className="text-white font-semibold text-lg">
                {mode === "quick" ? "Generate Story" : "Start Conversation"}
              </Text>
              <ChevronRight size={20} color="white" className="ml-1" />
            </>
          )}
        </TouchableOpacity>
      </ScrollView>
    </View>
  );
}
```
  </action>
  <verify>Check new story screen renders</verify>
  <done>New story screen created</done>
</task>

</tasks>

<playwright_validation_gate>
```
# Home screen loads stories
Playwright Action: Navigate to home after login
Expected: Story list or empty state shown

# New story navigation
Playwright Action: Tap "New" button
Expected: Navigate to new story screen

# URL validation
Playwright Action: Enter invalid URL, tap submit
Expected: Alert shows validation error

# Create story - quick mode
Playwright Action: Enter valid URL, select quick mode, submit
Expected: Navigate to progress screen

# Pull to refresh
Playwright Action: Pull down on story list
Expected: Stories refresh
```
</playwright_validation_gate>
