---
phase: 08-expo-mobile
plan: 02
type: execute
domain: react-native
---

<objective>
Create mobile authentication screens (login, register) with secure token storage and session management.
</objective>

<context>
@BRIEF.md
@codestory/mobile/lib/api.ts
@codestory/mobile/lib/storage.ts
</context>

<tasks>

<task type="auto">
  <n>Task 1: Create AuthContext</n>
  <files>codestory/mobile/contexts/AuthContext.tsx</files>
  <action>
Create auth context:

```tsx
import { createContext, useContext, useState, useEffect, ReactNode } from "react";
import { useRouter, useSegments } from "expo-router";
import { api } from "@/lib/api";
import { saveToken, getToken, saveUser, getUser, clearAuth } from "@/lib/storage";

interface User {
  id: string;
  name: string;
  email: string;
}

interface AuthContextType {
  user: User | null;
  isLoading: boolean;
  isAuthenticated: boolean;
  login: (email: string, password: string) => Promise<void>;
  register: (name: string, email: string, password: string) => Promise<void>;
  logout: () => Promise<void>;
}

const AuthContext = createContext<AuthContextType | null>(null);

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const router = useRouter();
  const segments = useSegments();

  useEffect(() => {
    checkAuth();
  }, []);

  useEffect(() => {
    if (isLoading) return;

    const inAuthGroup = segments[0] === "(auth)";

    if (!user && !inAuthGroup) {
      router.replace("/(auth)/login");
    } else if (user && inAuthGroup) {
      router.replace("/(app)/home");
    }
  }, [user, segments, isLoading]);

  async function checkAuth() {
    try {
      const token = await getToken();
      if (!token) {
        setIsLoading(false);
        return;
      }

      const cachedUser = await getUser();
      if (cachedUser) {
        setUser(cachedUser);
      }

      // Verify token with server
      const response = await api.get("/auth/me");
      setUser(response.data);
      await saveUser(response.data);
    } catch (error) {
      await clearAuth();
    } finally {
      setIsLoading(false);
    }
  }

  async function login(email: string, password: string) {
    const response = await api.post("/auth/login", { email, password });
    const { access_token, user } = response.data;
    
    await saveToken(access_token);
    await saveUser(user);
    setUser(user);
  }

  async function register(name: string, email: string, password: string) {
    const response = await api.post("/auth/register", { name, email, password });
    const { access_token, user } = response.data;
    
    await saveToken(access_token);
    await saveUser(user);
    setUser(user);
  }

  async function logout() {
    await clearAuth();
    setUser(null);
  }

  return (
    <AuthContext.Provider value={{
      user,
      isLoading,
      isAuthenticated: !!user,
      login,
      register,
      logout,
    }}>
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error("useAuth must be used within AuthProvider");
  }
  return context;
}
```
  </action>
  <verify>Check auth context provides values</verify>
  <done>AuthContext created</done>
</task>

<task type="auto">
  <n>Task 2: Create auth screens</n>
  <files>codestory/mobile/app/(auth)/login.tsx, codestory/mobile/app/(auth)/register.tsx, codestory/mobile/app/(auth)/_layout.tsx</files>
  <action>
(auth)/_layout.tsx:
```tsx
import { Stack } from "expo-router";

export default function AuthLayout() {
  return (
    <Stack screenOptions={{ headerShown: false }}>
      <Stack.Screen name="login" />
      <Stack.Screen name="register" />
    </Stack>
  );
}
```

(auth)/login.tsx:
```tsx
import { useState } from "react";
import { View, Text, TextInput, TouchableOpacity, ActivityIndicator, KeyboardAvoidingView, Platform } from "react-native";
import { Link } from "expo-router";
import { useAuth } from "@/contexts/AuthContext";
import { Headphones } from "lucide-react-native";

export default function LoginScreen() {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [error, setError] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const { login } = useAuth();

  async function handleLogin() {
    if (!email || !password) {
      setError("Please fill in all fields");
      return;
    }

    setError("");
    setIsLoading(true);

    try {
      await login(email, password);
    } catch (err: any) {
      setError(err.response?.data?.detail || "Invalid email or password");
    } finally {
      setIsLoading(false);
    }
  }

  return (
    <KeyboardAvoidingView
      behavior={Platform.OS === "ios" ? "padding" : "height"}
      className="flex-1 bg-slate-900"
    >
      <View className="flex-1 justify-center px-6">
        <View className="items-center mb-8">
          <Headphones size={48} color="#818cf8" />
          <Text className="text-2xl font-bold text-white mt-4">Code Story</Text>
        </View>

        <View className="bg-slate-800 rounded-2xl p-6">
          <Text className="text-2xl font-bold text-white mb-6">Welcome back</Text>

          {error ? (
            <View className="bg-red-500/10 border border-red-500/20 rounded-lg p-3 mb-4">
              <Text className="text-red-400">{error}</Text>
            </View>
          ) : null}

          <View className="mb-4">
            <Text className="text-slate-400 mb-2">Email</Text>
            <TextInput
              value={email}
              onChangeText={setEmail}
              placeholder="you@example.com"
              placeholderTextColor="#64748b"
              autoCapitalize="none"
              keyboardType="email-address"
              className="bg-slate-700 rounded-lg px-4 py-3 text-white"
            />
          </View>

          <View className="mb-6">
            <Text className="text-slate-400 mb-2">Password</Text>
            <TextInput
              value={password}
              onChangeText={setPassword}
              placeholder="••••••••"
              placeholderTextColor="#64748b"
              secureTextEntry
              className="bg-slate-700 rounded-lg px-4 py-3 text-white"
            />
          </View>

          <TouchableOpacity
            onPress={handleLogin}
            disabled={isLoading}
            className="bg-indigo-600 rounded-lg py-4 items-center"
          >
            {isLoading ? (
              <ActivityIndicator color="white" />
            ) : (
              <Text className="text-white font-semibold text-lg">Sign In</Text>
            )}
          </TouchableOpacity>

          <View className="flex-row justify-center mt-6">
            <Text className="text-slate-400">Don't have an account? </Text>
            <Link href="/(auth)/register" asChild>
              <TouchableOpacity>
                <Text className="text-indigo-400">Sign up</Text>
              </TouchableOpacity>
            </Link>
          </View>
        </View>
      </View>
    </KeyboardAvoidingView>
  );
}
```

(auth)/register.tsx:
```tsx
import { useState } from "react";
import { View, Text, TextInput, TouchableOpacity, ActivityIndicator, KeyboardAvoidingView, Platform, ScrollView } from "react-native";
import { Link } from "expo-router";
import { useAuth } from "@/contexts/AuthContext";
import { Headphones } from "lucide-react-native";

export default function RegisterScreen() {
  const [name, setName] = useState("");
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [confirmPassword, setConfirmPassword] = useState("");
  const [error, setError] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const { register } = useAuth();

  async function handleRegister() {
    if (!name || !email || !password || !confirmPassword) {
      setError("Please fill in all fields");
      return;
    }

    if (password !== confirmPassword) {
      setError("Passwords do not match");
      return;
    }

    if (password.length < 8) {
      setError("Password must be at least 8 characters");
      return;
    }

    setError("");
    setIsLoading(true);

    try {
      await register(name, email, password);
    } catch (err: any) {
      setError(err.response?.data?.detail || "Failed to create account");
    } finally {
      setIsLoading(false);
    }
  }

  return (
    <KeyboardAvoidingView
      behavior={Platform.OS === "ios" ? "padding" : "height"}
      className="flex-1 bg-slate-900"
    >
      <ScrollView contentContainerStyle={{ flexGrow: 1, justifyContent: "center" }} className="px-6">
        <View className="items-center mb-8">
          <Headphones size={48} color="#818cf8" />
          <Text className="text-2xl font-bold text-white mt-4">Code Story</Text>
        </View>

        <View className="bg-slate-800 rounded-2xl p-6">
          <Text className="text-2xl font-bold text-white mb-6">Create account</Text>

          {error ? (
            <View className="bg-red-500/10 border border-red-500/20 rounded-lg p-3 mb-4">
              <Text className="text-red-400">{error}</Text>
            </View>
          ) : null}

          <View className="mb-4">
            <Text className="text-slate-400 mb-2">Name</Text>
            <TextInput
              value={name}
              onChangeText={setName}
              placeholder="Your name"
              placeholderTextColor="#64748b"
              className="bg-slate-700 rounded-lg px-4 py-3 text-white"
            />
          </View>

          <View className="mb-4">
            <Text className="text-slate-400 mb-2">Email</Text>
            <TextInput
              value={email}
              onChangeText={setEmail}
              placeholder="you@example.com"
              placeholderTextColor="#64748b"
              autoCapitalize="none"
              keyboardType="email-address"
              className="bg-slate-700 rounded-lg px-4 py-3 text-white"
            />
          </View>

          <View className="mb-4">
            <Text className="text-slate-400 mb-2">Password</Text>
            <TextInput
              value={password}
              onChangeText={setPassword}
              placeholder="••••••••"
              placeholderTextColor="#64748b"
              secureTextEntry
              className="bg-slate-700 rounded-lg px-4 py-3 text-white"
            />
          </View>

          <View className="mb-6">
            <Text className="text-slate-400 mb-2">Confirm Password</Text>
            <TextInput
              value={confirmPassword}
              onChangeText={setConfirmPassword}
              placeholder="••••••••"
              placeholderTextColor="#64748b"
              secureTextEntry
              className="bg-slate-700 rounded-lg px-4 py-3 text-white"
            />
          </View>

          <TouchableOpacity
            onPress={handleRegister}
            disabled={isLoading}
            className="bg-indigo-600 rounded-lg py-4 items-center"
          >
            {isLoading ? (
              <ActivityIndicator color="white" />
            ) : (
              <Text className="text-white font-semibold text-lg">Create Account</Text>
            )}
          </TouchableOpacity>

          <View className="flex-row justify-center mt-6">
            <Text className="text-slate-400">Already have an account? </Text>
            <Link href="/(auth)/login" asChild>
              <TouchableOpacity>
                <Text className="text-indigo-400">Sign in</Text>
              </TouchableOpacity>
            </Link>
          </View>
        </View>
      </ScrollView>
    </KeyboardAvoidingView>
  );
}
```
  </action>
  <verify>Check auth screens render</verify>
  <done>Auth screens created</done>
</task>

</tasks>

<playwright_validation_gate>
```
# Login screen loads
Playwright Action: Navigate to /(auth)/login
Expected: See login form with email/password fields

# Validation errors show
Playwright Action: Tap "Sign In" with empty fields
Expected: Error message appears

# Login flow
Playwright Action: Enter valid credentials, tap "Sign In"
Expected: Redirect to home screen

# Register flow
Playwright Action: Navigate to register, fill form, submit
Expected: Account created, redirect to home

# Session persists
Playwright Action: Close and reopen app
Expected: User remains logged in
```
</playwright_validation_gate>
