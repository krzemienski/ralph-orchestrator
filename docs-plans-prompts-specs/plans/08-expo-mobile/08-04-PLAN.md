---
phase: 08-expo-mobile
plan: 04
type: execute
domain: react-native
---

<objective>
Implement conversational intent chat interface for custom story mode with real-time message display.
</objective>

<context>
@BRIEF.md
@plans/08-expo-mobile/08-03-PLAN.md
@plans/02-intent-agent/02-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <n>Task 1: Create chat interface with message components</n>
  <files>codestory/mobile/app/story/[id]/intent.tsx, codestory/mobile/components/ChatMessage.tsx</files>
  <action>
Create components/ChatMessage.tsx:

```typescript
import { View, Text } from 'react-native'
import { Ionicons } from '@expo/vector-icons'

interface Message {
  id: string
  role: 'user' | 'assistant'
  content: string
  timestamp: Date
}

interface ChatMessageProps {
  message: Message
}

export function ChatMessage({ message }: ChatMessageProps) {
  const isUser = message.role === 'user'

  return (
    <View className={`flex-row mb-4 ${isUser ? 'justify-end' : 'justify-start'}`}>
      {!isUser && (
        <View className="w-8 h-8 rounded-full bg-primary-600 items-center justify-center mr-2">
          <Ionicons name="sparkles" size={16} color="white" />
        </View>
      )}

      <View
        className={`max-w-[80%] rounded-2xl px-4 py-3 ${
          isUser
            ? 'bg-primary-600 rounded-br-sm'
            : 'bg-dark-card border border-dark-border rounded-bl-sm'
        }`}
      >
        <Text className={isUser ? 'text-white' : 'text-dark-text'}>
          {message.content}
        </Text>
      </View>

      {isUser && (
        <View className="w-8 h-8 rounded-full bg-dark-muted/30 items-center justify-center ml-2">
          <Ionicons name="person" size={16} color="#94a3b8" />
        </View>
      )}
    </View>
  )
}
```

Create app/story/[id]/intent.tsx:

```typescript
import { useState, useRef, useEffect } from 'react'
import {
  View,
  Text,
  TextInput,
  TouchableOpacity,
  FlatList,
  KeyboardAvoidingView,
  Platform,
  ActivityIndicator,
} from 'react-native'
import { useLocalSearchParams, router } from 'expo-router'
import { SafeAreaView } from 'react-native-safe-area-context'
import { Ionicons } from '@expo/vector-icons'
import { api } from '@/lib/api'
import { ChatMessage } from '@/components/ChatMessage'

interface Message {
  id: string
  role: 'user' | 'assistant'
  content: string
  timestamp: Date
}

export default function IntentChatScreen() {
  const { id: storyId } = useLocalSearchParams<{ id: string }>()
  const [messages, setMessages] = useState<Message[]>([])
  const [input, setInput] = useState('')
  const [isLoading, setIsLoading] = useState(false)
  const [isComplete, setIsComplete] = useState(false)
  const flatListRef = useRef<FlatList>(null)

  useEffect(() => {
    initializeChat()
  }, [])

  async function initializeChat() {
    setIsLoading(true)
    try {
      const response = await api.post(`/stories/${storyId}/intent/start`)
      const assistantMessage: Message = {
        id: Date.now().toString(),
        role: 'assistant',
        content: response.data.message,
        timestamp: new Date(),
      }
      setMessages([assistantMessage])
    } catch (error) {
      console.error('Failed to start intent chat:', error)
    } finally {
      setIsLoading(false)
    }
  }

  async function handleSend() {
    if (!input.trim() || isLoading) return

    const userMessage: Message = {
      id: Date.now().toString(),
      role: 'user',
      content: input.trim(),
      timestamp: new Date(),
    }

    setMessages((prev) => [...prev, userMessage])
    setInput('')
    setIsLoading(true)

    try {
      const response = await api.post(`/stories/${storyId}/intent/message`, {
        message: userMessage.content,
      })

      const assistantMessage: Message = {
        id: (Date.now() + 1).toString(),
        role: 'assistant',
        content: response.data.message,
        timestamp: new Date(),
      }

      setMessages((prev) => [...prev, assistantMessage])

      if (response.data.intent_complete) {
        setIsComplete(true)
      }
    } catch (error) {
      console.error('Failed to send message:', error)
    } finally {
      setIsLoading(false)
    }
  }

  async function handleConfirmIntent() {
    setIsLoading(true)
    try {
      await api.post(`/stories/${storyId}/intent/confirm`)
      router.replace(`/story/${storyId}`)
    } catch (error) {
      console.error('Failed to confirm intent:', error)
    } finally {
      setIsLoading(false)
    }
  }

  return (
    <SafeAreaView className="flex-1 bg-dark-bg" edges={['top']}>
      <View className="flex-row items-center px-4 py-3 border-b border-dark-border">
        <TouchableOpacity onPress={() => router.back()} className="mr-3">
          <Ionicons name="arrow-back" size={24} color="#f8fafc" />
        </TouchableOpacity>
        <View className="flex-1">
          <Text className="text-lg font-semibold text-dark-text">Customize Your Story</Text>
          <Text className="text-dark-muted text-sm">Tell me what you want to learn</Text>
        </View>
      </View>

      <KeyboardAvoidingView
        behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
        className="flex-1"
        keyboardVerticalOffset={0}
      >
        <FlatList
          ref={flatListRef}
          data={messages}
          keyExtractor={(item) => item.id}
          renderItem={({ item }) => <ChatMessage message={item} />}
          contentContainerStyle={{ padding: 16, flexGrow: 1 }}
          onContentSizeChange={() => flatListRef.current?.scrollToEnd()}
          ListEmptyComponent={
            isLoading ? (
              <View className="flex-1 items-center justify-center">
                <ActivityIndicator size="large" color="#3b82f6" />
              </View>
            ) : null
          }
        />

        {isComplete ? (
          <View className="p-4 border-t border-dark-border">
            <Text className="text-dark-text text-center mb-3">
              Ready to generate your personalized story?
            </Text>
            <TouchableOpacity
              className="bg-primary-600 py-4 rounded-xl items-center"
              onPress={handleConfirmIntent}
              disabled={isLoading}
            >
              {isLoading ? (
                <ActivityIndicator color="white" />
              ) : (
                <Text className="text-white font-semibold text-lg">Generate Story</Text>
              )}
            </TouchableOpacity>
          </View>
        ) : (
          <View className="flex-row items-end p-4 border-t border-dark-border">
            <TextInput
              className="flex-1 bg-dark-card border border-dark-border rounded-2xl px-4 py-3 text-dark-text max-h-32"
              placeholder="Type your message..."
              placeholderTextColor="#64748b"
              value={input}
              onChangeText={setInput}
              multiline
              editable={!isLoading}
            />
            <TouchableOpacity
              className={`ml-2 w-12 h-12 rounded-full items-center justify-center ${
                input.trim() && !isLoading ? 'bg-primary-600' : 'bg-dark-card'
              }`}
              onPress={handleSend}
              disabled={!input.trim() || isLoading}
            >
              {isLoading ? (
                <ActivityIndicator size="small" color="#3b82f6" />
              ) : (
                <Ionicons
                  name="send"
                  size={20}
                  color={input.trim() ? 'white' : '#64748b'}
                />
              )}
            </TouchableOpacity>
          </View>
        )}
      </KeyboardAvoidingView>
    </SafeAreaView>
  )
}
```
  </action>
  <verify>cd codestory/mobile && npx tsc --noEmit</verify>
  <done>Intent chat interface implemented</done>
</task>

<task type="auto">
  <n>Task 2: Create story detail screen with generation progress</n>
  <files>codestory/mobile/app/story/[id]/index.tsx</files>
  <action>
Create app/story/[id]/index.tsx:

```typescript
import { useState, useEffect } from 'react'
import { View, Text, ScrollView, TouchableOpacity, ActivityIndicator } from 'react-native'
import { useLocalSearchParams, router } from 'expo-router'
import { SafeAreaView } from 'react-native-safe-area-context'
import { Ionicons } from '@expo/vector-icons'
import { api } from '@/lib/api'

interface StoryChapter {
  id: string
  title: string
  duration_seconds: number
  order: number
}

interface Story {
  id: string
  title: string
  repository_url: string
  status: 'pending' | 'processing' | 'completed' | 'failed'
  progress?: number
  progress_message?: string
  chapters: StoryChapter[]
  total_duration_seconds?: number
  error_message?: string
}

export default function StoryDetailScreen() {
  const { id: storyId } = useLocalSearchParams<{ id: string }>()
  const [story, setStory] = useState<Story | null>(null)
  const [isLoading, setIsLoading] = useState(true)

  useEffect(() => {
    fetchStory()

    // Poll for updates if processing
    const interval = setInterval(() => {
      if (story?.status === 'processing' || story?.status === 'pending') {
        fetchStory()
      }
    }, 3000)

    return () => clearInterval(interval)
  }, [storyId, story?.status])

  async function fetchStory() {
    try {
      const response = await api.get(`/stories/${storyId}`)
      setStory(response.data.story)
    } catch (error) {
      console.error('Failed to fetch story:', error)
    } finally {
      setIsLoading(false)
    }
  }

  function formatDuration(seconds: number): string {
    const mins = Math.floor(seconds / 60)
    const secs = seconds % 60
    return `${mins}:${secs.toString().padStart(2, '0')}`
  }

  if (isLoading) {
    return (
      <SafeAreaView className="flex-1 bg-dark-bg items-center justify-center">
        <ActivityIndicator size="large" color="#3b82f6" />
      </SafeAreaView>
    )
  }

  if (!story) {
    return (
      <SafeAreaView className="flex-1 bg-dark-bg items-center justify-center">
        <Ionicons name="alert-circle" size={48} color="#ef4444" />
        <Text className="text-dark-text mt-4">Story not found</Text>
      </SafeAreaView>
    )
  }

  const isProcessing = story.status === 'pending' || story.status === 'processing'
  const isComplete = story.status === 'completed'
  const isFailed = story.status === 'failed'

  return (
    <SafeAreaView className="flex-1 bg-dark-bg">
      <View className="flex-row items-center px-4 py-3 border-b border-dark-border">
        <TouchableOpacity onPress={() => router.back()} className="mr-3">
          <Ionicons name="arrow-back" size={24} color="#f8fafc" />
        </TouchableOpacity>
        <Text className="text-lg font-semibold text-dark-text flex-1" numberOfLines={1}>
          {story.title}
        </Text>
      </View>

      <ScrollView className="flex-1">
        {isProcessing && (
          <View className="m-4 p-6 bg-dark-card border border-dark-border rounded-xl items-center">
            <ActivityIndicator size="large" color="#3b82f6" />
            <Text className="text-dark-text font-semibold mt-4">
              Generating your story...
            </Text>
            {story.progress_message && (
              <Text className="text-dark-muted text-center mt-2">
                {story.progress_message}
              </Text>
            )}
            {story.progress !== undefined && (
              <View className="w-full mt-4">
                <View className="h-2 bg-dark-border rounded-full overflow-hidden">
                  <View
                    className="h-full bg-primary-600 rounded-full"
                    style={{ width: `${story.progress}%` }}
                  />
                </View>
                <Text className="text-dark-muted text-center mt-2">
                  {story.progress}% complete
                </Text>
              </View>
            )}
          </View>
        )}

        {isFailed && (
          <View className="m-4 p-6 bg-red-500/10 border border-red-500/30 rounded-xl">
            <View className="flex-row items-center">
              <Ionicons name="alert-circle" size={24} color="#ef4444" />
              <Text className="text-red-400 font-semibold ml-2">Generation Failed</Text>
            </View>
            {story.error_message && (
              <Text className="text-red-300/80 mt-2">{story.error_message}</Text>
            )}
            <TouchableOpacity
              className="mt-4 bg-red-500/20 py-3 rounded-lg items-center"
              onPress={() => {/* Retry logic */}}
            >
              <Text className="text-red-400 font-semibold">Retry</Text>
            </TouchableOpacity>
          </View>
        )}

        {isComplete && (
          <>
            <View className="m-4 p-4 bg-dark-card border border-dark-border rounded-xl">
              <View className="flex-row items-center justify-between mb-3">
                <Text className="text-dark-muted">Total Duration</Text>
                <Text className="text-dark-text font-semibold">
                  {story.total_duration_seconds
                    ? formatDuration(story.total_duration_seconds)
                    : '--:--'}
                </Text>
              </View>
              <View className="flex-row items-center justify-between">
                <Text className="text-dark-muted">Chapters</Text>
                <Text className="text-dark-text font-semibold">
                  {story.chapters.length}
                </Text>
              </View>
            </View>

            <View className="px-4">
              <Text className="text-dark-text font-semibold text-lg mb-3">Chapters</Text>
              {story.chapters
                .sort((a, b) => a.order - b.order)
                .map((chapter, index) => (
                  <View
                    key={chapter.id}
                    className="flex-row items-center p-4 bg-dark-card border border-dark-border rounded-xl mb-2"
                  >
                    <View className="w-8 h-8 rounded-full bg-primary-600/20 items-center justify-center mr-3">
                      <Text className="text-primary-400 font-semibold">{index + 1}</Text>
                    </View>
                    <View className="flex-1">
                      <Text className="text-dark-text font-medium">{chapter.title}</Text>
                      <Text className="text-dark-muted text-sm">
                        {formatDuration(chapter.duration_seconds)}
                      </Text>
                    </View>
                  </View>
                ))}
            </View>
          </>
        )}
      </ScrollView>

      {isComplete && (
        <View className="p-4 border-t border-dark-border">
          <TouchableOpacity
            className="bg-primary-600 py-4 rounded-xl flex-row items-center justify-center"
            onPress={() => router.push(`/story/${storyId}/play`)}
          >
            <Ionicons name="play" size={20} color="white" />
            <Text className="text-white font-semibold text-lg ml-2">Play Story</Text>
          </TouchableOpacity>
        </View>
      )}
    </SafeAreaView>
  )
}
```
  </action>
  <verify>cd codestory/mobile && npx tsc --noEmit</verify>
  <done>Story detail screen implemented</done>
</task>

</tasks>

<playwright_validation_gate>
```
Playwright Action: Navigate to story detail (processing status)
Expected: Progress indicator and message displayed

Playwright Action: Navigate to completed story
Expected: Chapter list and play button shown

Playwright Action: Navigate to intent chat
Expected: Assistant greeting message appears

Playwright Action: Send message in intent chat
Expected: Response received and displayed
```
</playwright_validation_gate>
