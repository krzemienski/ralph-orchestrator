---
phase: 02-intent-agent
type: execute
domain: python-agent-sdk
---

<objective>
Create the story plan generation skill that produces structured chapter outlines.

Purpose: Transform analyzed user intent into a concrete story plan with chapters, timing, and focus areas.
Output: generate_story_plan tool that produces structured plans for the Story Architect.
</objective>


<context>
@BRIEF.md
@ROADMAP.md
@plans/02-intent-agent/02-01-SUMMARY.md
@plans/02-intent-agent/02-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <n>Task 1: Add story plan data structures</n>
  <files>src/codestory/skills/intent.py</files>
  <action>
    Add story plan data structures to intent.py:
    
    ```python
    # Add to src/codestory/skills/intent.py after UserIntent
    
    @dataclass
    class ChapterOutline:
        """Outline for a single chapter in the story."""
        number: int
        title: str
        focus: str  # What this chapter covers
        duration_minutes: float
        key_concepts: list[str] = field(default_factory=list)
        code_elements: list[str] = field(default_factory=list)  # Files/classes to highlight
        
        def to_dict(self) -> dict:
            """Convert to dictionary."""
            return {
                "number": self.number,
                "title": self.title,
                "focus": self.focus,
                "duration_minutes": self.duration_minutes,
                "key_concepts": self.key_concepts,
                "code_elements": self.code_elements,
            }
    
    
    @dataclass
    class StoryPlan:
        """Complete story plan generated from user intent."""
        title: str
        description: str
        narrative_style: NarrativeStyle
        total_duration_minutes: float
        expertise_level: ExpertiseLevel
        intent_category: IntentCategory
        chapters: list[ChapterOutline] = field(default_factory=list)
        learning_objectives: list[str] = field(default_factory=list)
        prerequisites: list[str] = field(default_factory=list)
        repo_url: str = ""
        
        def to_dict(self) -> dict:
            """Convert to dictionary."""
            return {
                "title": self.title,
                "description": self.description,
                "narrative_style": self.narrative_style,
                "total_duration_minutes": self.total_duration_minutes,
                "expertise_level": self.expertise_level,
                "intent_category": self.intent_category,
                "chapters": [c.to_dict() for c in self.chapters],
                "learning_objectives": self.learning_objectives,
                "prerequisites": self.prerequisites,
                "repo_url": self.repo_url,
            }
    ```
    
    Avoid: Do NOT create overly complex nested structures.
  </action>
  <verify>Data classes import and work correctly</verify>
  <done>StoryPlan and ChapterOutline data classes for structured plan output</done>
</task>

<task type="auto">
  <n>Task 2: Implement generate_story_plan skill</n>
  <files>src/codestory/skills/intent.py</files>
  <action>
    Add generate_story_plan method to IntentSkills:
    
    ```python
    # Add to IntentSkills class in src/codestory/skills/intent.py
    
    @skill(
        description="Generate a structured story plan with chapters, timing, and focus areas"
    )
    @handle_skill_errors
    async def generate_story_plan(
        self,
        repo_url: str,
        intent_category: str,
        expertise_level: str,
        narrative_style: str,
        focus_areas: list[str],
        learning_goals: str,
        target_duration_minutes: int = 15,
    ) -> dict:
        """Generate a complete story plan from analyzed intent.
        
        Args:
            repo_url: GitHub repository URL
            intent_category: Category of user's learning intent
            expertise_level: User's technical expertise level
            narrative_style: Chosen narrative style
            focus_areas: List of specific areas to cover
            learning_goals: User's stated learning objectives
            target_duration_minutes: Target story duration
        
        Returns:
            Complete story plan with chapters and timing
        """
        # Validate inputs
        if intent_category not in ["onboarding", "architecture", "feature", 
                                   "debugging", "review", "documentation"]:
            intent_category = "onboarding"
        
        if expertise_level not in ["beginner", "intermediate", "expert"]:
            expertise_level = "intermediate"
            
        if narrative_style not in ["fiction", "documentary", "tutorial", 
                                   "podcast", "technical"]:
            narrative_style = "documentary"
        
        # Generate title based on intent and style
        title = self._generate_title(repo_url, intent_category, narrative_style)
        
        # Create chapter outlines
        chapters = self._create_chapter_outlines(
            intent_category=intent_category,
            expertise_level=expertise_level,
            focus_areas=focus_areas,
            target_duration=target_duration_minutes,
            narrative_style=narrative_style,
        )
        
        # Calculate total duration
        total_duration = sum(c.duration_minutes for c in chapters)
        
        # Generate learning objectives
        objectives = self._generate_objectives(intent_category, focus_areas, learning_goals)
        
        # Determine prerequisites based on expertise
        prerequisites = self._determine_prerequisites(expertise_level, intent_category)
        
        # Build the story plan
        plan = StoryPlan(
            title=title,
            description=self._generate_description(intent_category, focus_areas),
            narrative_style=narrative_style,
            total_duration_minutes=total_duration,
            expertise_level=expertise_level,
            intent_category=intent_category,
            chapters=chapters,
            learning_objectives=objectives,
            prerequisites=prerequisites,
            repo_url=repo_url,
        )
        
        return plan.to_dict()
    
    def _generate_title(
        self, 
        repo_url: str, 
        category: str, 
        style: str
    ) -> str:
        """Generate a title for the story."""
        # Extract repo name from URL
        repo_name = repo_url.rstrip("/").split("/")[-1].replace("-", " ").title()
        
        style_prefixes = {
            "fiction": "The Tale of",
            "documentary": "Inside",
            "tutorial": "Learning",
            "podcast": "Discussing",
            "technical": "Deep Dive:",
        }
        
        category_suffixes = {
            "onboarding": "",
            "architecture": "Architecture",
            "feature": "Features",
            "debugging": "Under the Hood",
            "review": "Code Review",
            "documentation": "Explained",
        }
        
        prefix = style_prefixes.get(style, "Exploring")
        suffix = category_suffixes.get(category, "")
        
        if suffix:
            return f"{prefix} {repo_name}: {suffix}"
        return f"{prefix} {repo_name}"
    
    def _create_chapter_outlines(
        self,
        intent_category: str,
        expertise_level: str,
        focus_areas: list[str],
        target_duration: int,
        narrative_style: str,
    ) -> list[ChapterOutline]:
        """Create chapter outlines based on intent."""
        chapters = []
        
        # Chapter templates by category
        templates = {
            "onboarding": [
                ("Introduction", "Overview and purpose of the project"),
                ("Getting Started", "Setup and basic usage"),
                ("Core Concepts", "Key abstractions and patterns"),
                ("Project Structure", "How the codebase is organized"),
                ("Next Steps", "Where to explore next"),
            ],
            "architecture": [
                ("System Overview", "High-level architecture"),
                ("Components", "Major system components"),
                ("Data Flow", "How data moves through the system"),
                ("Design Decisions", "Key architectural choices"),
                ("Trade-offs", "Limitations and alternatives"),
            ],
            "feature": [
                ("Feature Overview", "What the feature does"),
                ("Implementation", "How it's built"),
                ("Integration", "How it fits with the rest"),
                ("Testing", "How it's tested"),
            ],
            "debugging": [
                ("Problem Space", "Understanding the issue domain"),
                ("Code Flow", "Tracing execution paths"),
                ("Key Functions", "Critical code to understand"),
                ("Common Issues", "Typical problems and solutions"),
            ],
            "review": [
                ("Codebase Overview", "What you're reviewing"),
                ("Code Quality", "Style and patterns used"),
                ("Key Changes", "Important areas to focus on"),
                ("Review Checklist", "What to look for"),
            ],
            "documentation": [
                ("Project Purpose", "What and why"),
                ("Architecture", "How it's built"),
                ("Usage Guide", "How to use it"),
                ("API Reference", "Key interfaces"),
            ],
        }
        
        # Get base chapters for category
        base_chapters = templates.get(intent_category, templates["onboarding"])
        
        # Calculate time per chapter
        base_time = target_duration / len(base_chapters)
        
        # Adjust for expertise (experts get faster pace)
        time_multiplier = {"beginner": 1.2, "intermediate": 1.0, "expert": 0.8}
        adjusted_time = base_time * time_multiplier.get(expertise_level, 1.0)
        
        # Create base chapters
        for i, (title, focus) in enumerate(base_chapters, 1):
            chapters.append(ChapterOutline(
                number=i,
                title=title,
                focus=focus,
                duration_minutes=round(adjusted_time, 1),
                key_concepts=[],
                code_elements=[],
            ))
        
        # Add focus area chapters if specified
        for i, area in enumerate(focus_areas[:3], len(chapters) + 1):
            chapters.append(ChapterOutline(
                number=i,
                title=f"Deep Dive: {area}",
                focus=f"Detailed exploration of {area}",
                duration_minutes=round(adjusted_time * 0.8, 1),
                key_concepts=[area],
                code_elements=[],
            ))
        
        return chapters
    
    def _generate_objectives(
        self,
        category: str,
        focus_areas: list[str],
        learning_goals: str,
    ) -> list[str]:
        """Generate learning objectives."""
        objectives = []
        
        # Category-based objectives
        category_objectives = {
            "onboarding": [
                "Understand the project's purpose and goals",
                "Navigate the codebase structure confidently",
                "Identify key entry points and components",
            ],
            "architecture": [
                "Explain the system architecture",
                "Understand component interactions",
                "Identify design patterns used",
            ],
            "feature": [
                "Understand how the feature works",
                "Trace the implementation details",
                "Know how to extend or modify it",
            ],
            "debugging": [
                "Trace code execution flow",
                "Identify potential problem areas",
                "Understand error handling patterns",
            ],
            "review": [
                "Evaluate code quality and patterns",
                "Identify areas needing attention",
                "Provide constructive feedback",
            ],
            "documentation": [
                "Explain the project clearly",
                "Document key interfaces",
                "Guide new users effectively",
            ],
        }
        
        objectives.extend(category_objectives.get(category, [])[:2])
        
        # Add focus area objectives
        for area in focus_areas[:2]:
            objectives.append(f"Understand the {area} component in detail")
        
        return objectives
    
    def _determine_prerequisites(self, expertise: str, category: str) -> list[str]:
        """Determine prerequisites based on expertise and category."""
        base_prereqs = {
            "beginner": [
                "Basic programming concepts",
                "Familiarity with code editors",
            ],
            "intermediate": [
                "Comfortable reading code",
                "Basic understanding of the language/framework",
            ],
            "expert": [],  # Experts need no prerequisites listed
        }
        
        return base_prereqs.get(expertise, [])
    
    def _generate_description(self, category: str, focus_areas: list[str]) -> str:
        """Generate story description."""
        descriptions = {
            "onboarding": "A guided tour of the codebase for newcomers.",
            "architecture": "An exploration of the system's design and structure.",
            "feature": "A deep dive into specific functionality.",
            "debugging": "Understanding code flow for troubleshooting.",
            "review": "Preparation for code review and contribution.",
            "documentation": "Learning to explain and document the project.",
        }
        
        base = descriptions.get(category, "An exploration of the codebase.")
        
        if focus_areas:
            focus_str = ", ".join(focus_areas[:3])
            base += f" Focusing on: {focus_str}."
        
        return base
    ```
    
    Avoid: Do NOT hardcode repo-specific information, do NOT skip chapter timing calculation.
  </action>
  <verify>generate_story_plan tool creates valid StoryPlan output</verify>
  <done>generate_story_plan skill with chapter outlines and timing</done>
</task>

<task type="auto">
  <n>Task 3: Update exports</n>
  <files>src/codestory/skills/__init__.py</files>
  <action>
    Add new data classes to exports:
    
    ```python
    # Update src/codestory/skills/__init__.py
    
    from .intent import IntentSkills, UserIntent, ChapterOutline, StoryPlan
    
    # Add to __all__:
    "ChapterOutline",
    "StoryPlan",
    ```
    
    Avoid: Do NOT forget to export new data classes.
  </action>
  <verify>All data classes importable from codestory.skills</verify>
  <done>Updated exports with StoryPlan and ChapterOutline</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] generate_story_plan tool registered on IntentSkills
- [ ] StoryPlan contains valid chapter outlines
- [ ] Timing calculations work correctly
- [ ] Learning objectives and prerequisites generated
- [ ] All data classes export correctly
</verification>

<success_criteria>
- generate_story_plan produces structured output
- Chapter outlines include timing and focus
- Plan adapts to expertise level
- Ready for Story Architect consumption
</success_criteria>

<o>
After completion, create `plans/02-intent-agent/02-03-SUMMARY.md`
</o>
