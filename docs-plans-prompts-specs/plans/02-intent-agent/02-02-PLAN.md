---
phase: 02-intent-agent
type: execute
domain: python-agent-sdk
---

<objective>
Create the intent analysis skill that categorizes user goals and expertise level.

Purpose: Provide the Intent Agent with a tool to analyze and categorize user responses into structured intent data.
Output: IntentSkills class with analyze_user_intent tool.
</objective>


<context>
@BRIEF.md
@ROADMAP.md
@plans/02-intent-agent/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <n>Task 1: Create IntentSkills class with analyze_user_intent</n>
  <files>src/codestory/skills/intent.py</files>
  <action>
    Create the intent analysis skill module:
    
    ```python
    # src/codestory/skills/intent.py
    """Intent analysis skills for the Intent Agent."""
    
    from dataclasses import dataclass, field
    from typing import Literal
    
    from ..agents.base import Skill, skill
    from .utils import handle_skill_errors, ValidationError
    
    
    # Type definitions
    IntentCategory = Literal[
        "onboarding", "architecture", "feature", 
        "debugging", "review", "documentation"
    ]
    ExpertiseLevel = Literal["beginner", "intermediate", "expert"]
    NarrativeStyle = Literal["fiction", "documentary", "tutorial", "podcast", "technical"]
    
    
    @dataclass
    class UserIntent:
        """Structured representation of user intent."""
        category: IntentCategory
        expertise_level: ExpertiseLevel
        focus_areas: list[str] = field(default_factory=list)
        learning_goals: str = ""
        preferred_style: NarrativeStyle = "documentary"
        time_preference_minutes: int = 10
        specific_questions: list[str] = field(default_factory=list)
        
        def to_dict(self) -> dict:
            """Convert to dictionary."""
            return {
                "category": self.category,
                "expertise_level": self.expertise_level,
                "focus_areas": self.focus_areas,
                "learning_goals": self.learning_goals,
                "preferred_style": self.preferred_style,
                "time_preference_minutes": self.time_preference_minutes,
                "specific_questions": self.specific_questions,
            }
    
    
    class IntentSkills(Skill):
        """Skills for analyzing and structuring user intent.
        
        The Intent Agent uses these skills to:
        - Categorize what the user wants to learn
        - Determine their expertise level
        - Identify specific focus areas
        - Generate structured intent data
        """
        
        @skill(
            description="Analyze conversation to categorize user's intent and expertise level"
        )
        @handle_skill_errors
        async def analyze_user_intent(
            self,
            conversation_summary: str,
            stated_goal: str,
            technical_background: str,
            specific_interests: str,
        ) -> dict:
            """Analyze user responses to determine intent category and expertise.
            
            Args:
                conversation_summary: Summary of the conversation so far
                stated_goal: User's explicitly stated goal
                technical_background: Description of user's technical background
                specific_interests: Specific areas or features user mentioned
            
            Returns:
                Structured intent analysis with category, level, and recommendations
            """
            # Analyze stated goal to determine category
            category = self._categorize_goal(stated_goal, conversation_summary)
            
            # Determine expertise level from background
            expertise = self._assess_expertise(technical_background)
            
            # Extract focus areas from interests
            focus_areas = self._extract_focus_areas(specific_interests)
            
            # Recommend narrative style based on intent and expertise
            recommended_style = self._recommend_style(category, expertise)
            
            # Estimate appropriate duration
            duration = self._estimate_duration(category, len(focus_areas))
            
            return {
                "category": category,
                "expertise_level": expertise,
                "focus_areas": focus_areas,
                "recommended_style": recommended_style,
                "recommended_duration_minutes": duration,
                "confidence": self._calculate_confidence(
                    stated_goal, technical_background, specific_interests
                ),
                "needs_clarification": self._needs_clarification(
                    stated_goal, technical_background
                ),
            }
        
        def _categorize_goal(self, stated_goal: str, summary: str) -> IntentCategory:
            """Categorize the user's learning goal."""
            goal_lower = (stated_goal + " " + summary).lower()
            
            # Keyword matching for categories
            if any(kw in goal_lower for kw in ["new to", "first time", "getting started", "onboard"]):
                return "onboarding"
            elif any(kw in goal_lower for kw in ["architecture", "design", "structure", "how it works"]):
                return "architecture"
            elif any(kw in goal_lower for kw in ["feature", "specific", "implement", "this part"]):
                return "feature"
            elif any(kw in goal_lower for kw in ["debug", "bug", "issue", "problem", "fix"]):
                return "debugging"
            elif any(kw in goal_lower for kw in ["review", "contribute", "pr", "pull request"]):
                return "review"
            elif any(kw in goal_lower for kw in ["document", "explain", "write about"]):
                return "documentation"
            
            # Default to onboarding for general exploration
            return "onboarding"
        
        def _assess_expertise(self, background: str) -> ExpertiseLevel:
            """Assess user's expertise level from their background."""
            background_lower = background.lower()
            
            # Expert indicators
            if any(kw in background_lower for kw in [
                "senior", "lead", "architect", "years of experience",
                "expert", "advanced", "professional"
            ]):
                return "expert"
            
            # Beginner indicators
            elif any(kw in background_lower for kw in [
                "learning", "student", "new to", "beginner",
                "first time", "just started", "bootcamp"
            ]):
                return "beginner"
            
            # Default to intermediate
            return "intermediate"
        
        def _extract_focus_areas(self, interests: str) -> list[str]:
            """Extract specific focus areas from user interests."""
            if not interests.strip():
                return []
            
            # Simple extraction - split by common delimiters
            areas = []
            for delimiter in [",", ";", "and", "\n"]:
                if delimiter in interests:
                    areas = [a.strip() for a in interests.split(delimiter) if a.strip()]
                    break
            
            if not areas:
                # Single item or sentence - use as-is
                areas = [interests.strip()]
            
            return areas[:5]  # Limit to 5 focus areas
        
        def _recommend_style(
            self, 
            category: IntentCategory, 
            expertise: ExpertiseLevel
        ) -> NarrativeStyle:
            """Recommend narrative style based on intent and expertise."""
            # Style mapping based on category and expertise
            style_map = {
                ("onboarding", "beginner"): "fiction",
                ("onboarding", "intermediate"): "documentary",
                ("onboarding", "expert"): "podcast",
                ("architecture", "beginner"): "tutorial",
                ("architecture", "intermediate"): "documentary",
                ("architecture", "expert"): "technical",
                ("feature", "beginner"): "tutorial",
                ("feature", "intermediate"): "documentary",
                ("feature", "expert"): "technical",
                ("debugging", "beginner"): "tutorial",
                ("debugging", "intermediate"): "podcast",
                ("debugging", "expert"): "technical",
                ("review", "beginner"): "documentary",
                ("review", "intermediate"): "podcast",
                ("review", "expert"): "technical",
                ("documentation", "beginner"): "documentary",
                ("documentation", "intermediate"): "documentary",
                ("documentation", "expert"): "technical",
            }
            
            return style_map.get((category, expertise), "documentary")
        
        def _estimate_duration(self, category: IntentCategory, num_focus_areas: int) -> int:
            """Estimate appropriate story duration in minutes."""
            # Base duration by category
            base_durations = {
                "onboarding": 15,
                "architecture": 20,
                "feature": 10,
                "debugging": 8,
                "review": 12,
                "documentation": 15,
            }
            
            base = base_durations.get(category, 10)
            
            # Add time for focus areas
            area_time = min(num_focus_areas * 3, 15)
            
            return min(base + area_time, 30)  # Cap at 30 minutes
        
        def _calculate_confidence(
            self,
            stated_goal: str,
            background: str,
            interests: str,
        ) -> float:
            """Calculate confidence in the analysis (0-1)."""
            confidence = 0.5  # Base confidence
            
            # More information = higher confidence
            if len(stated_goal) > 20:
                confidence += 0.15
            if len(background) > 20:
                confidence += 0.15
            if len(interests) > 10:
                confidence += 0.1
            if len(stated_goal) > 50:
                confidence += 0.1
            
            return min(confidence, 1.0)
        
        def _needs_clarification(self, stated_goal: str, background: str) -> list[str]:
            """Determine what additional information would help."""
            needs = []
            
            if len(stated_goal) < 10:
                needs.append("More detail about learning goals")
            if len(background) < 5:
                needs.append("Technical background or experience level")
            
            return needs
    ```
    
    Avoid: Do NOT use LLM calls within the skill (analysis is rule-based), do NOT skip validation.
  </action>
  <verify>IntentSkills class imports, analyze_user_intent tool registered</verify>
  <done>IntentSkills class with analyze_user_intent for categorizing user goals</done>
</task>

<task type="auto">
  <n>Task 2: Update skills module exports</n>
  <files>src/codestory/skills/__init__.py</files>
  <action>
    Add IntentSkills to module exports:
    
    ```python
    # src/codestory/skills/__init__.py
    """Skill library for Code Story agents."""
    
    from .utils import (
        SkillError,
        RateLimitError,
        APIError,
        ValidationError,
        HTTPClient,
        parse_github_url,
        truncate_text,
        safe_json_parse,
        format_timestamp,
        estimate_tokens,
        chunk_text,
        handle_skill_errors,
    )
    
    from .github import GitHubSkills
    from .analysis import AnalysisSkills
    from .narrative import NarrativeSkills
    from .voice import VoiceSkills
    from .intent import IntentSkills, UserIntent
    
    
    __all__ = [
        # Utilities
        "SkillError",
        "RateLimitError",
        "APIError",
        "ValidationError",
        "HTTPClient",
        "parse_github_url",
        "truncate_text",
        "safe_json_parse",
        "format_timestamp",
        "estimate_tokens",
        "chunk_text",
        "handle_skill_errors",
        # Skill classes
        "GitHubSkills",
        "AnalysisSkills",
        "NarrativeSkills",
        "VoiceSkills",
        "IntentSkills",
        # Data classes
        "UserIntent",
    ]
    ```
    
    Avoid: Do NOT forget UserIntent dataclass export.
  </action>
  <verify>All exports working including IntentSkills</verify>
  <done>Updated skills module exports with IntentSkills</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `uv run python -c "from codestory.skills import IntentSkills"` succeeds
- [ ] analyze_user_intent tool is registered on the skill
- [ ] Category, expertise, and style determination logic works
- [ ] UserIntent dataclass properly structured
</verification>

<success_criteria>
- IntentSkills class with analyze_user_intent tool
- Rule-based analysis without LLM calls
- Proper confidence scoring
- Recommendations for narrative style and duration
</success_criteria>

<o>
After completion, create `plans/02-intent-agent/02-02-SUMMARY.md`
</o>
