---
phase: 02-intent-agent
type: execute
domain: python-agent-sdk
---

<objective>
Create the Intent Agent with its system prompt and Opus 4.5 configuration.

Purpose: The Intent Agent is the first agent in the pipeline - it conducts onboarding conversations to understand the user's learning goals for the repository.
Output: Working Intent Agent class with system prompt optimized for intent understanding.
</objective>


<context>
@BRIEF.md
@ROADMAP.md
@plans/01-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <n>Task 1: Create Intent Agent system prompt</n>
  <files>src/codestory/agents/prompts/intent.py</files>
  <action>
    Create the system prompt module for the Intent Agent:
    
    ```python
    # src/codestory/agents/prompts/__init__.py
    """System prompts for Code Story agents."""
    
    # src/codestory/agents/prompts/intent.py
    """System prompt for the Intent Agent."""
    
    INTENT_AGENT_SYSTEM_PROMPT = """You are the Intent Agent for Code Story, an AI that helps users understand codebases through audio narratives.

    Your role is to conduct a friendly, conversational onboarding to understand:
    1. What the user wants to learn about the repository
    2. Their technical background and expertise level
    3. Specific components or features they're interested in
    4. How they prefer to learn (high-level overview vs. deep dive)

    ## Conversation Guidelines

    Start by warmly greeting the user and asking about their primary goal. Guide the conversation naturally, asking follow-up questions to understand:

    - **Intent Category**: Are they onboarding to a new codebase, trying to understand the architecture, diving deep into a specific feature, or debugging an issue?
    
    - **Expertise Level**: Are they a beginner programmer, intermediate developer familiar with the language/framework, or an expert looking for specific details?
    
    - **Focus Areas**: Which parts of the codebase interest them most? Are there specific files, modules, or concepts they want to understand?
    
    - **Learning Goals**: What do they hope to accomplish after listening to the story? Ship a feature? Review code? Understand design decisions?

    ## Response Style

    - Be conversational and friendly, not robotic
    - Ask one or two questions at a time, not a long list
    - Acknowledge what the user shares before asking more
    - Use their responses to tailor follow-up questions
    - When you have enough information, summarize your understanding and confirm

    ## Output Format

    When you have gathered sufficient information, use the `generate_story_plan` tool to create a structured plan. The plan should include:

    - Intent category and expertise level
    - Ordered list of focus areas
    - Recommended narrative style (fiction, documentary, tutorial, podcast, technical)
    - Chapter outline with timing estimates
    - Key concepts to explain

    ## Example Interaction Flow

    1. Greet user and ask primary goal
    2. Understand their background with the codebase
    3. Learn about their technical expertise
    4. Identify specific interests or concerns
    5. Confirm understanding and generate plan

    Remember: Your goal is to create a personalized learning experience. The better you understand the user's needs, the more valuable the resulting audio narrative will be."""
    
    
    INTENT_CATEGORIES = [
        "onboarding",      # New to the codebase, want general overview
        "architecture",    # Understanding system design and patterns
        "feature",         # Deep dive into specific functionality
        "debugging",       # Understanding code flow for troubleshooting
        "review",          # Preparing to review or contribute code
        "documentation",   # Creating or improving documentation
    ]
    
    EXPERTISE_LEVELS = [
        "beginner",        # New to programming or the language
        "intermediate",    # Comfortable with language, learning frameworks
        "expert",          # Deep experience, wants specifics
    ]
    
    NARRATIVE_STYLES = [
        "fiction",         # Story-driven with characters and plot
        "documentary",     # Informative, like a documentary film
        "tutorial",        # Step-by-step instructional
        "podcast",         # Conversational, discussion-style
        "technical",       # Precise, reference-style
    ]
    ```
    
    Create the prompts directory structure:
    ```bash
    mkdir -p src/codestory/agents/prompts
    touch src/codestory/agents/prompts/__init__.py
    ```
    
    Avoid: Do NOT use aggressive language like CRITICAL/MUST, do NOT create overly long prompts.
  </action>
  <verify>Prompt module imports correctly, constants defined</verify>
  <done>Intent Agent system prompt with conversation guidelines and output format</done>
</task>

<task type="auto">
  <n>Task 2: Implement Intent Agent class</n>
  <files>src/codestory/agents/intent.py</files>
  <action>
    Create the Intent Agent implementation:
    
    ```python
    # src/codestory/agents/intent.py
    """Intent Agent for understanding user learning goals."""
    
    from anthropic import Anthropic
    
    from .base import Agent, AgentConfig, AgentResponse
    from .prompts.intent import (
        INTENT_AGENT_SYSTEM_PROMPT,
        INTENT_CATEGORIES,
        EXPERTISE_LEVELS,
        NARRATIVE_STYLES,
    )
    from ..skills.intent import IntentSkills
    from ..core.config import get_settings
    
    
    class IntentAgent(Agent):
        """Agent for conducting onboarding conversations.
        
        The Intent Agent is the first agent in the Code Story pipeline.
        It conducts a conversational onboarding to understand:
        - What the user wants to learn
        - Their technical background
        - Specific areas of interest
        - Preferred learning style
        
        Output: A structured story plan used by subsequent agents.
        """
        
        def __init__(self, client: Anthropic | None = None):
            """Initialize the Intent Agent.
            
            Args:
                client: Optional Anthropic client (creates one if not provided)
            """
            settings = get_settings()
            
            config = AgentConfig(
                name="Intent Agent",
                description="Understands user learning goals through conversation",
                system_prompt=INTENT_AGENT_SYSTEM_PROMPT,
                model=settings.claude_model,
                max_tokens=settings.claude_max_tokens,
                temperature=0.7,  # Slightly creative for natural conversation
                effort=settings.claude_effort,
            )
            
            # Initialize with intent-specific skills
            skills = [IntentSkills()]
            
            super().__init__(config=config, skills=skills, client=client)
            
            # Track conversation state
            self.intent_gathered = False
            self.current_intent: dict | None = None
        
        async def start_conversation(self, repo_url: str) -> AgentResponse:
            """Start a new onboarding conversation.
            
            Args:
                repo_url: GitHub repository URL to discuss
            
            Returns:
                Agent's opening message
            """
            self.clear_conversation()
            self.intent_gathered = False
            self.current_intent = None
            
            opening_message = f"""I'd like to create an audio story about this repository: {repo_url}

            Please help me understand your goals so I can tailor the story to your needs."""
            
            return await self.run(opening_message)
        
        async def continue_conversation(self, user_message: str) -> AgentResponse:
            """Continue the onboarding conversation.
            
            Args:
                user_message: User's response in the conversation
            
            Returns:
                Agent's next message
            """
            response = await self.run(user_message)
            
            # Check if a story plan was generated
            for tool_call in response.tool_calls:
                if tool_call.get("name") == "generate_story_plan":
                    self.intent_gathered = True
                    # The plan will be in the tool result
            
            return response
        
        def is_complete(self) -> bool:
            """Check if onboarding is complete.
            
            Returns:
                True if intent has been gathered and plan generated
            """
            return self.intent_gathered
        
        def get_story_plan(self) -> dict | None:
            """Get the generated story plan.
            
            Returns:
                Story plan dict if generated, None otherwise
            """
            return self.current_intent
        
        @staticmethod
        def get_intent_categories() -> list[str]:
            """Get available intent categories."""
            return INTENT_CATEGORIES.copy()
        
        @staticmethod
        def get_expertise_levels() -> list[str]:
            """Get available expertise levels."""
            return EXPERTISE_LEVELS.copy()
        
        @staticmethod
        def get_narrative_styles() -> list[str]:
            """Get available narrative styles."""
            return NARRATIVE_STYLES.copy()
    ```
    
    Avoid: Do NOT skip conversation state tracking, do NOT hardcode model configuration.
  </action>
  <verify>IntentAgent class instantiates, inherits from Agent properly</verify>
  <done>Intent Agent class with conversation management and Opus 4.5 configuration</done>
</task>

<task type="auto">
  <n>Task 3: Update agents module exports</n>
  <files>src/codestory/agents/__init__.py, src/codestory/agents/prompts/__init__.py</files>
  <action>
    Update module exports to include Intent Agent:
    
    ```python
    # src/codestory/agents/__init__.py
    """Agent framework for Code Story."""
    from .base import (
        Skill,
        skill,
        ToolDefinition,
        ToolResult,
        Agent,
        AgentConfig,
        AgentMessage,
        AgentResponse,
        Orchestrator,
        PipelineStage,
        PipelineState,
    )
    from .intent import IntentAgent
    
    __all__ = [
        # Base classes
        "Skill",
        "skill",
        "ToolDefinition",
        "ToolResult",
        "Agent",
        "AgentConfig",
        "AgentMessage",
        "AgentResponse",
        "Orchestrator",
        "PipelineStage",
        "PipelineState",
        # Agents
        "IntentAgent",
    ]
    ```
    
    ```python
    # src/codestory/agents/prompts/__init__.py
    """System prompts for Code Story agents."""
    from .intent import (
        INTENT_AGENT_SYSTEM_PROMPT,
        INTENT_CATEGORIES,
        EXPERTISE_LEVELS,
        NARRATIVE_STYLES,
    )
    
    __all__ = [
        "INTENT_AGENT_SYSTEM_PROMPT",
        "INTENT_CATEGORIES",
        "EXPERTISE_LEVELS",
        "NARRATIVE_STYLES",
    ]
    ```
    
    Avoid: Do NOT forget to add new exports as agents are created.
  </action>
  <verify>All exports working, IntentAgent importable from codestory.agents</verify>
  <done>Updated module exports for Intent Agent and prompts</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `uv run python -c "from codestory.agents import IntentAgent"` succeeds
- [ ] IntentAgent uses Opus 4.5 configuration from settings
- [ ] System prompt follows best practices (no CRITICAL/MUST)
- [ ] Conversation state tracking works
- [ ] Constants for categories, levels, styles are accessible
</verification>

<success_criteria>
- Intent Agent class created with proper inheritance
- System prompt guides conversational onboarding
- Opus 4.5 configuration with effort="high"
- Ready for skill integration
</success_criteria>

<o>
After completion, create `plans/02-intent-agent/02-01-SUMMARY.md`
</o>
