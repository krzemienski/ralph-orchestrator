# Plan 11-04: API Key Administration and Audit Logs

## Overview
Implement admin capabilities for API key oversight including viewing all keys across users, forced revocation, usage monitoring, and comprehensive audit logging of all admin and system actions for security compliance.

## Dependencies
- Plan 11-01: Admin authentication
- Plan 10-01: API key management
- Plan 11-03: Analytics infrastructure

## Implementation

### 1. Audit Log Model

**models/audit_log.py:**
```python
"""Audit logging models."""
from datetime import datetime
from sqlalchemy import Column, String, DateTime, JSON, ForeignKey, Text, Index
from sqlalchemy.orm import relationship

from database import Base


class AuditLog(Base):
    """Comprehensive audit log for admin and system actions."""
    __tablename__ = "audit_logs"
    
    id = Column(String(36), primary_key=True)
    
    # Actor - who performed the action
    actor_type = Column(String(20), nullable=False)  # admin, system, user
    actor_id = Column(String(36), nullable=True)  # admin_id, user_id, or null for system
    actor_email = Column(String(255), nullable=True)  # Denormalized for display
    
    # Action details
    action = Column(String(100), nullable=False, index=True)
    category = Column(String(50), nullable=False, index=True)  # auth, user, api_key, story, system
    
    # Target - what was affected
    target_type = Column(String(50), nullable=True)  # user, api_key, story, etc.
    target_id = Column(String(36), nullable=True)
    target_description = Column(String(255), nullable=True)  # Human-readable target info
    
    # Context
    details = Column(JSON, nullable=True)  # Action-specific details
    changes = Column(JSON, nullable=True)  # Before/after for modifications
    
    # Request metadata
    ip_address = Column(String(45), nullable=True)
    user_agent = Column(String(500), nullable=True)
    request_id = Column(String(36), nullable=True)
    
    # Status
    status = Column(String(20), default="success")  # success, failure, warning
    error_message = Column(Text, nullable=True)
    
    # Timestamps
    created_at = Column(DateTime, default=datetime.utcnow, index=True)
    
    # Indexes for common queries
    __table_args__ = (
        Index('ix_audit_actor', 'actor_type', 'actor_id'),
        Index('ix_audit_target', 'target_type', 'target_id'),
        Index('ix_audit_date_category', 'created_at', 'category'),
    )


# Action constants for consistency
class AuditActions:
    """Standard audit action names."""
    # Authentication
    ADMIN_LOGIN = "admin_login"
    ADMIN_LOGIN_FAILED = "admin_login_failed"
    ADMIN_LOGOUT = "admin_logout"
    ADMIN_2FA_ENABLED = "admin_2fa_enabled"
    
    # User management
    USER_CREATED = "user_created"
    USER_UPDATED = "user_updated"
    USER_DELETED = "user_deleted"
    USER_SUSPENDED = "user_suspended"
    USER_UNSUSPENDED = "user_unsuspended"
    USER_QUOTA_UPDATED = "user_quota_updated"
    USER_IMPERSONATED = "user_impersonated"
    
    # API keys
    API_KEY_CREATED = "api_key_created"
    API_KEY_REVOKED = "api_key_revoked"
    API_KEY_ADMIN_REVOKED = "api_key_admin_revoked"
    
    # System
    SYSTEM_SETTING_CHANGED = "system_setting_changed"
    EXPORT_INITIATED = "export_initiated"
```

### 2. Audit Service

**services/audit_service.py:**
```python
"""Audit logging service."""
import uuid
from datetime import datetime, timedelta
from typing import Optional, Any
from sqlalchemy import and_, or_, func
from sqlalchemy.orm import Session
from fastapi import Request

from models.audit_log import AuditLog, AuditActions


class AuditService:
    """Service for audit logging and querying."""
    
    def __init__(self, db: Session):
        self.db = db
    
    def log(
        self,
        action: str,
        category: str,
        actor_type: str = "system",
        actor_id: Optional[str] = None,
        actor_email: Optional[str] = None,
        target_type: Optional[str] = None,
        target_id: Optional[str] = None,
        target_description: Optional[str] = None,
        details: Optional[dict] = None,
        changes: Optional[dict] = None,
        status: str = "success",
        error_message: Optional[str] = None,
        request: Optional[Request] = None
    ) -> AuditLog:
        """Create an audit log entry."""
        log = AuditLog(
            id=str(uuid.uuid4()),
            action=action,
            category=category,
            actor_type=actor_type,
            actor_id=actor_id,
            actor_email=actor_email,
            target_type=target_type,
            target_id=target_id,
            target_description=target_description,
            details=details,
            changes=changes,
            status=status,
            error_message=error_message,
        )
        
        # Extract request metadata
        if request:
            log.ip_address = request.client.host if request.client else None
            log.user_agent = request.headers.get("user-agent")
            log.request_id = request.headers.get("x-request-id")
        
        self.db.add(log)
        self.db.commit()
        
        return log
    
    def log_admin_action(
        self,
        admin: Any,  # AdminUser
        action: str,
        category: str,
        target_type: Optional[str] = None,
        target_id: Optional[str] = None,
        details: Optional[dict] = None,
        request: Optional[Request] = None
    ) -> AuditLog:
        """Convenience method for admin actions."""
        return self.log(
            action=action,
            category=category,
            actor_type="admin",
            actor_id=admin.id,
            actor_email=admin.user.email,
            target_type=target_type,
            target_id=target_id,
            details=details,
            request=request
        )
    
    def query_logs(
        self,
        category: Optional[str] = None,
        action: Optional[str] = None,
        actor_id: Optional[str] = None,
        target_type: Optional[str] = None,
        target_id: Optional[str] = None,
        start_date: Optional[datetime] = None,
        end_date: Optional[datetime] = None,
        status: Optional[str] = None,
        search: Optional[str] = None,
        page: int = 1,
        per_page: int = 50
    ) -> tuple[list[AuditLog], int]:
        """Query audit logs with filters."""
        query = self.db.query(AuditLog)
        
        if category:
            query = query.filter(AuditLog.category == category)
        if action:
            query = query.filter(AuditLog.action == action)
        if actor_id:
            query = query.filter(AuditLog.actor_id == actor_id)
        if target_type:
            query = query.filter(AuditLog.target_type == target_type)
        if target_id:
            query = query.filter(AuditLog.target_id == target_id)
        if start_date:
            query = query.filter(AuditLog.created_at >= start_date)
        if end_date:
            query = query.filter(AuditLog.created_at <= end_date)
        if status:
            query = query.filter(AuditLog.status == status)
        if search:
            search_term = f"%{search}%"
            query = query.filter(or_(
                AuditLog.actor_email.ilike(search_term),
                AuditLog.target_description.ilike(search_term),
                AuditLog.action.ilike(search_term)
            ))
        
        total = query.count()
        
        offset = (page - 1) * per_page
        logs = query.order_by(AuditLog.created_at.desc()).offset(offset).limit(per_page).all()
        
        return logs, total
    
    def get_activity_summary(
        self,
        start_date: datetime,
        end_date: datetime
    ) -> dict:
        """Get summary of activity for a time period."""
        logs = self.db.query(AuditLog).filter(
            AuditLog.created_at >= start_date,
            AuditLog.created_at <= end_date
        ).all()
        
        # Count by category
        by_category = {}
        by_action = {}
        by_status = {"success": 0, "failure": 0, "warning": 0}
        
        for log in logs:
            by_category[log.category] = by_category.get(log.category, 0) + 1
            by_action[log.action] = by_action.get(log.action, 0) + 1
            by_status[log.status] = by_status.get(log.status, 0) + 1
        
        return {
            "total_events": len(logs),
            "by_category": by_category,
            "by_action": by_action,
            "by_status": by_status,
        }
```

### 3. API Key Admin Service

**services/api_key_admin_service.py:**
```python
"""Admin API key management service."""
from datetime import datetime
from typing import Optional
from sqlalchemy import or_, func
from sqlalchemy.orm import Session

from models.api_key import APIKey
from models.user import User
from models.admin import AdminUser
from services.audit_service import AuditService, AuditActions


class APIKeyAdminService:
    """Admin service for API key management across all users."""
    
    def __init__(self, db: Session, admin: AdminUser):
        self.db = db
        self.admin = admin
        self.audit = AuditService(db)
    
    def list_all_keys(
        self,
        search: Optional[str] = None,
        user_id: Optional[str] = None,
        is_active: Optional[bool] = None,
        page: int = 1,
        per_page: int = 20
    ) -> tuple[list[dict], int]:
        """List all API keys across all users."""
        query = self.db.query(APIKey, User).join(User, APIKey.user_id == User.id)
        
        if search:
            search_term = f"%{search}%"
            query = query.filter(or_(
                APIKey.name.ilike(search_term),
                APIKey.key_prefix.ilike(search_term),
                User.email.ilike(search_term)
            ))
        
        if user_id:
            query = query.filter(APIKey.user_id == user_id)
        
        if is_active is not None:
            if is_active:
                query = query.filter(
                    APIKey.is_active == True,
                    APIKey.revoked_at.is_(None)
                )
            else:
                query = query.filter(or_(
                    APIKey.is_active == False,
                    APIKey.revoked_at.isnot(None)
                ))
        
        total = query.count()
        
        offset = (page - 1) * per_page
        results = query.order_by(APIKey.created_at.desc()).offset(offset).limit(per_page).all()
        
        return [
            {
                "id": key.id,
                "name": key.name,
                "key_prefix": key.key_prefix,
                "scopes": key.scopes.split(","),
                "user_id": key.user_id,
                "user_email": user.email,
                "created_at": key.created_at,
                "expires_at": key.expires_at,
                "last_used_at": key.last_used_at,
                "request_count": key.request_count,
                "is_active": key.is_active and key.revoked_at is None,
                "revoked_at": key.revoked_at,
            }
            for key, user in results
        ], total
    
    def get_key_details(self, key_id: str) -> Optional[dict]:
        """Get detailed info about an API key."""
        result = self.db.query(APIKey, User).join(
            User, APIKey.user_id == User.id
        ).filter(APIKey.id == key_id).first()
        
        if not result:
            return None
        
        key, user = result
        
        # Get usage stats
        from models.analytics import APICallLog
        recent_calls = self.db.query(APICallLog).filter(
            APICallLog.user_id == key.user_id,
            APICallLog.created_at >= datetime.utcnow() - timedelta(days=7)
        ).count()
        
        return {
            "key": {
                "id": key.id,
                "name": key.name,
                "description": key.description,
                "key_prefix": key.key_prefix,
                "scopes": key.scopes.split(","),
                "created_at": key.created_at,
                "expires_at": key.expires_at,
                "last_used_at": key.last_used_at,
                "request_count": key.request_count,
                "is_active": key.is_active,
                "revoked_at": key.revoked_at,
            },
            "user": {
                "id": user.id,
                "email": user.email,
                "name": user.name,
                "plan": user.plan,
            },
            "stats": {
                "requests_last_7_days": recent_calls,
            }
        }
    
    def admin_revoke_key(self, key_id: str, reason: str) -> bool:
        """Admin force-revoke an API key."""
        key = self.db.query(APIKey).filter(APIKey.id == key_id).first()
        
        if not key:
            return False
        
        key.revoked_at = datetime.utcnow()
        key.is_active = False
        
        # Log the action
        self.audit.log_admin_action(
            admin=self.admin,
            action=AuditActions.API_KEY_ADMIN_REVOKED,
            category="api_key",
            target_type="api_key",
            target_id=key_id,
            details={
                "reason": reason,
                "user_id": key.user_id,
                "key_prefix": key.key_prefix,
            }
        )
        
        self.db.commit()
        return True
    
    def get_key_usage_stats(self) -> dict:
        """Get platform-wide API key statistics."""
        total_keys = self.db.query(func.count(APIKey.id)).scalar()
        active_keys = self.db.query(func.count(APIKey.id)).filter(
            APIKey.is_active == True,
            APIKey.revoked_at.is_(None)
        ).scalar()
        
        # Keys by scope
        all_keys = self.db.query(APIKey.scopes).all()
        scope_counts = {}
        for (scopes,) in all_keys:
            for scope in scopes.split(","):
                scope_counts[scope] = scope_counts.get(scope, 0) + 1
        
        # Recently active (used in last 7 days)
        week_ago = datetime.utcnow() - timedelta(days=7)
        recently_active = self.db.query(func.count(APIKey.id)).filter(
            APIKey.last_used_at >= week_ago
        ).scalar()
        
        return {
            "total_keys": total_keys,
            "active_keys": active_keys,
            "revoked_keys": total_keys - active_keys,
            "recently_active": recently_active,
            "by_scope": scope_counts,
        }
```

### 4. Admin API Key Router

**routers/admin_api_keys.py:**
```python
"""Admin API key management endpoints."""
from fastapi import APIRouter, Depends, HTTPException, status, Query
from sqlalchemy.orm import Session
from typing import Optional

from database import get_db
from models.admin import AdminUser, Permission
from schemas.admin import APIKeyListResponse, APIKeyDetailResponse, RevokeRequest
from services.api_key_admin_service import APIKeyAdminService
from auth.admin_auth import require_permission

router = APIRouter(prefix="/admin/api-keys", tags=["admin-api-keys"])


@router.get("", response_model=APIKeyListResponse)
async def list_api_keys(
    search: Optional[str] = None,
    user_id: Optional[str] = None,
    is_active: Optional[bool] = None,
    page: int = Query(1, ge=1),
    per_page: int = Query(20, ge=1, le=100),
    admin: AdminUser = Depends(require_permission(Permission.VIEW_API_KEYS)),
    db: Session = Depends(get_db)
):
    """List all API keys across users."""
    service = APIKeyAdminService(db, admin)
    keys, total = service.list_all_keys(search, user_id, is_active, page, per_page)
    
    return APIKeyListResponse(
        keys=keys,
        total=total,
        page=page,
        per_page=per_page,
        pages=(total + per_page - 1) // per_page
    )


@router.get("/stats")
async def get_api_key_stats(
    admin: AdminUser = Depends(require_permission(Permission.VIEW_API_KEYS)),
    db: Session = Depends(get_db)
):
    """Get API key statistics."""
    service = APIKeyAdminService(db, admin)
    return service.get_key_usage_stats()


@router.get("/{key_id}", response_model=APIKeyDetailResponse)
async def get_api_key(
    key_id: str,
    admin: AdminUser = Depends(require_permission(Permission.VIEW_API_KEYS)),
    db: Session = Depends(get_db)
):
    """Get detailed API key info."""
    service = APIKeyAdminService(db, admin)
    details = service.get_key_details(key_id)
    
    if not details:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="API key not found"
        )
    
    return APIKeyDetailResponse(**details)


@router.post("/{key_id}/revoke")
async def revoke_api_key(
    key_id: str,
    request: RevokeRequest,
    admin: AdminUser = Depends(require_permission(Permission.REVOKE_API_KEYS)),
    db: Session = Depends(get_db)
):
    """Admin force-revoke an API key."""
    service = APIKeyAdminService(db, admin)
    
    if not service.admin_revoke_key(key_id, request.reason):
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="API key not found"
        )
    
    return {"message": "API key revoked", "key_id": key_id}
```

### 5. Audit Log Router

**routers/admin_audit.py:**
```python
"""Admin audit log endpoints."""
from datetime import datetime, timedelta
from fastapi import APIRouter, Depends, Query
from sqlalchemy.orm import Session
from typing import Optional

from database import get_db
from models.admin import AdminUser, Permission
from services.audit_service import AuditService
from auth.admin_auth import require_permission

router = APIRouter(prefix="/admin/audit", tags=["admin-audit"])


@router.get("/logs")
async def get_audit_logs(
    category: Optional[str] = None,
    action: Optional[str] = None,
    actor_id: Optional[str] = None,
    target_type: Optional[str] = None,
    target_id: Optional[str] = None,
    start_date: Optional[datetime] = None,
    end_date: Optional[datetime] = None,
    status: Optional[str] = None,
    search: Optional[str] = None,
    page: int = Query(1, ge=1),
    per_page: int = Query(50, ge=1, le=100),
    admin: AdminUser = Depends(require_permission(Permission.VIEW_AUDIT_LOGS)),
    db: Session = Depends(get_db)
):
    """Query audit logs."""
    service = AuditService(db)
    logs, total = service.query_logs(
        category=category,
        action=action,
        actor_id=actor_id,
        target_type=target_type,
        target_id=target_id,
        start_date=start_date,
        end_date=end_date,
        status=status,
        search=search,
        page=page,
        per_page=per_page
    )
    
    return {
        "logs": [
            {
                "id": log.id,
                "action": log.action,
                "category": log.category,
                "actor_type": log.actor_type,
                "actor_id": log.actor_id,
                "actor_email": log.actor_email,
                "target_type": log.target_type,
                "target_id": log.target_id,
                "target_description": log.target_description,
                "details": log.details,
                "status": log.status,
                "ip_address": log.ip_address,
                "created_at": log.created_at,
            }
            for log in logs
        ],
        "total": total,
        "page": page,
        "per_page": per_page,
        "pages": (total + per_page - 1) // per_page
    }


@router.get("/summary")
async def get_audit_summary(
    days: int = Query(7, ge=1, le=90),
    admin: AdminUser = Depends(require_permission(Permission.VIEW_AUDIT_LOGS)),
    db: Session = Depends(get_db)
):
    """Get audit activity summary."""
    service = AuditService(db)
    end_date = datetime.utcnow()
    start_date = end_date - timedelta(days=days)
    
    return service.get_activity_summary(start_date, end_date)


@router.get("/categories")
async def get_audit_categories(
    admin: AdminUser = Depends(require_permission(Permission.VIEW_AUDIT_LOGS))
):
    """Get available audit categories and actions."""
    return {
        "categories": ["auth", "user", "api_key", "story", "system"],
        "actions": {
            "auth": ["admin_login", "admin_logout", "admin_2fa_enabled"],
            "user": ["user_created", "user_updated", "user_suspended", "user_impersonated"],
            "api_key": ["api_key_created", "api_key_revoked", "api_key_admin_revoked"],
            "story": ["story_created", "story_deleted"],
            "system": ["system_setting_changed", "export_initiated"],
        }
    }
```

### 6. Audit Log UI Component

**apps/admin-dashboard/src/pages/AuditLogsPage.tsx:**
```typescript
import { useState } from "react";
import { useQuery } from "@tanstack/react-query";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Badge } from "@/components/ui/badge";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
} from "@/components/ui/dialog";
import { Search, Eye, Shield, User, Key, FileAudio, Settings } from "lucide-react";
import { format } from "date-fns";
import { adminApi } from "@/lib/api";
import Pagination from "@/components/Pagination";

interface AuditLog {
  id: string;
  action: string;
  category: string;
  actor_type: string;
  actor_email: string;
  target_type: string;
  target_description: string;
  details: Record<string, any>;
  status: string;
  ip_address: string;
  created_at: string;
}

const categoryIcons: Record<string, any> = {
  auth: Shield,
  user: User,
  api_key: Key,
  story: FileAudio,
  system: Settings,
};

export default function AuditLogsPage() {
  const [search, setSearch] = useState("");
  const [category, setCategory] = useState<string>("all");
  const [status, setStatus] = useState<string>("all");
  const [page, setPage] = useState(1);
  const [selectedLog, setSelectedLog] = useState<AuditLog | null>(null);

  const { data, isLoading } = useQuery({
    queryKey: ["audit-logs", search, category, status, page],
    queryFn: () =>
      adminApi.get("/admin/audit/logs", {
        params: {
          search: search || undefined,
          category: category !== "all" ? category : undefined,
          status: status !== "all" ? status : undefined,
          page,
          per_page: 50,
        },
      }),
  });

  const { data: summary } = useQuery({
    queryKey: ["audit-summary"],
    queryFn: () => adminApi.get("/admin/audit/summary", { params: { days: 7 } }),
  });

  const logs = data?.logs || [];
  const totalPages = data?.pages || 1;

  const getStatusBadge = (status: string) => {
    const variants: Record<string, "default" | "destructive" | "secondary"> = {
      success: "default",
      failure: "destructive",
      warning: "secondary",
    };
    return <Badge variant={variants[status] || "secondary"}>{status}</Badge>;
  };

  const getCategoryIcon = (category: string) => {
    const Icon = categoryIcons[category] || Settings;
    return <Icon className="h-4 w-4" />;
  };

  return (
    <div className="p-6">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold">Audit Logs</h1>
        <div className="text-sm text-muted-foreground">
          {summary?.total_events?.toLocaleString()} events in last 7 days
        </div>
      </div>

      {/* Summary Cards */}
      <div className="grid grid-cols-4 gap-4 mb-6">
        {summary?.by_category &&
          Object.entries(summary.by_category).map(([cat, count]) => (
            <div key={cat} className="border rounded-lg p-4">
              <div className="flex items-center gap-2 text-muted-foreground mb-1">
                {getCategoryIcon(cat)}
                <span className="capitalize">{cat}</span>
              </div>
              <div className="text-2xl font-bold">{(count as number).toLocaleString()}</div>
            </div>
          ))}
      </div>

      {/* Filters */}
      <div className="flex gap-4 mb-6">
        <div className="relative flex-1 max-w-md">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
          <Input
            placeholder="Search logs..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="pl-10"
          />
        </div>

        <Select value={category} onValueChange={setCategory}>
          <SelectTrigger className="w-40">
            <SelectValue placeholder="Category" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Categories</SelectItem>
            <SelectItem value="auth">Authentication</SelectItem>
            <SelectItem value="user">Users</SelectItem>
            <SelectItem value="api_key">API Keys</SelectItem>
            <SelectItem value="story">Stories</SelectItem>
            <SelectItem value="system">System</SelectItem>
          </SelectContent>
        </Select>

        <Select value={status} onValueChange={setStatus}>
          <SelectTrigger className="w-32">
            <SelectValue placeholder="Status" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Status</SelectItem>
            <SelectItem value="success">Success</SelectItem>
            <SelectItem value="failure">Failure</SelectItem>
            <SelectItem value="warning">Warning</SelectItem>
          </SelectContent>
        </Select>
      </div>

      {/* Logs Table */}
      <div className="border rounded-lg">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead className="w-12"></TableHead>
              <TableHead>Action</TableHead>
              <TableHead>Actor</TableHead>
              <TableHead>Target</TableHead>
              <TableHead>Status</TableHead>
              <TableHead>IP Address</TableHead>
              <TableHead>Time</TableHead>
              <TableHead className="w-12"></TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {isLoading ? (
              <TableRow>
                <TableCell colSpan={8} className="text-center py-8">
                  Loading...
                </TableCell>
              </TableRow>
            ) : logs.length === 0 ? (
              <TableRow>
                <TableCell colSpan={8} className="text-center py-8">
                  No logs found
                </TableCell>
              </TableRow>
            ) : (
              logs.map((log: AuditLog) => (
                <TableRow key={log.id}>
                  <TableCell>{getCategoryIcon(log.category)}</TableCell>
                  <TableCell>
                    <span className="font-medium">{log.action.replace(/_/g, " ")}</span>
                  </TableCell>
                  <TableCell>
                    <div className="text-sm">
                      {log.actor_email || log.actor_type}
                    </div>
                  </TableCell>
                  <TableCell>
                    <div className="text-sm text-muted-foreground">
                      {log.target_description || log.target_type || "—"}
                    </div>
                  </TableCell>
                  <TableCell>{getStatusBadge(log.status)}</TableCell>
                  <TableCell className="text-sm text-muted-foreground">
                    {log.ip_address || "—"}
                  </TableCell>
                  <TableCell className="text-sm text-muted-foreground">
                    {format(new Date(log.created_at), "MMM d, HH:mm")}
                  </TableCell>
                  <TableCell>
                    <Button
                      variant="ghost"
                      size="icon"
                      onClick={() => setSelectedLog(log)}
                    >
                      <Eye className="h-4 w-4" />
                    </Button>
                  </TableCell>
                </TableRow>
              ))
            )}
          </TableBody>
        </Table>
      </div>

      {/* Pagination */}
      <div className="mt-4">
        <Pagination
          currentPage={page}
          totalPages={totalPages}
          onPageChange={setPage}
        />
      </div>

      {/* Log Detail Dialog */}
      <Dialog open={!!selectedLog} onOpenChange={() => setSelectedLog(null)}>
        <DialogContent className="max-w-lg">
          <DialogHeader>
            <DialogTitle>Audit Log Details</DialogTitle>
          </DialogHeader>
          {selectedLog && (
            <div className="space-y-4">
              <div>
                <div className="text-sm text-muted-foreground">Action</div>
                <div className="font-medium">{selectedLog.action}</div>
              </div>
              <div>
                <div className="text-sm text-muted-foreground">Actor</div>
                <div>{selectedLog.actor_email || selectedLog.actor_type}</div>
              </div>
              <div>
                <div className="text-sm text-muted-foreground">Time</div>
                <div>{format(new Date(selectedLog.created_at), "PPpp")}</div>
              </div>
              <div>
                <div className="text-sm text-muted-foreground">IP Address</div>
                <div>{selectedLog.ip_address || "—"}</div>
              </div>
              {selectedLog.details && Object.keys(selectedLog.details).length > 0 && (
                <div>
                  <div className="text-sm text-muted-foreground mb-2">Details</div>
                  <pre className="bg-muted p-3 rounded text-xs overflow-auto">
                    {JSON.stringify(selectedLog.details, null, 2)}
                  </pre>
                </div>
              )}
            </div>
          )}
        </DialogContent>
      </Dialog>
    </div>
  );
}
```

## File Structure
```
backend/
├── models/
│   └── audit_log.py
├── services/
│   ├── audit_service.py
│   └── api_key_admin_service.py
└── routers/
    ├── admin_api_keys.py
    └── admin_audit.py

apps/admin-dashboard/
└── src/
    └── pages/
        ├── APIKeysPage.tsx
        └── AuditLogsPage.tsx
```

## Validation Gates

### Gate 1: List All API Keys
```python
def test_list_all_api_keys():
    """Verify admin can list all API keys."""
    response = client.get("/admin/api-keys", headers=admin_headers)
    
    assert response.status_code == 200
    data = response.json()
    assert "keys" in data
    assert "total" in data
```

### Gate 2: Admin Revoke Key
```python
def test_admin_revoke_key():
    """Verify admin can revoke any API key."""
    # Create a key for another user
    key_id = create_test_api_key(user_id="other_user")
    
    response = client.post(
        f"/admin/api-keys/{key_id}/revoke",
        json={"reason": "Security concern"},
        headers=admin_headers
    )
    
    assert response.status_code == 200
    
    # Verify key is revoked
    key_resp = client.get(f"/admin/api-keys/{key_id}", headers=admin_headers)
    assert key_resp.json()["key"]["revoked_at"] is not None
```

### Gate 3: Audit Log Query
```python
def test_audit_log_query():
    """Verify audit logs can be queried."""
    response = client.get(
        "/admin/audit/logs",
        params={"category": "user", "page": 1},
        headers=admin_headers
    )
    
    assert response.status_code == 200
    data = response.json()
    assert "logs" in data
    
    # All logs should be in user category
    for log in data["logs"]:
        assert log["category"] == "user"
```

### Gate 4: Action Creates Audit Log
```python
def test_action_creates_audit_log():
    """Verify admin actions are logged."""
    # Perform an action
    client.post(
        f"/admin/users/{user_id}/suspend",
        json={"reason": "Test"},
        headers=admin_headers
    )
    
    # Check audit log
    response = client.get(
        "/admin/audit/logs",
        params={"action": "user_suspended", "target_id": user_id},
        headers=admin_headers
    )
    
    assert response.status_code == 200
    logs = response.json()["logs"]
    assert len(logs) >= 1
    assert logs[0]["target_id"] == user_id
```

## Security Considerations

1. **Immutable Logs**: Audit logs cannot be modified or deleted
2. **Comprehensive Coverage**: All admin actions logged
3. **Request Metadata**: IP and user agent captured
4. **Searchable**: Efficient querying for investigations
5. **Retention**: Configurable retention policy
6. **Export**: Compliance-ready data export

## Definition of Done
- [ ] Audit log model with indexes
- [ ] Audit service with comprehensive logging
- [ ] API key admin listing
- [ ] Admin key revocation with reason
- [ ] Audit log query endpoint
- [ ] Audit activity summary
- [ ] API keys admin UI
- [ ] Audit logs UI with filtering
- [ ] Log detail view
- [ ] All validation gates passing
