# Plan 11-02: User Management Interface

## Overview
Build comprehensive user management capabilities for admins including user search, profile viewing, quota management, account actions (suspend, delete), and user impersonation for support purposes.

## Dependencies
- Plan 11-01: Admin authentication and authorization
- Phase 6: User models and database

## Implementation

### 1. User Management Service

**services/user_management_service.py:**
```python
"""User management service for admins."""
import uuid
from datetime import datetime
from typing import Optional
from sqlalchemy import or_, func
from sqlalchemy.orm import Session

from models.user import User
from models.story import Story
from models.api_key import APIKey
from models.admin import AuditLog, AdminUser
from schemas.admin import UserListFilters, UserUpdate, QuotaUpdate


class UserManagementService:
    """Service for admin user management operations."""
    
    def __init__(self, db: Session, admin: AdminUser):
        self.db = db
        self.admin = admin
    
    def search_users(
        self,
        filters: UserListFilters,
        page: int = 1,
        per_page: int = 20
    ) -> tuple[list[User], int]:
        """Search and filter users with pagination."""
        query = self.db.query(User)
        
        # Text search
        if filters.search:
            search_term = f"%{filters.search}%"
            query = query.filter(or_(
                User.email.ilike(search_term),
                User.name.ilike(search_term)
            ))
        
        # Status filter
        if filters.status == "active":
            query = query.filter(User.is_active == True, User.suspended_at.is_(None))
        elif filters.status == "suspended":
            query = query.filter(User.suspended_at.isnot(None))
        elif filters.status == "inactive":
            query = query.filter(User.is_active == False)
        
        # Plan filter
        if filters.plan:
            query = query.filter(User.plan == filters.plan)
        
        # Date range
        if filters.created_after:
            query = query.filter(User.created_at >= filters.created_after)
        if filters.created_before:
            query = query.filter(User.created_at <= filters.created_before)
        
        # Get total count
        total = query.count()
        
        # Apply pagination
        offset = (page - 1) * per_page
        users = query.order_by(User.created_at.desc()).offset(offset).limit(per_page).all()
        
        return users, total
    
    def get_user_details(self, user_id: str) -> Optional[dict]:
        """Get detailed user information for admin view."""
        user = self.db.query(User).filter(User.id == user_id).first()
        if not user:
            return None
        
        # Get usage stats
        story_count = self.db.query(func.count(Story.id)).filter(
            Story.user_id == user_id
        ).scalar()
        
        api_key_count = self.db.query(func.count(APIKey.id)).filter(
            APIKey.user_id == user_id,
            APIKey.revoked_at.is_(None)
        ).scalar()
        
        # Get quota usage
        current_month = datetime.utcnow().replace(day=1, hour=0, minute=0, second=0)
        monthly_stories = self.db.query(func.count(Story.id)).filter(
            Story.user_id == user_id,
            Story.created_at >= current_month
        ).scalar()
        
        return {
            "user": user,
            "stats": {
                "total_stories": story_count,
                "active_api_keys": api_key_count,
                "monthly_stories": monthly_stories,
            },
            "quota": {
                "stories_per_month": user.quota_stories_per_month,
                "api_requests_per_day": user.quota_api_requests_per_day,
                "storage_bytes": user.quota_storage_bytes,
            }
        }
    
    def update_user(self, user_id: str, updates: UserUpdate) -> Optional[User]:
        """Update user profile (admin action)."""
        user = self.db.query(User).filter(User.id == user_id).first()
        if not user:
            return None
        
        # Track changes for audit
        changes = {}
        
        if updates.name is not None and updates.name != user.name:
            changes["name"] = {"from": user.name, "to": updates.name}
            user.name = updates.name
        
        if updates.email is not None and updates.email != user.email:
            changes["email"] = {"from": user.email, "to": updates.email}
            user.email = updates.email
        
        if updates.plan is not None and updates.plan != user.plan:
            changes["plan"] = {"from": user.plan, "to": updates.plan}
            user.plan = updates.plan
        
        if changes:
            self._log_action("user_updated", user_id, changes)
        
        self.db.commit()
        self.db.refresh(user)
        return user
    
    def update_quotas(self, user_id: str, quotas: QuotaUpdate) -> Optional[User]:
        """Update user quotas."""
        user = self.db.query(User).filter(User.id == user_id).first()
        if not user:
            return None
        
        changes = {}
        
        if quotas.stories_per_month is not None:
            changes["stories_per_month"] = {
                "from": user.quota_stories_per_month,
                "to": quotas.stories_per_month
            }
            user.quota_stories_per_month = quotas.stories_per_month
        
        if quotas.api_requests_per_day is not None:
            changes["api_requests_per_day"] = {
                "from": user.quota_api_requests_per_day,
                "to": quotas.api_requests_per_day
            }
            user.quota_api_requests_per_day = quotas.api_requests_per_day
        
        if quotas.storage_bytes is not None:
            changes["storage_bytes"] = {
                "from": user.quota_storage_bytes,
                "to": quotas.storage_bytes
            }
            user.quota_storage_bytes = quotas.storage_bytes
        
        if changes:
            self._log_action("quota_updated", user_id, changes)
        
        self.db.commit()
        self.db.refresh(user)
        return user
    
    def suspend_user(self, user_id: str, reason: str) -> Optional[User]:
        """Suspend a user account."""
        user = self.db.query(User).filter(User.id == user_id).first()
        if not user:
            return None
        
        user.suspended_at = datetime.utcnow()
        user.suspension_reason = reason
        
        self._log_action("user_suspended", user_id, {"reason": reason})
        
        self.db.commit()
        self.db.refresh(user)
        return user
    
    def unsuspend_user(self, user_id: str) -> Optional[User]:
        """Remove suspension from user account."""
        user = self.db.query(User).filter(User.id == user_id).first()
        if not user:
            return None
        
        user.suspended_at = None
        user.suspension_reason = None
        
        self._log_action("user_unsuspended", user_id)
        
        self.db.commit()
        self.db.refresh(user)
        return user
    
    def delete_user(self, user_id: str, hard_delete: bool = False) -> bool:
        """Delete user account (soft or hard delete)."""
        user = self.db.query(User).filter(User.id == user_id).first()
        if not user:
            return False
        
        if hard_delete:
            # Hard delete - remove all data
            self.db.query(Story).filter(Story.user_id == user_id).delete()
            self.db.query(APIKey).filter(APIKey.user_id == user_id).delete()
            self.db.delete(user)
            self._log_action("user_hard_deleted", user_id)
        else:
            # Soft delete
            user.is_active = False
            user.deleted_at = datetime.utcnow()
            self._log_action("user_soft_deleted", user_id)
        
        self.db.commit()
        return True
    
    def create_impersonation_token(self, user_id: str) -> Optional[str]:
        """Create a temporary token to impersonate user for support."""
        user = self.db.query(User).filter(User.id == user_id).first()
        if not user:
            return None
        
        from auth import create_access_token
        from datetime import timedelta
        
        # Short-lived impersonation token (15 minutes)
        token_data = {
            "sub": user.id,
            "type": "impersonation",
            "impersonated_by": self.admin.id,
        }
        token = create_access_token(token_data, expires_delta=timedelta(minutes=15))
        
        self._log_action("user_impersonated", user_id)
        
        return token
    
    def _log_action(self, action: str, target_id: str, details: dict = None):
        """Log admin action for audit trail."""
        log = AuditLog(
            id=str(uuid.uuid4()),
            admin_id=self.admin.id,
            action=action,
            target_type="user",
            target_id=target_id,
            details=details or {},
            created_at=datetime.utcnow()
        )
        self.db.add(log)
```

### 2. User Management Router

**routers/admin_users.py:**
```python
"""Admin user management endpoints."""
from fastapi import APIRouter, Depends, HTTPException, status, Query
from sqlalchemy.orm import Session
from typing import Optional

from database import get_db
from models.admin import AdminUser, Permission
from schemas.admin import (
    UserListResponse,
    UserDetailResponse,
    UserUpdate,
    QuotaUpdate,
    SuspendRequest,
    UserListFilters,
)
from services.user_management_service import UserManagementService
from auth.admin_auth import get_current_admin, require_permission

router = APIRouter(prefix="/admin/users", tags=["admin-users"])


@router.get("", response_model=UserListResponse)
async def list_users(
    search: Optional[str] = None,
    status: Optional[str] = None,
    plan: Optional[str] = None,
    created_after: Optional[str] = None,
    created_before: Optional[str] = None,
    page: int = Query(1, ge=1),
    per_page: int = Query(20, ge=1, le=100),
    admin: AdminUser = Depends(require_permission(Permission.VIEW_USERS)),
    db: Session = Depends(get_db)
):
    """List and search users."""
    filters = UserListFilters(
        search=search,
        status=status,
        plan=plan,
        created_after=created_after,
        created_before=created_before
    )
    
    service = UserManagementService(db, admin)
    users, total = service.search_users(filters, page, per_page)
    
    return UserListResponse(
        users=users,
        total=total,
        page=page,
        per_page=per_page,
        pages=(total + per_page - 1) // per_page
    )


@router.get("/{user_id}", response_model=UserDetailResponse)
async def get_user(
    user_id: str,
    admin: AdminUser = Depends(require_permission(Permission.VIEW_USERS)),
    db: Session = Depends(get_db)
):
    """Get detailed user information."""
    service = UserManagementService(db, admin)
    details = service.get_user_details(user_id)
    
    if not details:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="User not found"
        )
    
    return UserDetailResponse(**details)


@router.patch("/{user_id}", response_model=dict)
async def update_user(
    user_id: str,
    updates: UserUpdate,
    admin: AdminUser = Depends(require_permission(Permission.EDIT_USERS)),
    db: Session = Depends(get_db)
):
    """Update user profile."""
    service = UserManagementService(db, admin)
    user = service.update_user(user_id, updates)
    
    if not user:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="User not found"
        )
    
    return {"message": "User updated", "user_id": user.id}


@router.patch("/{user_id}/quotas", response_model=dict)
async def update_quotas(
    user_id: str,
    quotas: QuotaUpdate,
    admin: AdminUser = Depends(require_permission(Permission.MANAGE_QUOTAS)),
    db: Session = Depends(get_db)
):
    """Update user quotas."""
    service = UserManagementService(db, admin)
    user = service.update_quotas(user_id, quotas)
    
    if not user:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="User not found"
        )
    
    return {"message": "Quotas updated", "user_id": user.id}


@router.post("/{user_id}/suspend")
async def suspend_user(
    user_id: str,
    request: SuspendRequest,
    admin: AdminUser = Depends(require_permission(Permission.EDIT_USERS)),
    db: Session = Depends(get_db)
):
    """Suspend a user account."""
    service = UserManagementService(db, admin)
    user = service.suspend_user(user_id, request.reason)
    
    if not user:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="User not found"
        )
    
    return {"message": "User suspended", "user_id": user.id}


@router.post("/{user_id}/unsuspend")
async def unsuspend_user(
    user_id: str,
    admin: AdminUser = Depends(require_permission(Permission.EDIT_USERS)),
    db: Session = Depends(get_db)
):
    """Remove suspension from user account."""
    service = UserManagementService(db, admin)
    user = service.unsuspend_user(user_id)
    
    if not user:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="User not found"
        )
    
    return {"message": "User unsuspended", "user_id": user.id}


@router.delete("/{user_id}")
async def delete_user(
    user_id: str,
    hard_delete: bool = False,
    admin: AdminUser = Depends(require_permission(Permission.DELETE_USERS)),
    db: Session = Depends(get_db)
):
    """Delete a user account."""
    service = UserManagementService(db, admin)
    
    if not service.delete_user(user_id, hard_delete):
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="User not found"
        )
    
    return {"message": "User deleted", "hard_delete": hard_delete}


@router.post("/{user_id}/impersonate")
async def impersonate_user(
    user_id: str,
    admin: AdminUser = Depends(require_permission(Permission.EDIT_USERS)),
    db: Session = Depends(get_db)
):
    """Create impersonation token for support."""
    service = UserManagementService(db, admin)
    token = service.create_impersonation_token(user_id)
    
    if not token:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="User not found"
        )
    
    return {
        "impersonation_token": token,
        "expires_in": 900,  # 15 minutes
        "warning": "This action is logged for audit purposes"
    }
```

### 3. Admin Dashboard User List Component

**apps/admin-dashboard/src/pages/UsersPage.tsx:**
```typescript
import { useState } from "react";
import { useQuery } from "@tanstack/react-query";
import {
  Table,
  TableBody,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from "@/components/ui/table";
import { Input } from "@/components/ui/input";
import { Button } from "@/components/ui/button";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { Badge } from "@/components/ui/badge";
import { Search, MoreHorizontal, Eye, Ban, Trash2, UserCog } from "lucide-react";
import { formatDistanceToNow } from "date-fns";
import { adminApi } from "@/lib/api";
import UserDetailSheet from "@/components/UserDetailSheet";
import Pagination from "@/components/Pagination";

interface User {
  id: string;
  email: string;
  name: string;
  plan: string;
  is_active: boolean;
  suspended_at: string | null;
  created_at: string;
  last_login_at: string | null;
}

export default function UsersPage() {
  const [search, setSearch] = useState("");
  const [status, setStatus] = useState<string>("all");
  const [plan, setPlan] = useState<string>("all");
  const [page, setPage] = useState(1);
  const [selectedUserId, setSelectedUserId] = useState<string | null>(null);

  const { data, isLoading, refetch } = useQuery({
    queryKey: ["admin-users", search, status, plan, page],
    queryFn: () =>
      adminApi.get("/admin/users", {
        params: {
          search: search || undefined,
          status: status !== "all" ? status : undefined,
          plan: plan !== "all" ? plan : undefined,
          page,
          per_page: 20,
        },
      }),
  });

  const users = data?.users || [];
  const totalPages = data?.pages || 1;

  const getStatusBadge = (user: User) => {
    if (user.suspended_at) {
      return <Badge variant="destructive">Suspended</Badge>;
    }
    if (!user.is_active) {
      return <Badge variant="secondary">Inactive</Badge>;
    }
    return <Badge variant="default">Active</Badge>;
  };

  const handleAction = async (action: string, userId: string) => {
    switch (action) {
      case "view":
        setSelectedUserId(userId);
        break;
      case "suspend":
        if (confirm("Are you sure you want to suspend this user?")) {
          await adminApi.post(`/admin/users/${userId}/suspend`, {
            reason: "Admin action",
          });
          refetch();
        }
        break;
      case "delete":
        if (confirm("Are you sure you want to delete this user? This cannot be undone.")) {
          await adminApi.delete(`/admin/users/${userId}`);
          refetch();
        }
        break;
    }
  };

  return (
    <div className="p-6">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold">Users</h1>
      </div>

      {/* Filters */}
      <div className="flex gap-4 mb-6">
        <div className="relative flex-1 max-w-md">
          <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
          <Input
            placeholder="Search by email or name..."
            value={search}
            onChange={(e) => setSearch(e.target.value)}
            className="pl-10"
          />
        </div>

        <Select value={status} onValueChange={setStatus}>
          <SelectTrigger className="w-40">
            <SelectValue placeholder="Status" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Status</SelectItem>
            <SelectItem value="active">Active</SelectItem>
            <SelectItem value="suspended">Suspended</SelectItem>
            <SelectItem value="inactive">Inactive</SelectItem>
          </SelectContent>
        </Select>

        <Select value={plan} onValueChange={setPlan}>
          <SelectTrigger className="w-40">
            <SelectValue placeholder="Plan" />
          </SelectTrigger>
          <SelectContent>
            <SelectItem value="all">All Plans</SelectItem>
            <SelectItem value="free">Free</SelectItem>
            <SelectItem value="pro">Pro</SelectItem>
            <SelectItem value="enterprise">Enterprise</SelectItem>
          </SelectContent>
        </Select>
      </div>

      {/* Users Table */}
      <div className="border rounded-lg">
        <Table>
          <TableHeader>
            <TableRow>
              <TableHead>User</TableHead>
              <TableHead>Plan</TableHead>
              <TableHead>Status</TableHead>
              <TableHead>Joined</TableHead>
              <TableHead>Last Login</TableHead>
              <TableHead className="w-12"></TableHead>
            </TableRow>
          </TableHeader>
          <TableBody>
            {isLoading ? (
              <TableRow>
                <TableCell colSpan={6} className="text-center py-8">
                  Loading...
                </TableCell>
              </TableRow>
            ) : users.length === 0 ? (
              <TableRow>
                <TableCell colSpan={6} className="text-center py-8">
                  No users found
                </TableCell>
              </TableRow>
            ) : (
              users.map((user: User) => (
                <TableRow key={user.id}>
                  <TableCell>
                    <div>
                      <div className="font-medium">{user.name || "—"}</div>
                      <div className="text-sm text-muted-foreground">
                        {user.email}
                      </div>
                    </div>
                  </TableCell>
                  <TableCell>
                    <Badge variant="outline" className="capitalize">
                      {user.plan}
                    </Badge>
                  </TableCell>
                  <TableCell>{getStatusBadge(user)}</TableCell>
                  <TableCell>
                    {formatDistanceToNow(new Date(user.created_at), {
                      addSuffix: true,
                    })}
                  </TableCell>
                  <TableCell>
                    {user.last_login_at
                      ? formatDistanceToNow(new Date(user.last_login_at), {
                          addSuffix: true,
                        })
                      : "Never"}
                  </TableCell>
                  <TableCell>
                    <DropdownMenu>
                      <DropdownMenuTrigger asChild>
                        <Button variant="ghost" size="icon">
                          <MoreHorizontal className="h-4 w-4" />
                        </Button>
                      </DropdownMenuTrigger>
                      <DropdownMenuContent align="end">
                        <DropdownMenuItem
                          onClick={() => handleAction("view", user.id)}
                        >
                          <Eye className="h-4 w-4 mr-2" />
                          View Details
                        </DropdownMenuItem>
                        <DropdownMenuItem
                          onClick={() => handleAction("suspend", user.id)}
                        >
                          <Ban className="h-4 w-4 mr-2" />
                          {user.suspended_at ? "Unsuspend" : "Suspend"}
                        </DropdownMenuItem>
                        <DropdownMenuItem
                          onClick={() => handleAction("delete", user.id)}
                          className="text-destructive"
                        >
                          <Trash2 className="h-4 w-4 mr-2" />
                          Delete
                        </DropdownMenuItem>
                      </DropdownMenuContent>
                    </DropdownMenu>
                  </TableCell>
                </TableRow>
              ))
            )}
          </TableBody>
        </Table>
      </div>

      {/* Pagination */}
      <div className="mt-4">
        <Pagination
          currentPage={page}
          totalPages={totalPages}
          onPageChange={setPage}
        />
      </div>

      {/* User Detail Sheet */}
      <UserDetailSheet
        userId={selectedUserId}
        open={!!selectedUserId}
        onClose={() => setSelectedUserId(null)}
        onUpdate={refetch}
      />
    </div>
  );
}
```

### 4. User Detail Sheet Component

**components/UserDetailSheet.tsx:**
```typescript
import { useQuery, useMutation } from "@tanstack/react-query";
import {
  Sheet,
  SheetContent,
  SheetHeader,
  SheetTitle,
} from "@/components/ui/sheet";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Loader2, Save } from "lucide-react";
import { useState, useEffect } from "react";
import { adminApi } from "@/lib/api";
import { toast } from "@/components/ui/use-toast";

interface UserDetailSheetProps {
  userId: string | null;
  open: boolean;
  onClose: () => void;
  onUpdate: () => void;
}

export default function UserDetailSheet({
  userId,
  open,
  onClose,
  onUpdate,
}: UserDetailSheetProps) {
  const [quotas, setQuotas] = useState({
    stories_per_month: 0,
    api_requests_per_day: 0,
    storage_bytes: 0,
  });

  const { data, isLoading } = useQuery({
    queryKey: ["admin-user", userId],
    queryFn: () => adminApi.get(`/admin/users/${userId}`),
    enabled: !!userId && open,
  });

  useEffect(() => {
    if (data?.quota) {
      setQuotas(data.quota);
    }
  }, [data]);

  const updateQuotasMutation = useMutation({
    mutationFn: (newQuotas: typeof quotas) =>
      adminApi.patch(`/admin/users/${userId}/quotas`, newQuotas),
    onSuccess: () => {
      toast({ title: "Quotas updated" });
      onUpdate();
    },
  });

  const impersonateMutation = useMutation({
    mutationFn: () => adminApi.post(`/admin/users/${userId}/impersonate`),
    onSuccess: (data) => {
      navigator.clipboard.writeText(data.impersonation_token);
      toast({
        title: "Impersonation token copied",
        description: "Token expires in 15 minutes",
      });
    },
  });

  if (!userId) return null;

  return (
    <Sheet open={open} onOpenChange={(o) => !o && onClose()}>
      <SheetContent className="w-[600px] sm:max-w-[600px] overflow-y-auto">
        <SheetHeader>
          <SheetTitle>User Details</SheetTitle>
        </SheetHeader>

        {isLoading ? (
          <div className="flex justify-center py-12">
            <Loader2 className="h-8 w-8 animate-spin" />
          </div>
        ) : data ? (
          <Tabs defaultValue="overview" className="mt-6">
            <TabsList>
              <TabsTrigger value="overview">Overview</TabsTrigger>
              <TabsTrigger value="quotas">Quotas</TabsTrigger>
              <TabsTrigger value="activity">Activity</TabsTrigger>
            </TabsList>

            <TabsContent value="overview" className="space-y-4">
              <Card>
                <CardHeader>
                  <CardTitle>Profile</CardTitle>
                </CardHeader>
                <CardContent className="space-y-3">
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Email</span>
                    <span>{data.user.email}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Name</span>
                    <span>{data.user.name || "—"}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Plan</span>
                    <Badge variant="outline">{data.user.plan}</Badge>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Status</span>
                    <Badge
                      variant={data.user.suspended_at ? "destructive" : "default"}
                    >
                      {data.user.suspended_at ? "Suspended" : "Active"}
                    </Badge>
                  </div>
                </CardContent>
              </Card>

              <Card>
                <CardHeader>
                  <CardTitle>Usage Stats</CardTitle>
                </CardHeader>
                <CardContent className="space-y-3">
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Total Stories</span>
                    <span>{data.stats.total_stories}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">This Month</span>
                    <span>{data.stats.monthly_stories}</span>
                  </div>
                  <div className="flex justify-between">
                    <span className="text-muted-foreground">Active API Keys</span>
                    <span>{data.stats.active_api_keys}</span>
                  </div>
                </CardContent>
              </Card>

              <Button
                variant="outline"
                onClick={() => impersonateMutation.mutate()}
                disabled={impersonateMutation.isPending}
              >
                {impersonateMutation.isPending && (
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                )}
                Impersonate User
              </Button>
            </TabsContent>

            <TabsContent value="quotas" className="space-y-4">
              <Card>
                <CardHeader>
                  <CardTitle>Quota Management</CardTitle>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div>
                    <Label>Stories per Month</Label>
                    <Input
                      type="number"
                      value={quotas.stories_per_month}
                      onChange={(e) =>
                        setQuotas((q) => ({
                          ...q,
                          stories_per_month: parseInt(e.target.value),
                        }))
                      }
                    />
                  </div>
                  <div>
                    <Label>API Requests per Day</Label>
                    <Input
                      type="number"
                      value={quotas.api_requests_per_day}
                      onChange={(e) =>
                        setQuotas((q) => ({
                          ...q,
                          api_requests_per_day: parseInt(e.target.value),
                        }))
                      }
                    />
                  </div>
                  <div>
                    <Label>Storage (bytes)</Label>
                    <Input
                      type="number"
                      value={quotas.storage_bytes}
                      onChange={(e) =>
                        setQuotas((q) => ({
                          ...q,
                          storage_bytes: parseInt(e.target.value),
                        }))
                      }
                    />
                  </div>
                  <Button
                    onClick={() => updateQuotasMutation.mutate(quotas)}
                    disabled={updateQuotasMutation.isPending}
                  >
                    {updateQuotasMutation.isPending ? (
                      <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    ) : (
                      <Save className="h-4 w-4 mr-2" />
                    )}
                    Save Quotas
                  </Button>
                </CardContent>
              </Card>
            </TabsContent>

            <TabsContent value="activity">
              <Card>
                <CardHeader>
                  <CardTitle>Recent Activity</CardTitle>
                </CardHeader>
                <CardContent>
                  {/* Activity log would go here */}
                  <p className="text-muted-foreground">
                    Activity log coming soon...
                  </p>
                </CardContent>
              </Card>
            </TabsContent>
          </Tabs>
        ) : null}
      </SheetContent>
    </Sheet>
  );
}
```

## File Structure
```
backend/
├── services/
│   └── user_management_service.py
└── routers/
    └── admin_users.py

apps/admin-dashboard/
└── src/
    ├── pages/
    │   └── UsersPage.tsx
    └── components/
        ├── UserDetailSheet.tsx
        └── Pagination.tsx
```

## Validation Gates

### Gate 1: User Search
```typescript
test("admin can search users", async ({ page }) => {
  await page.goto("/admin/users");
  
  await page.fill('input[placeholder*="Search"]', "test@example.com");
  await page.waitForResponse(/admin\/users/);
  
  await expect(page.locator("tbody tr")).toHaveCount(1);
  await expect(page.locator("text=test@example.com")).toBeVisible();
});
```

### Gate 2: Quota Update
```typescript
test("admin can update user quotas", async ({ page }) => {
  await page.goto("/admin/users");
  
  await page.click('button:has-text("View Details")');
  await page.click('button:has-text("Quotas")');
  
  await page.fill('input[name="stories_per_month"]', "100");
  await page.click('button:has-text("Save Quotas")');
  
  await expect(page.locator("text=Quotas updated")).toBeVisible();
});
```

### Gate 3: User Suspension
```python
def test_suspend_user():
    """Verify admin can suspend user."""
    response = client.post(
        f"/admin/users/{user_id}/suspend",
        json={"reason": "Policy violation"},
        headers=admin_headers
    )
    
    assert response.status_code == 200
    
    # Verify user is suspended
    user_resp = client.get(f"/admin/users/{user_id}", headers=admin_headers)
    assert user_resp.json()["user"]["suspended_at"] is not None
```

### Gate 4: Impersonation
```python
def test_impersonation_token():
    """Verify impersonation creates valid token."""
    response = client.post(
        f"/admin/users/{user_id}/impersonate",
        headers=admin_headers
    )
    
    assert response.status_code == 200
    token = response.json()["impersonation_token"]
    
    # Token can access user's data
    stories_resp = client.get(
        "/api/v1/stories",
        headers={"Authorization": f"Bearer {token}"}
    )
    assert stories_resp.status_code == 200
```

## Definition of Done
- [ ] User search with filtering
- [ ] User detail view with stats
- [ ] Quota management UI
- [ ] User suspension/unsuspension
- [ ] User deletion (soft/hard)
- [ ] Impersonation token generation
- [ ] Audit logging for all actions
- [ ] Pagination component
- [ ] All validation gates passing
