---
phase: 04-story-architect
plan: 03
type: execute
domain: python-api
---

<objective>
Assemble the Story Architect Agent with style selection and chapter orchestration.
</objective>

<context>
@BRIEF.md
@codestory/backend/skills/story/styles.py
@codestory/backend/skills/story/chapters.py
</context>

<sub_agent_hint>
The 5 narrative styles (Fiction, Documentary, Tutorial, Podcast, Technical) each require distinct prompt engineering and tone calibration. Consider spawning sub-agents for style development:

**Benefits of Style-Specific Sub-Agents:**
- Each style has unique voice, pacing, and vocabulary
- Prompt engineering can iterate independently per style
- Testing with sample repos can parallelize
- Style refinement doesn't block other Story Architect work

**Suggested Approach:**
1. Main agent defines style interface and chapter structure
2. Sub-agents develop and test individual style prompts
3. Each sub-agent produces: system prompt, example outputs, test cases
4. Main agent integrates and validates consistency

**Per-Style Considerations:**
- Fiction: Character voices, dramatic arc, tension building
- Documentary: Authoritative tone, factual precision, pacing
- Tutorial: Progressive complexity, encouragement, checkpoints
- Podcast: Conversational flow, tangents, personality
- Technical: Precision, terminology, completeness
</sub_agent_hint>

<tasks>

<task type="auto">
  <n>Task 1: Create Story Architect Agent</n>
  <files>codestory/backend/agents/story_architect.py</files>
  <action>
Create agent that orchestrates story generation:

```python
"""Story Architect Agent for narrative generation."""

from typing import Any

from backend.agents.base import BaseAgent, AgentConfig, AgentRole
from backend.core.config import get_settings
from backend.skills.story import (
    NarrativeStyle,
    ExpertiseLevel,
    get_style_prompt,
)
from backend.skills.story.chapters import (
    generate_chapter_script,
    generate_story_outline,
)


STORY_ARCHITECT_SYSTEM_PROMPT = '''You are the Story Architect Agent for Code Story.

Your role is to transform repository analysis into engaging audio narratives.

## Your Capabilities
1. Select appropriate narrative style based on user intent
2. Generate chapter outlines tailored to the codebase
3. Create chapter scripts with voice synthesis directions
4. Ensure narrative coherence across chapters

## Available Styles
- Fiction: Epic adventure narrative
- Documentary: Professional documentary
- Tutorial: Educational walkthrough
- Podcast: Casual conversational
- Technical: Precise documentation

## Process
1. Review the analysis and user intent
2. Select or confirm narrative style
3. Generate chapter outline
4. Create scripts for each chapter
5. Add voice directions for synthesis

Output engaging, coherent narratives that make code accessible and interesting.'''


class StoryArchitectAgent(BaseAgent):
    """Agent for story generation and narrative creation."""
    
    def __init__(self):
        settings = get_settings()
        config = AgentConfig(
            role=AgentRole.ARCHITECT,
            name="Story Architect",
            model=settings.claude_model,
            system_prompt=STORY_ARCHITECT_SYSTEM_PROMPT,
            max_iterations=10,  # More iterations for multiple chapters
        )
        super().__init__(config)
        
        self.register_skill(generate_chapter_script)
        self.register_skill(generate_story_outline)
    
    async def create_story(
        self,
        analysis: dict[str, Any],
        style: str = "documentary",
        expertise: str = "intermediate",
        intent: dict[str, Any] | None = None,
    ) -> dict[str, Any]:
        """Create a complete story from analysis."""
        # Auto-select style from intent if provided
        if intent and not style:
            style = self._select_style_from_intent(intent)
        
        outline = await generate_story_outline(
            analysis=analysis,
            style=style,
            expertise=expertise,
        )
        
        return {
            "story": outline,
            "status": "complete",
        }
    
    def _select_style_from_intent(self, intent: dict[str, Any]) -> str:
        """Select narrative style based on user intent."""
        intent_category = intent.get("intent_category", "")
        
        style_mapping = {
            "onboarding": "tutorial",
            "architecture_understanding": "documentary",
            "code_review": "technical",
            "feature_focus": "documentary",
            "patterns": "documentary",
            "api_docs": "technical",
            "debugging": "tutorial",
        }
        
        return style_mapping.get(intent_category, "documentary")
    
    async def run_stage(self, context: dict[str, Any]) -> dict[str, Any]:
        """Run as pipeline ARCHITECT stage."""
        analysis = context.get("analysis", {})
        intent = context.get("intent")
        style = context.get("style", "documentary")
        expertise = context.get("expertise", "intermediate")
        
        result = await self.create_story(
            analysis=analysis,
            style=style,
            expertise=expertise,
            intent=intent,
        )
        
        return {
            "story": result.get("story"),
            "analysis": analysis,
            "intent": intent,
        }


story_architect_agent = StoryArchitectAgent()
```
  </action>
  <verify>python -c "from codestory.backend.agents.story_architect import story_architect_agent; print('Agent OK')"</verify>
  <done>Story Architect Agent created</done>
</task>

<task type="auto">
  <n>Task 2: Create story API endpoints</n>
  <files>codestory/backend/api/routes/story.py</files>
  <action>
Create story generation API endpoints with style selection.
  </action>
  <verify>python -c "from codestory.backend.api.routes.story import router; print('Router OK')"</verify>
  <done>Story router created</done>
</task>

</tasks>

<playwright_validation_gate>
```
Playwright Action: HTTP POST /story/create
Body: {"analysis": {...}, "style": "documentary", "expertise": "intermediate"}
Expected: 200 OK
Assert: response.json().story.chapters.length >= 4
```
</playwright_validation_gate>
