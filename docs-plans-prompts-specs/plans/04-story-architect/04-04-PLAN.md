---
phase: 04-story-architect
plan: 04
type: execute
domain: python-api
---

<objective>
Implement chapter transition generation and pacing calculation for smooth audio flow.
</objective>

<context>
@BRIEF.md
@codestory/backend/skills/story/chapters.py
</context>

<reasoning_guidance>
Thoroughly analyze audio pacing principles before implementing.

Pacing involves subjective creative decisions that significantly impact listener experience:
- How long should pauses be between sections? (cognitive load, comprehension time)
- How do transition styles affect perceived flow? (abrupt vs smooth)
- What's the optimal chapter length for retention? (attention span research)
- How should pacing vary by narrative style? (fiction: dramatic pauses vs technical: brisk)

Consider insights from professional audiobook production:
- Typical pause: 0.5-1s between sentences, 2-3s between paragraphs
- Chapter breaks: 3-5s silence helps mental context switching
- Emphasis markers: 0.25-0.5s before important terms
- Breathing room: listeners need processing time for complex concepts

Explore multiple pacing models:
- Fixed timing (simple, predictable, potentially monotonous)
- Content-adaptive (pause longer after complex sections)
- Listener-configurable (1x, 1.25x, 1.5x speed presets)

The approach here uses template-based transitions with configurable durations - 
balance consistency with style-appropriate variation.
</reasoning_guidance>

<tasks>

<task type="auto">
  <n>Task 1: Create transition and pacing utilities</n>
  <files>codestory/backend/skills/story/transitions.py</files>
  <action>
Create transition generation between chapters:

```python
"""Chapter transitions and pacing for Code Story."""

from typing import Any
from backend.skills.decorators import skill
from backend.skills.story.styles import NarrativeStyle


TRANSITION_TEMPLATES = {
    NarrativeStyle.FICTION: [
        "[PAUSE 2s] And so our story continues... [PAUSE 1s]",
        "[PAUSE 2s] But the adventure was far from over... [PAUSE 1s]",
        "[PAUSE 2s] With newfound knowledge, we press on... [PAUSE 1s]",
    ],
    NarrativeStyle.DOCUMENTARY: [
        "[PAUSE 2s] Let's examine the next component... [PAUSE 1s]",
        "[PAUSE 2s] Moving deeper into the architecture... [PAUSE 1s]",
        "[PAUSE 2s] Another fascinating aspect emerges... [PAUSE 1s]",
    ],
    NarrativeStyle.TUTORIAL: [
        "[PAUSE 2s] Great progress! Now let's explore... [PAUSE 1s]",
        "[PAUSE 2s] Building on what we learned... [PAUSE 1s]",
        "[PAUSE 2s] Ready for the next step? Here we go... [PAUSE 1s]",
    ],
    NarrativeStyle.PODCAST: [
        "[PAUSE 2s] Alright, moving on to something cool... [PAUSE 1s]",
        "[PAUSE 2s] But wait, there's more... [PAUSE 1s]",
        "[PAUSE 2s] So here's where it gets interesting... [PAUSE 1s]",
    ],
    NarrativeStyle.TECHNICAL: [
        "[PAUSE 2s] The next section covers... [PAUSE 1s]",
        "[PAUSE 2s] Proceeding to the following component... [PAUSE 1s]",
        "[PAUSE 2s] See also the related functionality... [PAUSE 1s]",
    ],
}


@skill(
    name="generate_transitions",
    description="Generate transitions between chapters",
)
async def generate_transitions(
    chapters: list[dict[str, Any]],
    style: str = "documentary",
) -> list[dict[str, str]]:
    """Generate transitions for chapter list."""
    style_enum = NarrativeStyle(style)
    templates = TRANSITION_TEMPLATES.get(style_enum, TRANSITION_TEMPLATES[NarrativeStyle.DOCUMENTARY])
    
    transitions = []
    for i in range(len(chapters) - 1):
        transitions.append({
            "from_chapter": i + 1,
            "to_chapter": i + 2,
            "transition_text": templates[i % len(templates)],
        })
    
    return transitions


@skill(
    name="calculate_pacing",
    description="Calculate pacing for audio synthesis",
)
async def calculate_pacing(
    chapters: list[dict[str, Any]],
) -> dict[str, Any]:
    """Calculate pacing metrics for chapters."""
    total_words = sum(c.get("word_count", 0) for c in chapters)
    total_duration = sum(c.get("duration_estimate_seconds", 0) for c in chapters)
    
    # Add transition time (~5 seconds each)
    transition_time = (len(chapters) - 1) * 5
    
    return {
        "total_words": total_words,
        "total_duration_seconds": total_duration + transition_time,
        "total_duration_minutes": (total_duration + transition_time) / 60,
        "average_words_per_chapter": total_words // len(chapters) if chapters else 0,
        "chapter_count": len(chapters),
        "transition_count": len(chapters) - 1,
    }
```
  </action>
  <verify>python -c "from codestory.backend.skills.story.transitions import generate_transitions; print('Transitions OK')"</verify>
  <done>Transitions created</done>
</task>

</tasks>

<playwright_validation_gate>
```
# Pacing is validated as part of story generation
Assert: story.total_duration_minutes > 0
```
</playwright_validation_gate>
