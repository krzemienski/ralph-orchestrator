---
phase: 04-story-architect
plan: 02
type: execute
domain: python-api
---

<objective>
Implement chapter script generation skill with pacing and voice synthesis directions.

Purpose: Generate chapter scripts from repository analysis using narrative styles.
Output: Script generation skill with voice markers and pacing controls.
</objective>

<context>
@BRIEF.md
@codestory/backend/skills/story/styles.py
@codestory/backend/skills/analysis/extractor.py
</context>

<tasks>

<task type="auto">
  <n>Task 1: Create chapter script generation skill</n>
  <files>codestory/backend/skills/story/chapters.py</files>
  <action>
Create script generation with voice markers:

```python
"""Chapter script generation for Code Story."""

from dataclasses import dataclass, field
from typing import Any

from anthropic import Anthropic

from backend.core.config import get_settings
from backend.skills.decorators import skill
from backend.skills.story.styles import (
    NarrativeStyle,
    ExpertiseLevel,
    get_style_prompt,
    get_chapter_template,
)


@dataclass
class ChapterScript:
    """Generated chapter script."""
    chapter_number: int
    title: str
    script: str
    duration_estimate_seconds: int
    voice_directions: dict[str, str]
    word_count: int


@dataclass
class StoryOutline:
    """Complete story outline with chapters."""
    title: str
    style: NarrativeStyle
    chapters: list[ChapterScript]
    total_duration_estimate: int
    total_word_count: int


SCRIPT_GENERATION_PROMPT = '''Generate a chapter script for a code story.

## Story Context
Repository: {repo_name}
Style: {style}
Expertise Level: {expertise}

## Repository Analysis
{analysis_summary}

## Chapter Information
Chapter {chapter_number}: {chapter_title}
Focus: {chapter_focus}

## Requirements
1. Write engaging narration in the {style} style
2. Include voice markers: [PAUSE], [EMPHASIS], [SLOWER], [FASTER]
3. Target length: {target_words} words
4. Make technical concepts accessible for {expertise} audience

## Previous Chapters Summary
{previous_summary}

Write the complete chapter script. Use voice markers naturally.'''


@skill(
    name="generate_chapter_script",
    description="Generate a single chapter script from analysis",
)
async def generate_chapter_script(
    analysis: dict[str, Any],
    chapter_number: int,
    chapter_title: str,
    chapter_focus: str,
    style: str = "documentary",
    expertise: str = "intermediate",
    target_words: int = 500,
    previous_summary: str = "",
) -> dict[str, Any]:
    """Generate a chapter script."""
    settings = get_settings()
    client = Anthropic()
    
    # Build analysis summary
    analysis_data = analysis.get("analysis", analysis)
    analysis_summary = f"""
Architecture: {analysis_data.get('architecture_pattern', 'unknown')}
Description: {analysis_data.get('architecture_description', 'N/A')}
Key Components: {', '.join(c.get('name', '') for c in analysis_data.get('core_modules', [])[:5])}
Frameworks: {', '.join(analysis_data.get('frameworks', []))}
"""
    
    prompt = SCRIPT_GENERATION_PROMPT.format(
        repo_name=analysis_data.get('name', 'Repository'),
        style=style,
        expertise=expertise,
        analysis_summary=analysis_summary,
        chapter_number=chapter_number,
        chapter_title=chapter_title,
        chapter_focus=chapter_focus,
        target_words=target_words,
        previous_summary=previous_summary or "This is the first chapter.",
    )
    
    response = client.messages.create(
        model=settings.claude_model,
        max_tokens=2000,
        system=get_style_prompt(style, expertise),
        messages=[{"role": "user", "content": prompt}],
    )
    
    script_text = response.content[0].text
    word_count = len(script_text.split())
    
    # Estimate duration (~150 words per minute for narration)
    duration_seconds = int((word_count / 150) * 60)
    
    return {
        "chapter_number": chapter_number,
        "title": chapter_title,
        "script": script_text,
        "word_count": word_count,
        "duration_estimate_seconds": duration_seconds,
        "voice_directions": {
            "style": style,
            "expertise": expertise,
        },
    }


@skill(
    name="generate_story_outline",
    description="Generate complete story outline with all chapters",
)
async def generate_story_outline(
    analysis: dict[str, Any],
    style: str = "documentary",
    expertise: str = "intermediate",
    custom_chapters: list[str] | None = None,
) -> dict[str, Any]:
    """Generate complete story with all chapters."""
    chapters = custom_chapters or get_chapter_template(style)
    
    story_chapters = []
    previous_summary = ""
    total_words = 0
    total_duration = 0
    
    for i, chapter_title in enumerate(chapters, 1):
        chapter = await generate_chapter_script(
            analysis=analysis,
            chapter_number=i,
            chapter_title=chapter_title,
            chapter_focus=f"Focus on {chapter_title.split(' - ')[-1] if ' - ' in chapter_title else chapter_title}",
            style=style,
            expertise=expertise,
            previous_summary=previous_summary,
        )
        
        story_chapters.append(chapter)
        total_words += chapter["word_count"]
        total_duration += chapter["duration_estimate_seconds"]
        
        # Build summary for next chapter
        previous_summary = f"Chapter {i} covered: {chapter_title}"
    
    analysis_data = analysis.get("analysis", analysis)
    
    return {
        "title": f"{analysis_data.get('name', 'Repository')} - A {style.title()} Story",
        "style": style,
        "expertise": expertise,
        "chapters": story_chapters,
        "total_chapters": len(story_chapters),
        "total_word_count": total_words,
        "total_duration_estimate": total_duration,
    }
```
  </action>
  <verify>python -c "from codestory.backend.skills.story.chapters import generate_chapter_script; print('Chapters OK')"</verify>
  <done>Chapter generation imports</done>
</task>

<task type="auto">
  <n>Task 2: Update story package exports</n>
  <files>codestory/backend/skills/story/__init__.py</files>
  <action>
Add chapter exports to story package.
  </action>
  <verify>python -c "from codestory.backend.skills.story import generate_story_outline; print('Exports OK')"</verify>
  <done>Exports updated</done>
</task>

</tasks>

<playwright_validation_gate>
```
# Test via story endpoint (after API creation)
Playwright Action: HTTP POST /story/generate-outline
Body: {"analysis": {...}, "style": "documentary"}
Expected: 200 OK
Assert: response.json().chapters.length > 0
```
</playwright_validation_gate>
