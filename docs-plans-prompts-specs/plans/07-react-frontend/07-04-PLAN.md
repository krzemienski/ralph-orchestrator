---
phase: 07-react-frontend
plan: 04
type: execute
domain: react-frontend
---

<objective>
Create chat interface for Custom mode intent gathering with real-time streaming responses from Intent Agent.
</objective>

<context>
@BRIEF.md
@codestory/frontend/src/lib/api.ts
@codestory/backend/agents/intent_agent.py
</context>

<tasks>

<task type="auto">
  <n>Task 1: Create chat interface component</n>
  <files>codestory/frontend/src/pages/IntentChat.tsx</files>
  <action>
Create intent conversation page:

```tsx
import { useState, useEffect, useRef } from "react";
import { useParams, useNavigate } from "react-router-dom";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Send, Loader2, ArrowRight, User, Bot } from "lucide-react";
import { api } from "@/lib/api";

interface Message {
  id: string;
  role: "user" | "assistant";
  content: string;
  timestamp: Date;
}

export function IntentChat() {
  const { storyId } = useParams<{ storyId: string }>();
  const [messages, setMessages] = useState<Message[]>([]);
  const [input, setInput] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const [isComplete, setIsComplete] = useState(false);
  const [storyPlan, setStoryPlan] = useState<any>(null);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const navigate = useNavigate();

  useEffect(() => {
    loadConversation();
  }, [storyId]);

  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  async function loadConversation() {
    try {
      const response = await api.get(`/stories/${storyId}/intent`);
      const { messages: history, is_complete, story_plan } = response.data;
      
      setMessages(history.map((m: any) => ({
        id: m.id,
        role: m.role,
        content: m.content,
        timestamp: new Date(m.timestamp),
      })));
      
      setIsComplete(is_complete);
      setStoryPlan(story_plan);

      // Start conversation if no messages yet
      if (history.length === 0) {
        await sendMessage("", true);
      }
    } catch (error) {
      console.error("Failed to load conversation:", error);
    }
  }

  async function sendMessage(content: string, isInitial = false) {
    if (!isInitial && !content.trim()) return;

    const userMessage: Message = {
      id: Date.now().toString(),
      role: "user",
      content: content.trim(),
      timestamp: new Date(),
    };

    if (!isInitial) {
      setMessages((prev) => [...prev, userMessage]);
    }
    
    setInput("");
    setIsLoading(true);

    try {
      const response = await api.post(`/stories/${storyId}/intent/message`, {
        content: isInitial ? "" : content.trim(),
        is_initial: isInitial,
      });

      const { assistant_message, is_complete, story_plan } = response.data;

      const assistantMessage: Message = {
        id: (Date.now() + 1).toString(),
        role: "assistant",
        content: assistant_message,
        timestamp: new Date(),
      };

      setMessages((prev) => [...prev, assistantMessage]);
      setIsComplete(is_complete);
      setStoryPlan(story_plan);
    } catch (error) {
      console.error("Failed to send message:", error);
    } finally {
      setIsLoading(false);
    }
  }

  async function handleProceed() {
    try {
      await api.post(`/stories/${storyId}/intent/finalize`);
      navigate(`/stories/${storyId}/progress`);
    } catch (error) {
      console.error("Failed to finalize:", error);
    }
  }

  function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    sendMessage(input);
  }

  return (
    <div className="min-h-screen bg-slate-900 flex flex-col">
      {/* Header */}
      <header className="bg-slate-800 border-b border-slate-700 px-4 py-4">
        <div className="max-w-3xl mx-auto">
          <h1 className="text-xl font-semibold text-white">Tell us about your goals</h1>
          <p className="text-slate-400 text-sm">
            Help us understand what you want to learn from this codebase
          </p>
        </div>
      </header>

      {/* Messages */}
      <div className="flex-1 overflow-y-auto py-6">
        <div className="max-w-3xl mx-auto px-4 space-y-6">
          {messages.map((message) => (
            <ChatMessage key={message.id} message={message} />
          ))}
          
          {isLoading && (
            <div className="flex items-start gap-3">
              <div className="w-8 h-8 rounded-full bg-indigo-600 flex items-center justify-center">
                <Bot className="h-4 w-4 text-white" />
              </div>
              <div className="bg-slate-800 rounded-lg px-4 py-3">
                <Loader2 className="h-5 w-5 animate-spin text-slate-400" />
              </div>
            </div>
          )}

          {isComplete && storyPlan && (
            <StoryPlanPreview plan={storyPlan} onProceed={handleProceed} />
          )}
          
          <div ref={messagesEndRef} />
        </div>
      </div>

      {/* Input */}
      {!isComplete && (
        <div className="bg-slate-800 border-t border-slate-700 p-4">
          <form onSubmit={handleSubmit} className="max-w-3xl mx-auto flex gap-3">
            <Input
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder="Type your response..."
              disabled={isLoading}
              className="flex-1 bg-slate-700 border-slate-600 text-white"
            />
            <Button 
              type="submit" 
              disabled={isLoading || !input.trim()}
              className="bg-indigo-600 hover:bg-indigo-500"
            >
              <Send className="h-4 w-4" />
            </Button>
          </form>
        </div>
      )}
    </div>
  );
}

function ChatMessage({ message }: { message: Message }) {
  const isUser = message.role === "user";

  return (
    <div className={`flex items-start gap-3 ${isUser ? "flex-row-reverse" : ""}`}>
      <div className={`
        w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0
        ${isUser ? "bg-slate-600" : "bg-indigo-600"}
      `}>
        {isUser ? <User className="h-4 w-4 text-white" /> : <Bot className="h-4 w-4 text-white" />}
      </div>
      <div className={`
        max-w-[80%] rounded-lg px-4 py-3
        ${isUser ? "bg-indigo-600 text-white" : "bg-slate-800 text-slate-200"}
      `}>
        <p className="whitespace-pre-wrap">{message.content}</p>
      </div>
    </div>
  );
}

function StoryPlanPreview({ plan, onProceed }: { plan: any; onProceed: () => void }) {
  return (
    <div className="bg-slate-800 rounded-xl p-6 border border-indigo-500/50">
      <h3 className="text-lg font-semibold text-white mb-4">Your Story Plan</h3>
      
      <div className="space-y-4 mb-6">
        <div>
          <span className="text-slate-400 text-sm">Style:</span>
          <span className="ml-2 text-white capitalize">{plan.style}</span>
        </div>
        <div>
          <span className="text-slate-400 text-sm">Estimated Duration:</span>
          <span className="ml-2 text-white">{plan.estimated_duration_minutes} minutes</span>
        </div>
        <div>
          <span className="text-slate-400 text-sm block mb-2">Chapters:</span>
          <ol className="space-y-2">
            {plan.chapters?.map((chapter: any, i: number) => (
              <li key={i} className="text-slate-300 text-sm flex items-start gap-2">
                <span className="text-indigo-400 font-mono">{i + 1}.</span>
                {chapter.title}
              </li>
            ))}
          </ol>
        </div>
      </div>

      <Button onClick={onProceed} className="w-full bg-indigo-600 hover:bg-indigo-500">
        Generate My Story <ArrowRight className="ml-2 h-4 w-4" />
      </Button>
    </div>
  );
}
```
  </action>
  <verify>Check chat interface renders</verify>
  <done>Intent chat interface created</done>
</task>

<task type="auto">
  <n>Task 2: Add streaming support hook</n>
  <files>codestory/frontend/src/hooks/useStreaming.ts</files>
  <action>
Create streaming response hook:

```typescript
import { useState, useCallback } from "react";

interface StreamingOptions {
  onChunk?: (chunk: string) => void;
  onComplete?: (fullResponse: string) => void;
  onError?: (error: Error) => void;
}

export function useStreaming(baseUrl: string) {
  const [isStreaming, setIsStreaming] = useState(false);
  const [streamedContent, setStreamedContent] = useState("");

  const startStream = useCallback(async (
    endpoint: string,
    body: any,
    options: StreamingOptions = {}
  ) => {
    setIsStreaming(true);
    setStreamedContent("");

    const token = localStorage.getItem("token");
    
    try {
      const response = await fetch(`${baseUrl}${endpoint}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`,
        },
        body: JSON.stringify(body),
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const reader = response.body?.getReader();
      if (!reader) throw new Error("No response body");

      const decoder = new TextDecoder();
      let fullResponse = "";

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        const chunk = decoder.decode(value, { stream: true });
        fullResponse += chunk;
        setStreamedContent(fullResponse);
        options.onChunk?.(chunk);
      }

      options.onComplete?.(fullResponse);
      return fullResponse;

    } catch (error) {
      const err = error instanceof Error ? error : new Error(String(error));
      options.onError?.(err);
      throw err;
    } finally {
      setIsStreaming(false);
    }
  }, [baseUrl]);

  const stopStream = useCallback(() => {
    setIsStreaming(false);
  }, []);

  return {
    isStreaming,
    streamedContent,
    startStream,
    stopStream,
  };
}
```
  </action>
  <verify>Check streaming hook compiles</verify>
  <done>Streaming support hook created</done>
</task>

</tasks>

<playwright_validation_gate>
```
# Navigate to intent chat
Playwright Action: Create story with Custom mode
Expected: Redirect to /stories/{id}/intent

# Receive initial assistant message
Expected: Assistant message appears asking about goals

# Send user message
Playwright Action: Type "I want to understand the architecture" and send
Expected: User message appears, loading indicator, assistant response

# Complete conversation
Playwright Action: Continue conversation until story plan appears
Expected: Story plan preview with chapters and "Generate" button

# Proceed to generation
Playwright Action: Click "Generate My Story"
Expected: Redirect to /stories/{id}/progress
```
</playwright_validation_gate>
