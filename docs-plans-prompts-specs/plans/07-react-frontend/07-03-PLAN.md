---
phase: 07-react-frontend
plan: 03
type: execute
domain: react-frontend
---

<objective>
Create repository input page with GitHub URL validation and Quick/Custom mode selection interface.
</objective>

<context>
@BRIEF.md
@codestory/frontend/src/lib/api.ts
@codestory/frontend/src/hooks/useAuth.tsx
</context>

<tasks>

<task type="auto">
  <n>Task 1: Create new story page</n>
  <files>codestory/frontend/src/pages/NewStory.tsx</files>
  <action>
Create new story page with URL input:

```tsx
import { useState } from "react";
import { useNavigate } from "react-router-dom";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { RadioGroup, RadioGroupItem } from "@/components/ui/radio-group";
import { Github, Zap, MessageSquare, ArrowRight, Loader2, AlertCircle } from "lucide-react";
import { api } from "@/lib/api";

const GITHUB_URL_REGEX = /^https?:\/\/(www\.)?github\.com\/[\w-]+\/[\w.-]+\/?$/;

export function NewStory() {
  const [repoUrl, setRepoUrl] = useState("");
  const [mode, setMode] = useState<"quick" | "custom">("quick");
  const [expertiseLevel, setExpertiseLevel] = useState("intermediate");
  const [style, setStyle] = useState("documentary");
  const [error, setError] = useState("");
  const [isLoading, setIsLoading] = useState(false);
  const navigate = useNavigate();

  function validateUrl(url: string): boolean {
    return GITHUB_URL_REGEX.test(url.trim());
  }

  async function handleSubmit(e: React.FormEvent) {
    e.preventDefault();
    setError("");

    if (!validateUrl(repoUrl)) {
      setError("Please enter a valid GitHub repository URL");
      return;
    }

    setIsLoading(true);

    try {
      const response = await api.post("/stories", {
        repository_url: repoUrl.trim(),
        mode,
        expertise_level: expertiseLevel,
        style,
      });

      const { story_id } = response.data;

      if (mode === "custom") {
        navigate(`/stories/${story_id}/intent`);
      } else {
        navigate(`/stories/${story_id}/progress`);
      }
    } catch (err: any) {
      setError(err.response?.data?.detail || "Failed to create story");
    } finally {
      setIsLoading(false);
    }
  }

  return (
    <div className="min-h-screen bg-slate-900 py-12 px-4">
      <div className="max-w-2xl mx-auto">
        <h1 className="text-3xl font-bold text-white mb-2">Create New Story</h1>
        <p className="text-slate-400 mb-8">
          Transform a GitHub repository into an audio narrative
        </p>

        {error && (
          <div className="bg-red-500/10 border border-red-500/20 text-red-400 px-4 py-3 rounded-lg mb-6 flex items-center gap-2">
            <AlertCircle className="h-5 w-5 flex-shrink-0" />
            {error}
          </div>
        )}

        <form onSubmit={handleSubmit} className="space-y-8">
          {/* Repository URL */}
          <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
            <Label className="text-lg text-white mb-4 block">
              <Github className="inline h-5 w-5 mr-2" />
              GitHub Repository
            </Label>
            <Input
              type="url"
              value={repoUrl}
              onChange={(e) => setRepoUrl(e.target.value)}
              placeholder="https://github.com/owner/repository"
              required
              className="bg-slate-700 border-slate-600 text-white text-lg py-6"
            />
            <p className="text-slate-500 text-sm mt-2">
              Enter a public GitHub repository URL
            </p>
          </div>

          {/* Mode Selection */}
          <div className="bg-slate-800 rounded-xl p-6 border border-slate-700">
            <Label className="text-lg text-white mb-4 block">Generation Mode</Label>
            <RadioGroup value={mode} onValueChange={(v) => setMode(v as "quick" | "custom")}>
              <div className="grid md:grid-cols-2 gap-4">
                <ModeCard
                  value="quick"
                  selected={mode === "quick"}
                  icon={<Zap className="h-6 w-6" />}
                  title="Quick Mode"
                  description="Fast generation with smart defaults. Great for exploring new codebases."
                />
                <ModeCard
                  value="custom"
                  selected={mode === "custom"}
                  icon={<MessageSquare className="h-6 w-6" />}
                  title="Custom Mode"
                  description="Guided conversation to tailor the story to your specific needs."
                />
              </div>
            </RadioGroup>
          </div>

          {/* Quick Mode Options */}
          {mode === "quick" && (
            <div className="bg-slate-800 rounded-xl p-6 border border-slate-700 space-y-6">
              <div>
                <Label className="text-white mb-3 block">Your Expertise Level</Label>
                <RadioGroup value={expertiseLevel} onValueChange={setExpertiseLevel}>
                  <div className="flex flex-wrap gap-3">
                    <ExpertiseOption value="beginner" label="Beginner" selected={expertiseLevel === "beginner"} />
                    <ExpertiseOption value="intermediate" label="Intermediate" selected={expertiseLevel === "intermediate"} />
                    <ExpertiseOption value="advanced" label="Advanced" selected={expertiseLevel === "advanced"} />
                  </div>
                </RadioGroup>
              </div>

              <div>
                <Label className="text-white mb-3 block">Narrative Style</Label>
                <RadioGroup value={style} onValueChange={setStyle}>
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                    <StyleOption value="documentary" label="Documentary" selected={style === "documentary"} />
                    <StyleOption value="tutorial" label="Tutorial" selected={style === "tutorial"} />
                    <StyleOption value="podcast" label="Podcast" selected={style === "podcast"} />
                    <StyleOption value="fiction" label="Fiction" selected={style === "fiction"} />
                    <StyleOption value="technical" label="Technical" selected={style === "technical"} />
                  </div>
                </RadioGroup>
              </div>
            </div>
          )}

          <Button
            type="submit"
            size="lg"
            className="w-full bg-indigo-600 hover:bg-indigo-500 text-lg py-6"
            disabled={isLoading}
          >
            {isLoading ? (
              <Loader2 className="h-5 w-5 animate-spin" />
            ) : (
              <>
                {mode === "quick" ? "Generate Story" : "Start Conversation"}
                <ArrowRight className="ml-2 h-5 w-5" />
              </>
            )}
          </Button>
        </form>
      </div>
    </div>
  );
}

function ModeCard({ value, selected, icon, title, description }: {
  value: string;
  selected: boolean;
  icon: React.ReactNode;
  title: string;
  description: string;
}) {
  return (
    <label className={`
      flex items-start gap-4 p-4 rounded-lg border-2 cursor-pointer transition-all
      ${selected 
        ? "border-indigo-500 bg-indigo-500/10" 
        : "border-slate-600 hover:border-slate-500"}
    `}>
      <RadioGroupItem value={value} className="mt-1" />
      <div>
        <div className={`mb-1 ${selected ? "text-indigo-400" : "text-slate-400"}`}>
          {icon}
        </div>
        <div className="font-medium text-white">{title}</div>
        <div className="text-sm text-slate-400">{description}</div>
      </div>
    </label>
  );
}

function ExpertiseOption({ value, label, selected }: { value: string; label: string; selected: boolean }) {
  return (
    <label className={`
      px-4 py-2 rounded-lg border cursor-pointer transition-all
      ${selected 
        ? "border-indigo-500 bg-indigo-500/20 text-indigo-300" 
        : "border-slate-600 text-slate-400 hover:border-slate-500"}
    `}>
      <RadioGroupItem value={value} className="sr-only" />
      {label}
    </label>
  );
}

function StyleOption({ value, label, selected }: { value: string; label: string; selected: boolean }) {
  return (
    <label className={`
      px-4 py-2 rounded-lg border cursor-pointer transition-all text-center
      ${selected 
        ? "border-indigo-500 bg-indigo-500/20 text-indigo-300" 
        : "border-slate-600 text-slate-400 hover:border-slate-500"}
    `}>
      <RadioGroupItem value={value} className="sr-only" />
      {label}
    </label>
  );
}
```
  </action>
  <verify>Check new story page renders</verify>
  <done>New story page created</done>
</task>

<task type="auto">
  <n>Task 2: Add URL validation utility</n>
  <files>codestory/frontend/src/lib/validation.ts</files>
  <action>
Create validation utilities:

```typescript
/**
 * Validation utilities for Code Story frontend.
 */

export const GITHUB_URL_REGEX = /^https?:\/\/(www\.)?github\.com\/[\w-]+\/[\w.-]+\/?$/;

export function isValidGitHubUrl(url: string): boolean {
  return GITHUB_URL_REGEX.test(url.trim());
}

export function parseGitHubUrl(url: string): { owner: string; repo: string } | null {
  const match = url.match(/github\.com\/([\w-]+)\/([\w.-]+)/);
  if (!match) return null;
  return { owner: match[1], repo: match[2].replace(/\/$/, "") };
}

export function isValidEmail(email: string): boolean {
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

export function isValidPassword(password: string): { valid: boolean; errors: string[] } {
  const errors: string[] = [];
  
  if (password.length < 8) {
    errors.push("Password must be at least 8 characters");
  }
  
  return { valid: errors.length === 0, errors };
}
```
  </action>
  <verify>Check validation utilities work</verify>
  <done>Validation utilities created</done>
</task>

</tasks>

<playwright_validation_gate>
```
# Navigate to new story page
Playwright Action: Click "New Story" in dashboard
Expected: Navigate to /new

# Invalid URL validation
Playwright Action: Enter "not-a-url" and submit
Expected: Error message "Please enter a valid GitHub repository URL"

# Valid URL - Quick mode
Playwright Action: Enter "https://github.com/facebook/react", select Quick, submit
Expected: Redirect to /stories/{id}/progress

# Valid URL - Custom mode
Playwright Action: Enter URL, select Custom, submit
Expected: Redirect to /stories/{id}/intent
```
</playwright_validation_gate>
