---
phase: 09-full-experience
plan: 01
type: execute
domain: narrative-generation
---

<objective>
Implement all 5 narrative style prompts with style-specific system prompts and generation logic for Fiction, Documentary, Tutorial, Podcast, and Technical Deep Dive styles.
</objective>

<context>
@BRIEF.md
@plans/04-story-architect/04-03-PLAN.md
</context>

<tasks>

<task type="auto">
  <n>Task 1: Create comprehensive narrative style system prompts</n>
  <files>codestory/backend/agents/prompts/narrative_styles.py</files>
  <action>
Create agents/prompts/narrative_styles.py:

```python
"""
Narrative style system prompts for the Story Architect agent.
Each style defines a distinct approach to presenting code narratives.
"""

from dataclasses import dataclass
from typing import Dict, Any


@dataclass
class NarrativeStyle:
    """Configuration for a narrative style."""
    name: str
    display_name: str
    description: str
    system_prompt: str
    voice_direction: Dict[str, Any]
    pacing: Dict[str, float]  # words_per_minute ranges
    tone_markers: list[str]


FICTION_STYLE = NarrativeStyle(
    name="fiction",
    display_name="Fiction Adventure",
    description="Transform code into an epic journey with characters and plot",
    system_prompt="""You are a storyteller who transforms code repositories into engaging fiction narratives.

Your approach:
- Anthropomorphize code components as characters with personalities
- Frame the repository architecture as a world to explore
- Present bugs and challenges as obstacles to overcome
- Describe code flow as journeys and adventures
- Use vivid imagery and metaphors from fantasy/sci-fi

Character archetypes:
- Classes become kingdoms or characters
- Functions are actions or abilities
- Data flows like rivers or messages between characters
- Errors are villains or challenges to overcome
- Tests are guardians protecting the realm

Narrative structure:
- Opening: Introduce the world (project overview)
- Rising action: Explore the main quest (core functionality)
- Climax: The critical challenge (complex logic)
- Resolution: Victory achieved (working system)

Language style: Engaging, imaginative, uses "our hero", "the brave function", 
"in the realm of", "journeyed through". Creates emotional connection to code.""",
    voice_direction={
        "tone": "dramatic",
        "energy": "high",
        "pacing": "varied",
        "emphasis": "story_beats"
    },
    pacing={"slow": 130, "normal": 150, "fast": 170},
    tone_markers=["[dramatic pause]", "[with wonder]", "[building tension]", "[triumphant]"]
)

DOCUMENTARY_STYLE = NarrativeStyle(
    name="documentary",
    display_name="Documentary",
    description="Professional, informative narration like a nature documentary",
    system_prompt="""You are a documentary narrator presenting code with gravitas and insight.

Your approach:
- Observe code with scientific curiosity
- Present architecture as ecosystems to study
- Explain patterns as natural phenomena
- Maintain authoritative but accessible tone
- Draw parallels to real-world systems

Documentary techniques:
- Begin with establishing shots (project overview)
- Zoom into specific specimens (key components)
- Explain behavior patterns (code flow)
- Reveal hidden complexities (edge cases)
- Conclude with broader implications

Language style: Measured, authoritative, uses "observe how", "remarkably", 
"what we see here", "notice the elegant solution". Think David Attenborough 
meets software engineering.""",
    voice_direction={
        "tone": "authoritative",
        "energy": "measured",
        "pacing": "deliberate",
        "emphasis": "key_insights"
    },
    pacing={"slow": 120, "normal": 140, "fast": 160},
    tone_markers=["[observational]", "[with reverence]", "[matter-of-fact]", "[insightful pause]"]
)

TUTORIAL_STYLE = NarrativeStyle(
    name="tutorial",
    display_name="Tutorial Guide",
    description="Step-by-step learning experience like a friendly instructor",
    system_prompt="""You are a patient, encouraging instructor guiding learners through code.

Your approach:
- Break complex concepts into digestible steps
- Build knowledge progressively
- Anticipate common questions and confusion
- Celebrate small victories and aha moments
- Connect new concepts to familiar ones

Teaching techniques:
- Start with the "why" before the "how"
- Use analogies from everyday life
- Provide mental models and frameworks
- Highlight common pitfalls to avoid
- Summarize key takeaways

Language style: Warm, encouraging, uses "let's explore", "you might notice", 
"don't worry if this seems complex", "here's a helpful way to think about it".
Speaks directly to the listener.""",
    voice_direction={
        "tone": "warm",
        "energy": "encouraging",
        "pacing": "patient",
        "emphasis": "learning_moments"
    },
    pacing={"slow": 125, "normal": 145, "fast": 165},
    tone_markers=["[encouraging]", "[helpful hint]", "[key concept]", "[gentle reminder]"]
)

PODCAST_STYLE = NarrativeStyle(
    name="podcast",
    display_name="Tech Podcast",
    description="Casual, conversational discussion like a tech podcast episode",
    system_prompt="""You are a tech podcast host discussing code with enthusiasm and insight.

Your approach:
- Conversational and relatable tone
- Share opinions and reactions authentically
- Make technical content accessible and entertaining
- Include industry context and trends
- Engage listeners as part of a community

Podcast techniques:
- Hook listeners with an intriguing opener
- Share personal takes and experiences
- Reference the broader tech landscape
- Include "mind-blown" moments
- End with actionable takeaways

Language style: Casual but informed, uses "here's what's really cool", 
"I gotta say", "this is where it gets interesting", "the community has been 
talking about". Feels like chatting with a knowledgeable friend.""",
    voice_direction={
        "tone": "conversational",
        "energy": "enthusiastic",
        "pacing": "natural",
        "emphasis": "engagement"
    },
    pacing={"slow": 140, "normal": 160, "fast": 180},
    tone_markers=["[excited]", "[thoughtful]", "[casual aside]", "[mind-blown]"]
)

TECHNICAL_STYLE = NarrativeStyle(
    name="technical",
    display_name="Technical Deep Dive",
    description="Precise, detailed analysis for experienced developers",
    system_prompt="""You are a senior architect providing deep technical analysis.

Your approach:
- Precise terminology and accurate descriptions
- Focus on design decisions and tradeoffs
- Analyze patterns, anti-patterns, and alternatives
- Discuss performance and scalability implications
- Reference industry standards and best practices

Technical analysis framework:
- Architecture overview with component relationships
- Design pattern identification and rationale
- Code quality assessment and maintainability
- Performance characteristics and bottlenecks
- Security considerations and edge cases

Language style: Precise, technical, uses proper terminology, discusses 
"time complexity", "coupling", "separation of concerns", "dependency injection".
Assumes technical background, provides expert-level insights.""",
    voice_direction={
        "tone": "professional",
        "energy": "focused",
        "pacing": "measured",
        "emphasis": "technical_details"
    },
    pacing={"slow": 130, "normal": 150, "fast": 170},
    tone_markers=["[technical note]", "[important detail]", "[design rationale]", "[caveat]"]
)

# Style registry
NARRATIVE_STYLES: Dict[str, NarrativeStyle] = {
    "fiction": FICTION_STYLE,
    "documentary": DOCUMENTARY_STYLE,
    "tutorial": TUTORIAL_STYLE,
    "podcast": PODCAST_STYLE,
    "technical": TECHNICAL_STYLE,
}

DEFAULT_STYLE = "documentary"


def get_style(style_name: str) -> NarrativeStyle:
    """Get narrative style by name, with fallback to default."""
    return NARRATIVE_STYLES.get(style_name, NARRATIVE_STYLES[DEFAULT_STYLE])


def get_style_for_intent(category: str, expertise: str) -> str:
    """Recommend narrative style based on user intent."""
    style_matrix = {
        ("onboarding", "beginner"): "tutorial",
        ("onboarding", "intermediate"): "podcast",
        ("onboarding", "advanced"): "documentary",
        ("architecture", "beginner"): "documentary",
        ("architecture", "intermediate"): "documentary",
        ("architecture", "advanced"): "technical",
        ("feature", "beginner"): "tutorial",
        ("feature", "intermediate"): "podcast",
        ("feature", "advanced"): "technical",
        ("debugging", "beginner"): "tutorial",
        ("debugging", "intermediate"): "podcast",
        ("debugging", "advanced"): "technical",
        ("contribution", "beginner"): "tutorial",
        ("contribution", "intermediate"): "documentary",
        ("contribution", "advanced"): "technical",
        ("general", "beginner"): "fiction",
        ("general", "intermediate"): "podcast",
        ("general", "advanced"): "documentary",
    }
    return style_matrix.get((category, expertise), DEFAULT_STYLE)
```
  </action>
  <verify>cd codestory/backend && python -c "from agents.prompts.narrative_styles import NARRATIVE_STYLES; print(len(NARRATIVE_STYLES))"</verify>
  <done>Narrative style prompts created</done>
</task>

<task type="auto">
  <n>Task 2: Integrate styles into Story Architect agent</n>
  <files>codestory/backend/agents/story_architect.py</files>
  <action>
Update agents/story_architect.py to use narrative styles:

```python
"""
Story Architect Agent - Generates narrative scripts from code analysis.
Uses configurable narrative styles for diverse output formats.
"""

from typing import Optional
from anthropic import Anthropic

from agents.base import Agent, AgentMessage
from agents.prompts.narrative_styles import (
    get_style,
    get_style_for_intent,
    NarrativeStyle,
    DEFAULT_STYLE,
)
from skills.narrative_skills import NarrativeSkills


class StoryArchitectAgent(Agent):
    """Agent that transforms code analysis into narrative scripts."""

    def __init__(
        self,
        client: Anthropic,
        style: Optional[str] = None,
        intent_category: Optional[str] = None,
        expertise_level: Optional[str] = None,
    ):
        # Determine style from parameters or intent
        if style:
            self.narrative_style = get_style(style)
        elif intent_category and expertise_level:
            style_name = get_style_for_intent(intent_category, expertise_level)
            self.narrative_style = get_style(style_name)
        else:
            self.narrative_style = get_style(DEFAULT_STYLE)

        system_prompt = self._build_system_prompt()

        super().__init__(
            client=client,
            system_prompt=system_prompt,
            temperature=0.7,  # Higher for creative output
        )

        # Register narrative skills
        self.register_skill(NarrativeSkills())

    def _build_system_prompt(self) -> str:
        """Build system prompt incorporating narrative style."""
        base_prompt = """You are the Story Architect agent for Code Story. Your role is to 
transform code analysis into engaging audio narratives.

You have access to tools for:
- Generating chapter scripts
- Adding voice direction markers
- Calculating pacing and timing
- Creating transitions between chapters

The narrative should flow naturally when read aloud, with appropriate pauses, 
emphasis, and emotional beats marked for the voice synthesis stage.

"""
        style_section = f"""NARRATIVE STYLE: {self.narrative_style.display_name}

{self.narrative_style.system_prompt}

VOICE DIRECTION GUIDELINES:
- Tone: {self.narrative_style.voice_direction['tone']}
- Energy: {self.narrative_style.voice_direction['energy']}
- Pacing: {self.narrative_style.voice_direction['pacing']}
- Emphasis on: {self.narrative_style.voice_direction['emphasis']}

Available tone markers for voice direction:
{', '.join(self.narrative_style.tone_markers)}

Target pacing: {self.narrative_style.pacing['normal']} words per minute
"""
        return base_prompt + style_section

    async def generate_script(
        self,
        analysis: dict,
        story_plan: dict,
        user_preferences: Optional[dict] = None,
    ) -> dict:
        """Generate narrative script from analysis and plan."""
        prompt = f"""Generate a narrative script for this code repository.

REPOSITORY ANALYSIS:
{self._format_analysis(analysis)}

STORY PLAN:
{self._format_plan(story_plan)}

USER PREFERENCES:
{self._format_preferences(user_preferences)}

Use the generate_chapter_script tool for each chapter, ensuring:
1. Natural flow between chapters
2. Appropriate voice direction markers
3. Consistent narrative style throughout
4. Engaging opening and satisfying conclusion
"""
        response = await self.run(prompt)
        return self._extract_script(response)

    def _format_analysis(self, analysis: dict) -> str:
        """Format code analysis for the prompt."""
        sections = []
        if "overview" in analysis:
            sections.append(f"Overview: {analysis['overview']}")
        if "architecture" in analysis:
            sections.append(f"Architecture: {analysis['architecture']}")
        if "key_components" in analysis:
            sections.append(f"Key Components: {analysis['key_components']}")
        if "patterns" in analysis:
            sections.append(f"Patterns: {analysis['patterns']}")
        return "\n".join(sections)

    def _format_plan(self, plan: dict) -> str:
        """Format story plan for the prompt."""
        chapters = plan.get("chapters", [])
        formatted = []
        for i, ch in enumerate(chapters, 1):
            formatted.append(f"Chapter {i}: {ch.get('title', 'Untitled')}")
            formatted.append(f"  Focus: {ch.get('focus', 'General')}")
            formatted.append(f"  Duration: {ch.get('duration_minutes', 5)} minutes")
        return "\n".join(formatted)

    def _format_preferences(self, preferences: Optional[dict]) -> str:
        """Format user preferences for the prompt."""
        if not preferences:
            return "None specified"
        parts = []
        if "focus_areas" in preferences:
            parts.append(f"Focus areas: {', '.join(preferences['focus_areas'])}")
        if "exclude" in preferences:
            parts.append(f"Exclude: {', '.join(preferences['exclude'])}")
        if "depth" in preferences:
            parts.append(f"Depth: {preferences['depth']}")
        return "\n".join(parts) if parts else "None specified"

    def _extract_script(self, response: AgentMessage) -> dict:
        """Extract structured script from agent response."""
        # Script is assembled from tool call results
        return {
            "style": self.narrative_style.name,
            "chapters": response.tool_results.get("chapters", []),
            "total_duration_seconds": response.tool_results.get("total_duration", 0),
            "voice_direction": self.narrative_style.voice_direction,
        }
```
  </action>
  <verify>cd codestory/backend && python -c "from agents.story_architect import StoryArchitectAgent; print('OK')"</verify>
  <done>Story Architect integrated with styles</done>
</task>

</tasks>

<playwright_validation_gate>
```
Playwright Action: Create story with "fiction" style selected
Expected: Generated script contains fantasy/adventure language

Playwright Action: Create story with "technical" style selected
Expected: Generated script contains precise technical terminology

Playwright Action: Verify style recommendation for beginner+onboarding
Expected: Tutorial style recommended
```
</playwright_validation_gate>
