# Plan 10-03: OpenAPI/Swagger Documentation

## Overview
Generate comprehensive, interactive API documentation using FastAPI's built-in OpenAPI support. This includes enhanced descriptions, request/response examples, authentication flows, and custom documentation pages for a best-in-class developer experience.

## Dependencies
- Phase 6 complete (FastAPI backend)
- All API endpoints implemented
- Authentication mechanisms in place

## Implementation

### 1. OpenAPI Configuration

**config/openapi.py:**
```python
"""OpenAPI configuration and customization."""
from fastapi import FastAPI
from fastapi.openapi.utils import get_openapi

# API metadata
API_TITLE = "Code Story API"
API_VERSION = "1.0.0"
API_DESCRIPTION = """
# Code Story API

Transform your repositories into engaging audio narratives.

## Overview

Code Story analyzes your codebase and generates professional audio stories 
that explain your code's architecture, design patterns, and implementation details.

## Authentication

The API supports two authentication methods:

### JWT Bearer Token
For web and mobile applications. Obtain a token via `/auth/login`.

```
Authorization: Bearer <your-jwt-token>
```

### API Key
For server-to-server integrations. Generate keys at `/api-keys`.

```
X-API-Key: cs_live_<your-api-key>
```

## Rate Limits

| Tier | Requests/min | Stories/day | Audio mins/month |
|------|-------------|-------------|------------------|
| Free | 20 | 2 | 30 |
| Pro | 60 | 10 | 300 |
| Team | 200 | 50 | 1000 |
| Enterprise | 1000 | 500 | 10000 |

## Errors

The API uses standard HTTP status codes:

| Code | Description |
|------|-------------|
| 400 | Bad Request - Invalid parameters |
| 401 | Unauthorized - Missing or invalid auth |
| 402 | Payment Required - Quota exceeded |
| 403 | Forbidden - Insufficient permissions |
| 404 | Not Found - Resource doesn't exist |
| 429 | Too Many Requests - Rate limited |
| 500 | Internal Error - Server issue |

## SDKs

- [Python SDK](https://github.com/codestory/python-sdk)
- [JavaScript SDK](https://github.com/codestory/js-sdk)
- [CLI Tool](https://github.com/codestory/cli)
"""

TAGS_METADATA = [
    {
        "name": "Authentication",
        "description": "User authentication and session management",
    },
    {
        "name": "Stories",
        "description": "Create and manage audio stories from repositories",
    },
    {
        "name": "Chapters",
        "description": "Manage individual story chapters",
    },
    {
        "name": "Generation",
        "description": "Control story and audio generation workflows",
    },
    {
        "name": "API Keys",
        "description": "Manage API keys for programmatic access",
    },
    {
        "name": "Usage",
        "description": "Track usage and quota information",
    },
    {
        "name": "Sharing",
        "description": "Share stories with public links",
    },
    {
        "name": "Webhooks",
        "description": "Configure webhooks for generation events",
    },
]

CONTACT_INFO = {
    "name": "Code Story Support",
    "url": "https://codestory.dev/support",
    "email": "api-support@codestory.dev"
}

LICENSE_INFO = {
    "name": "MIT",
    "url": "https://opensource.org/licenses/MIT"
}


def custom_openapi(app: FastAPI):
    """Generate custom OpenAPI schema."""
    if app.openapi_schema:
        return app.openapi_schema
    
    openapi_schema = get_openapi(
        title=API_TITLE,
        version=API_VERSION,
        description=API_DESCRIPTION,
        routes=app.routes,
        tags=TAGS_METADATA,
        contact=CONTACT_INFO,
        license_info=LICENSE_INFO
    )
    
    # Add security schemes
    openapi_schema["components"]["securitySchemes"] = {
        "BearerAuth": {
            "type": "http",
            "scheme": "bearer",
            "bearerFormat": "JWT",
            "description": "JWT token from /auth/login"
        },
        "ApiKeyAuth": {
            "type": "apiKey",
            "in": "header",
            "name": "X-API-Key",
            "description": "API key from /api-keys"
        }
    }
    
    # Add servers
    openapi_schema["servers"] = [
        {
            "url": "https://api.codestory.dev/v1",
            "description": "Production server"
        },
        {
            "url": "https://api-staging.codestory.dev/v1",
            "description": "Staging server"
        },
        {
            "url": "http://localhost:8000/api/v1",
            "description": "Local development"
        }
    ]
    
    # Add examples to common schemas
    _add_schema_examples(openapi_schema)
    
    app.openapi_schema = openapi_schema
    return app.openapi_schema


def _add_schema_examples(schema: dict):
    """Add examples to schema definitions."""
    schemas = schema.get("components", {}).get("schemas", {})
    
    # Story examples
    if "StoryResponse" in schemas:
        schemas["StoryResponse"]["example"] = {
            "id": "story_abc123",
            "title": "Understanding FastAPI Architecture",
            "status": "completed",
            "repo_url": "https://github.com/tiangolo/fastapi",
            "narrative_style": "documentary",
            "total_duration_seconds": 1847,
            "chapter_count": 5,
            "created_at": "2025-01-15T10:30:00Z"
        }
    
    # Chapter examples
    if "ChapterResponse" in schemas:
        schemas["ChapterResponse"]["example"] = {
            "id": "chapter_xyz789",
            "title": "The Router Pattern",
            "order": 2,
            "duration_seconds": 342,
            "depth_level": "moderate",
            "audio_url": "https://cdn.codestory.dev/audio/chapter_xyz789.mp3"
        }
```

### 2. Enhanced Endpoint Documentation

**routers/stories.py (enhanced):**
```python
"""Story management endpoints with comprehensive documentation."""
from fastapi import APIRouter, Depends, HTTPException, status, Query, Path
from typing import Optional

router = APIRouter(prefix="/stories", tags=["Stories"])


@router.post(
    "",
    response_model=StoryResponse,
    status_code=status.HTTP_201_CREATED,
    summary="Create a new story",
    description="""
    Create a new audio story from a repository.
    
    The story generation process:
    1. Repository is cloned and analyzed
    2. Code structure and patterns are identified
    3. Narrative outline is generated based on style
    4. Chapters are created with appropriate depth
    5. Audio is synthesized for each chapter
    
    **Webhook Events**: `story.created`, `story.analyzing`, `story.generating`, `story.completed`
    """,
    response_description="The created story with initial status",
    responses={
        201: {
            "description": "Story created successfully",
            "content": {
                "application/json": {
                    "example": {
                        "id": "story_abc123",
                        "status": "pending",
                        "repo_url": "https://github.com/user/repo"
                    }
                }
            }
        },
        400: {
            "description": "Invalid repository URL or parameters",
            "content": {
                "application/json": {
                    "example": {"detail": "Invalid GitHub repository URL"}
                }
            }
        },
        402: {
            "description": "Story quota exceeded",
            "content": {
                "application/json": {
                    "example": {
                        "detail": {
                            "error": "Daily quota exceeded",
                            "quota_info": {"daily": {"used": 2, "limit": 2}},
                            "upgrade_url": "/settings/billing"
                        }
                    }
                }
            }
        }
    }
)
async def create_story(
    request: StoryCreate = Body(
        ...,
        example={
            "repo_url": "https://github.com/tiangolo/fastapi",
            "narrative_style": "documentary",
            "target_audience": "intermediate",
            "focus_areas": ["architecture", "routing"]
        }
    ),
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """Create a new story from a repository."""
    pass


@router.get(
    "/{story_id}",
    response_model=StoryDetailResponse,
    summary="Get story details",
    description="""
    Retrieve detailed information about a specific story.
    
    Includes:
    - Story metadata and status
    - List of chapters with durations
    - Generation progress (if in progress)
    - Audio URLs (if completed)
    """,
    responses={
        200: {
            "description": "Story details",
            "content": {
                "application/json": {
                    "example": {
                        "id": "story_abc123",
                        "title": "FastAPI Deep Dive",
                        "status": "completed",
                        "chapters": [
                            {"id": "ch1", "title": "Introduction", "duration": 180},
                            {"id": "ch2", "title": "Core Concepts", "duration": 420}
                        ]
                    }
                }
            }
        },
        404: {
            "description": "Story not found"
        }
    }
)
async def get_story(
    story_id: str = Path(
        ...,
        description="Unique story identifier",
        example="story_abc123"
    ),
    include_chapters: bool = Query(
        True,
        description="Include chapter details in response"
    ),
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """Get story by ID."""
    pass


@router.get(
    "",
    response_model=PaginatedStories,
    summary="List user's stories",
    description="""
    List all stories for the authenticated user.
    
    Supports filtering by:
    - Status (pending, analyzing, generating, completed, failed)
    - Narrative style
    - Date range
    
    Results are paginated with cursor-based pagination.
    """
)
async def list_stories(
    status: Optional[StoryStatus] = Query(
        None,
        description="Filter by story status"
    ),
    style: Optional[NarrativeStyle] = Query(
        None,
        description="Filter by narrative style"
    ),
    limit: int = Query(
        20,
        ge=1,
        le=100,
        description="Maximum stories to return"
    ),
    cursor: Optional[str] = Query(
        None,
        description="Pagination cursor from previous response"
    ),
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    """List stories with optional filtering."""
    pass
```

### 3. Custom Documentation Pages

**static/docs/index.html:**
```html
<!DOCTYPE html>
<html>
<head>
    <title>Code Story API Documentation</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="/static/docs/swagger-custom.css">
</head>
<body>
    <div id="swagger-ui"></div>
    <script src="https://unpkg.com/swagger-ui-dist@5/swagger-ui-bundle.js"></script>
    <script>
        window.onload = function() {
            SwaggerUIBundle({
                url: "/openapi.json",
                dom_id: '#swagger-ui',
                deepLinking: true,
                presets: [
                    SwaggerUIBundle.presets.apis,
                    SwaggerUIBundle.SwaggerUIStandalonePreset
                ],
                plugins: [
                    SwaggerUIBundle.plugins.DownloadUrl
                ],
                layout: "StandaloneLayout",
                persistAuthorization: true,
                tryItOutEnabled: true,
                syntaxHighlight: {
                    activate: true,
                    theme: "monokai"
                }
            });
        };
    </script>
</body>
</html>
```

**static/docs/swagger-custom.css:**
```css
/* Custom Swagger UI styling */
:root {
    --primary-color: #6366f1;
    --secondary-color: #8b5cf6;
    --background-color: #0f172a;
    --text-color: #e2e8f0;
}

.swagger-ui {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
}

.swagger-ui .topbar {
    background-color: var(--primary-color);
}

.swagger-ui .info .title {
    color: var(--primary-color);
}

.swagger-ui .opblock.opblock-post {
    border-color: #22c55e;
    background: rgba(34, 197, 94, 0.1);
}

.swagger-ui .opblock.opblock-get {
    border-color: #3b82f6;
    background: rgba(59, 130, 246, 0.1);
}

.swagger-ui .opblock.opblock-delete {
    border-color: #ef4444;
    background: rgba(239, 68, 68, 0.1);
}

.swagger-ui .opblock.opblock-patch {
    border-color: #f59e0b;
    background: rgba(245, 158, 11, 0.1);
}

.swagger-ui .btn.execute {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
}

.swagger-ui .btn.execute:hover {
    background-color: var(--secondary-color);
}

/* Response examples styling */
.swagger-ui .responses-inner {
    padding: 1rem;
}

.swagger-ui .response-col_description {
    font-size: 0.9rem;
}

/* Authentication section */
.swagger-ui .auth-wrapper {
    padding: 1rem;
    background: #f8fafc;
    border-radius: 0.5rem;
}
```

### 4. ReDoc Alternative

**static/docs/redoc.html:**
```html
<!DOCTYPE html>
<html>
<head>
    <title>Code Story API Reference</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css?family=Inter:300,400,600,700" rel="stylesheet">
    <style>
        body {
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>
    <redoc 
        spec-url='/openapi.json'
        hide-download-button="false"
        theme='{
            "colors": {
                "primary": { "main": "#6366f1" }
            },
            "typography": {
                "fontFamily": "Inter, sans-serif",
                "headings": { "fontFamily": "Inter, sans-serif" }
            },
            "sidebar": {
                "width": "300px",
                "backgroundColor": "#0f172a",
                "textColor": "#e2e8f0"
            }
        }'
    ></redoc>
    <script src="https://cdn.redoc.ly/redoc/latest/bundles/redoc.standalone.js"></script>
</body>
</html>
```

### 5. Documentation Router

**routers/docs.py:**
```python
"""Documentation routes."""
from fastapi import APIRouter, Request
from fastapi.responses import HTMLResponse, FileResponse
from fastapi.staticfiles import StaticFiles

router = APIRouter(tags=["Documentation"])


@router.get("/docs", include_in_schema=False)
async def swagger_docs():
    """Serve custom Swagger UI."""
    return FileResponse("static/docs/index.html")


@router.get("/redoc", include_in_schema=False)
async def redoc_docs():
    """Serve ReDoc documentation."""
    return FileResponse("static/docs/redoc.html")


@router.get("/docs/getting-started", include_in_schema=False)
async def getting_started():
    """Getting started guide."""
    return FileResponse("static/docs/getting-started.html")


@router.get("/docs/authentication", include_in_schema=False)
async def authentication_guide():
    """Authentication guide."""
    return FileResponse("static/docs/authentication.html")


@router.get("/docs/webhooks", include_in_schema=False)
async def webhooks_guide():
    """Webhooks guide."""
    return FileResponse("static/docs/webhooks.html")
```

### 6. Request/Response Examples

**schemas/examples.py:**
```python
"""Comprehensive examples for API documentation."""

# Story creation examples
STORY_CREATE_EXAMPLES = {
    "basic": {
        "summary": "Basic story creation",
        "description": "Create a story with default settings",
        "value": {
            "repo_url": "https://github.com/user/my-app"
        }
    },
    "documentary_style": {
        "summary": "Documentary narrative",
        "description": "Create a documentary-style narration",
        "value": {
            "repo_url": "https://github.com/user/my-app",
            "narrative_style": "documentary",
            "target_audience": "intermediate",
            "voice_id": "EXAVITQu4vr4xnSDxMaL"
        }
    },
    "tutorial_focused": {
        "summary": "Tutorial for beginners",
        "description": "Educational tutorial focusing on specific areas",
        "value": {
            "repo_url": "https://github.com/user/my-app",
            "narrative_style": "tutorial",
            "target_audience": "beginner",
            "focus_areas": ["getting_started", "configuration"],
            "max_duration_minutes": 15
        }
    },
    "technical_deep_dive": {
        "summary": "Technical analysis",
        "description": "In-depth technical architecture review",
        "value": {
            "repo_url": "https://github.com/user/my-app",
            "narrative_style": "technical",
            "target_audience": "expert",
            "focus_areas": ["architecture", "patterns", "performance"],
            "include_code_snippets": True
        }
    }
}

# Webhook event examples
WEBHOOK_EVENT_EXAMPLES = {
    "story.created": {
        "event": "story.created",
        "timestamp": "2025-01-15T10:30:00Z",
        "data": {
            "story_id": "story_abc123",
            "repo_url": "https://github.com/user/repo",
            "status": "pending"
        }
    },
    "story.completed": {
        "event": "story.completed",
        "timestamp": "2025-01-15T10:45:00Z",
        "data": {
            "story_id": "story_abc123",
            "title": "Understanding My App",
            "duration_seconds": 1847,
            "chapter_count": 5,
            "audio_url": "https://cdn.codestory.dev/stories/story_abc123/full.mp3"
        }
    },
    "story.failed": {
        "event": "story.failed",
        "timestamp": "2025-01-15T10:35:00Z",
        "data": {
            "story_id": "story_abc123",
            "error_code": "REPO_ACCESS_DENIED",
            "error_message": "Unable to access private repository"
        }
    }
}

# Error response examples
ERROR_EXAMPLES = {
    "validation_error": {
        "detail": [
            {
                "loc": ["body", "repo_url"],
                "msg": "Invalid GitHub URL format",
                "type": "value_error"
            }
        ]
    },
    "authentication_error": {
        "detail": "Invalid or expired authentication token"
    },
    "rate_limit_error": {
        "error": "Rate limit exceeded",
        "limit": 20,
        "retry_after": 45
    },
    "quota_exceeded": {
        "detail": {
            "error": "Daily quota exceeded",
            "quota_info": {
                "daily": {"used": 2, "limit": 2, "remaining": 0}
            },
            "upgrade_url": "/settings/billing"
        }
    }
}
```

### 7. OpenAPI Export

**scripts/export_openapi.py:**
```python
"""Export OpenAPI schema to file."""
import json
import yaml
from main import app
from config.openapi import custom_openapi

def export_openapi():
    """Export OpenAPI schema to JSON and YAML."""
    # Generate schema
    schema = custom_openapi(app)
    
    # Export as JSON
    with open("docs/openapi.json", "w") as f:
        json.dump(schema, f, indent=2)
    
    # Export as YAML
    with open("docs/openapi.yaml", "w") as f:
        yaml.dump(schema, f, default_flow_style=False, sort_keys=False)
    
    print("OpenAPI schema exported to docs/openapi.json and docs/openapi.yaml")


if __name__ == "__main__":
    export_openapi()
```

## File Structure
```
backend/
├── config/
│   └── openapi.py
├── routers/
│   └── docs.py
├── schemas/
│   └── examples.py
├── static/
│   └── docs/
│       ├── index.html
│       ├── redoc.html
│       ├── swagger-custom.css
│       ├── getting-started.html
│       ├── authentication.html
│       └── webhooks.html
├── scripts/
│   └── export_openapi.py
└── docs/
    ├── openapi.json
    └── openapi.yaml
```

## Validation Gates

### Gate 1: OpenAPI Schema Generation
```python
def test_openapi_schema():
    """Verify OpenAPI schema is valid."""
    response = client.get("/openapi.json")
    assert response.status_code == 200
    
    schema = response.json()
    
    # Check required fields
    assert schema["openapi"].startswith("3.")
    assert schema["info"]["title"] == "Code Story API"
    assert "paths" in schema
    assert "components" in schema
```

### Gate 2: Swagger UI Access
```python
def test_swagger_ui():
    """Verify Swagger UI is accessible."""
    response = client.get("/docs")
    assert response.status_code == 200
    assert "swagger-ui" in response.text
```

### Gate 3: ReDoc Access
```python
def test_redoc():
    """Verify ReDoc is accessible."""
    response = client.get("/redoc")
    assert response.status_code == 200
    assert "redoc" in response.text.lower()
```

### Gate 4: All Endpoints Documented
```python
def test_all_endpoints_documented():
    """Verify all endpoints have documentation."""
    response = client.get("/openapi.json")
    schema = response.json()
    
    for path, methods in schema["paths"].items():
        for method, details in methods.items():
            if method in ["get", "post", "put", "patch", "delete"]:
                assert "summary" in details, f"{method} {path} missing summary"
                assert "responses" in details, f"{method} {path} missing responses"
```

### Gate 5: Examples Present
```python
def test_request_examples():
    """Verify request examples are present."""
    response = client.get("/openapi.json")
    schema = response.json()
    
    # Check story creation has examples
    story_post = schema["paths"]["/stories"]["post"]
    request_body = story_post.get("requestBody", {})
    content = request_body.get("content", {}).get("application/json", {})
    
    assert "example" in content or "examples" in content
```

## Definition of Done
- [ ] Custom OpenAPI schema with full metadata
- [ ] Security schemes for JWT and API Key
- [ ] All endpoints have summaries and descriptions
- [ ] Request/response examples for all operations
- [ ] Custom Swagger UI with branding
- [ ] ReDoc alternative documentation
- [ ] Static guide pages (getting started, auth, webhooks)
- [ ] OpenAPI export script (JSON/YAML)
- [ ] All validation gates passing
