---
phase: 05-voice-director
plan: 01
type: execute
domain: python-api
---

<objective>
Implement ElevenLabs API integration for text-to-speech synthesis.
</objective>

<context>
@BRIEF.md
</context>

<tasks>

<task type="auto">
  <n>Task 1: Create ElevenLabs client</n>
  <files>codestory/backend/voice/elevenlabs.py, codestory/backend/voice/__init__.py</files>
  <action>
Create async ElevenLabs client:

```python
"""ElevenLabs TTS API client."""

import asyncio
from typing import Any, AsyncGenerator
from pathlib import Path

import httpx

from backend.core.config import get_settings


class ElevenLabsError(Exception):
    """ElevenLabs API error."""
    pass


class ElevenLabsClient:
    """Async client for ElevenLabs TTS API."""
    
    BASE_URL = "https://api.elevenlabs.io/v1"
    
    # Default voice IDs
    VOICES = {
        "narrative": "pNInz6obpgDQGcFmaJgB",  # Adam - narrative voice
        "professional": "21m00Tcm4TlvDq8ikWAM",  # Rachel - professional
        "friendly": "EXAVITQu4vr4xnSDxMaL",  # Bella - friendly
        "authoritative": "VR6AewLTigWG4xSOukaG",  # Arnold - authoritative
    }
    
    def __init__(self, api_key: str | None = None):
        settings = get_settings()
        self.api_key = api_key or settings.elevenlabs_api_key
        self._client: httpx.AsyncClient | None = None
    
    async def _get_client(self) -> httpx.AsyncClient:
        if not self._client:
            self._client = httpx.AsyncClient(
                timeout=60.0,
                headers={"xi-api-key": self.api_key},
            )
        return self._client
    
    async def synthesize(
        self,
        text: str,
        voice_id: str | None = None,
        model_id: str = "eleven_multilingual_v2",
        stability: float = 0.5,
        similarity_boost: float = 0.75,
    ) -> bytes:
        """Synthesize text to speech."""
        client = await self._get_client()
        voice = voice_id or self.VOICES["narrative"]
        
        response = await client.post(
            f"{self.BASE_URL}/text-to-speech/{voice}",
            json={
                "text": text,
                "model_id": model_id,
                "voice_settings": {
                    "stability": stability,
                    "similarity_boost": similarity_boost,
                },
            },
        )
        
        if response.status_code != 200:
            raise ElevenLabsError(f"Synthesis failed: {response.text}")
        
        return response.content
    
    async def synthesize_streaming(
        self,
        text: str,
        voice_id: str | None = None,
    ) -> AsyncGenerator[bytes, None]:
        """Stream synthesized audio."""
        client = await self._get_client()
        voice = voice_id or self.VOICES["narrative"]
        
        async with client.stream(
            "POST",
            f"{self.BASE_URL}/text-to-speech/{voice}/stream",
            json={"text": text, "model_id": "eleven_multilingual_v2"},
        ) as response:
            async for chunk in response.aiter_bytes():
                yield chunk
    
    async def get_voices(self) -> list[dict[str, Any]]:
        """Get available voices."""
        client = await self._get_client()
        response = await client.get(f"{self.BASE_URL}/voices")
        return response.json().get("voices", [])
    
    async def close(self):
        """Close the client."""
        if self._client:
            await self._client.aclose()
            self._client = None


elevenlabs_client = ElevenLabsClient()
```
  </action>
  <verify>python -c "from codestory.backend.voice.elevenlabs import ElevenLabsClient; print('ElevenLabs OK')"</verify>
  <done>ElevenLabs client created</done>
</task>

</tasks>

<playwright_validation_gate>
```
Playwright Action: HTTP GET /voice/health
Expected: 200 OK
Assert: response.json().elevenlabs_configured exists
```
</playwright_validation_gate>
