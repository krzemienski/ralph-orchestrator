---
phase: 01-foundation
type: execute
domain: configuration
---

<objective>
Implement environment configuration with pydantic-settings and secure secrets management.

Purpose: Centralize all configuration in a type-safe, validated settings class that loads from environment variables.
Output: Working settings module with all API keys, database URLs, and feature flags properly configured.
</objective>


<context>
@BRIEF.md
@ROADMAP.md
@plans/01-foundation/01-01-SUMMARY.md
@plans/01-foundation/01-02-SUMMARY.md
@plans/01-foundation/01-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <n>Task 1: Create Settings class with pydantic-settings</n>
  <files>src/codestory/core/config.py</files>
  <action>
    Implement comprehensive settings using pydantic-settings:
    
    ```python
    # src/codestory/core/config.py
    """Application configuration and settings management."""
    
    from functools import lru_cache
    from typing import Literal
    from pydantic import Field, field_validator, computed_field
    from pydantic_settings import BaseSettings, SettingsConfigDict
    
    
    class Settings(BaseSettings):
        """Application settings loaded from environment variables.
        
        All settings can be overridden via environment variables.
        Secrets should never be committed to version control.
        """
        
        model_config = SettingsConfigDict(
            env_file=".env",
            env_file_encoding="utf-8",
            case_sensitive=False,
            extra="ignore",
        )
        
        # Application
        app_name: str = "Code Story"
        app_version: str = "0.1.0"
        debug: bool = False
        environment: Literal["development", "staging", "production"] = "development"
        
        # Server
        host: str = "0.0.0.0"
        port: int = 8000
        workers: int = 1
        
        # Database
        database_url: str = Field(
            default="postgresql+asyncpg://postgres:postgres@localhost:5432/codestory",
            description="PostgreSQL connection URL (async)",
        )
        database_pool_size: int = 5
        database_max_overflow: int = 10
        
        # Redis
        redis_url: str = Field(
            default="redis://localhost:6379/0",
            description="Redis connection URL for caching and Celery",
        )
        
        # Authentication
        secret_key: str = Field(
            default="change-me-in-production",
            description="Secret key for JWT signing",
        )
        access_token_expire_minutes: int = 60 * 24  # 24 hours
        refresh_token_expire_days: int = 30
        algorithm: str = "HS256"
        
        # Anthropic / Claude
        anthropic_api_key: str = Field(
            default="",
            description="Anthropic API key for Claude",
        )
        claude_model: str = "claude-opus-4-5-20251101"
        claude_max_tokens: int = 8192
        claude_effort: Literal["low", "medium", "high"] = "high"
        
        # ElevenLabs
        elevenlabs_api_key: str = Field(
            default="",
            description="ElevenLabs API key for voice synthesis",
        )
        elevenlabs_default_voice: str = "21m00Tcm4TlvDq8ikWAM"  # Rachel voice
        elevenlabs_model: str = "eleven_multilingual_v2"
        
        # GitHub
        github_token: str = Field(
            default="",
            description="GitHub personal access token for API access",
        )
        github_api_base: str = "https://api.github.com"
        
        # AWS S3
        aws_access_key_id: str = Field(default="", description="AWS access key")
        aws_secret_access_key: str = Field(default="", description="AWS secret key")
        aws_region: str = "us-east-1"
        s3_bucket: str = Field(default="codestory-audio", description="S3 bucket for audio files")
        s3_endpoint_url: str | None = None  # For S3-compatible storage
        
        # Celery
        celery_broker_url: str | None = None  # Defaults to redis_url if not set
        celery_result_backend: str | None = None  # Defaults to redis_url if not set
        
        # Rate Limiting
        rate_limit_requests: int = 100
        rate_limit_window_seconds: int = 3600
        
        # Feature Flags
        enable_voice_synthesis: bool = True
        enable_github_private_repos: bool = False
        enable_analytics: bool = True
        max_story_duration_minutes: int = 30
        max_repo_size_mb: int = 100
        
        @field_validator("database_url")
        @classmethod
        def validate_database_url(cls, v: str) -> str:
            """Ensure database URL uses async driver."""
            if v and "postgresql://" in v and "asyncpg" not in v:
                v = v.replace("postgresql://", "postgresql+asyncpg://")
            return v
        
        @computed_field
        @property
        def celery_broker(self) -> str:
            """Get Celery broker URL, defaulting to Redis URL."""
            return self.celery_broker_url or self.redis_url
        
        @computed_field
        @property
        def celery_backend(self) -> str:
            """Get Celery result backend URL, defaulting to Redis URL."""
            return self.celery_result_backend or self.redis_url
        
        @computed_field
        @property
        def is_production(self) -> bool:
            """Check if running in production environment."""
            return self.environment == "production"
        
        def has_anthropic_key(self) -> bool:
            """Check if Anthropic API key is configured."""
            return bool(self.anthropic_api_key and self.anthropic_api_key != "")
        
        def has_elevenlabs_key(self) -> bool:
            """Check if ElevenLabs API key is configured."""
            return bool(self.elevenlabs_api_key and self.elevenlabs_api_key != "")
        
        def has_github_token(self) -> bool:
            """Check if GitHub token is configured."""
            return bool(self.github_token and self.github_token != "")
        
        def has_aws_credentials(self) -> bool:
            """Check if AWS credentials are configured."""
            return bool(self.aws_access_key_id and self.aws_secret_access_key)
    
    
    @lru_cache
    def get_settings() -> Settings:
        """Get cached settings instance.
        
        Uses lru_cache to ensure settings are only loaded once.
        """
        return Settings()
    
    
    # Convenience function for dependency injection
    def get_config() -> Settings:
        """Alias for get_settings() for clearer dependency naming."""
        return get_settings()
    ```
    
    Avoid: Do NOT hardcode secrets, do NOT skip validation, do NOT expose secrets in logs.
  </action>
  <verify>Settings class loads from environment, validators work, computed fields correct</verify>
  <done>Comprehensive Settings class with type validation and environment variable support</done>
</task>

<task type="auto">
  <n>Task 2: Create security utilities</n>
  <files>src/codestory/core/security.py</files>
  <action>
    Implement security utilities for authentication:
    
    ```python
    # src/codestory/core/security.py
    """Security utilities for authentication and authorization."""
    
    from datetime import datetime, timedelta, timezone
    from typing import Any
    import secrets
    import hashlib
    
    from jose import jwt, JWTError
    from passlib.context import CryptContext
    
    from .config import get_settings
    
    
    # Password hashing context
    pwd_context = CryptContext(schemes=["bcrypt"], deprecated="auto")
    
    
    def verify_password(plain_password: str, hashed_password: str) -> bool:
        """Verify a password against its hash."""
        return pwd_context.verify(plain_password, hashed_password)
    
    
    def hash_password(password: str) -> str:
        """Hash a password for storage."""
        return pwd_context.hash(password)
    
    
    def create_access_token(
        data: dict[str, Any],
        expires_delta: timedelta | None = None,
    ) -> str:
        """Create a JWT access token.
        
        Args:
            data: Payload data to encode in the token
            expires_delta: Optional custom expiration time
        
        Returns:
            Encoded JWT token string
        """
        settings = get_settings()
        to_encode = data.copy()
        
        if expires_delta:
            expire = datetime.now(timezone.utc) + expires_delta
        else:
            expire = datetime.now(timezone.utc) + timedelta(
                minutes=settings.access_token_expire_minutes
            )
        
        to_encode.update({"exp": expire, "type": "access"})
        return jwt.encode(to_encode, settings.secret_key, algorithm=settings.algorithm)
    
    
    def create_refresh_token(
        data: dict[str, Any],
        expires_delta: timedelta | None = None,
    ) -> str:
        """Create a JWT refresh token.
        
        Args:
            data: Payload data to encode in the token
            expires_delta: Optional custom expiration time
        
        Returns:
            Encoded JWT refresh token string
        """
        settings = get_settings()
        to_encode = data.copy()
        
        if expires_delta:
            expire = datetime.now(timezone.utc) + expires_delta
        else:
            expire = datetime.now(timezone.utc) + timedelta(
                days=settings.refresh_token_expire_days
            )
        
        to_encode.update({"exp": expire, "type": "refresh"})
        return jwt.encode(to_encode, settings.secret_key, algorithm=settings.algorithm)
    
    
    def decode_token(token: str) -> dict[str, Any] | None:
        """Decode and validate a JWT token.
        
        Args:
            token: JWT token string
        
        Returns:
            Decoded payload if valid, None otherwise
        """
        settings = get_settings()
        try:
            payload = jwt.decode(
                token,
                settings.secret_key,
                algorithms=[settings.algorithm],
            )
            return payload
        except JWTError:
            return None
    
    
    def generate_api_key() -> str:
        """Generate a secure API key.
        
        Returns:
            Random API key string (32 bytes, hex encoded)
        """
        return secrets.token_hex(32)
    
    
    def hash_api_key(api_key: str) -> str:
        """Hash an API key for storage.
        
        Uses SHA-256 for fast lookup while maintaining security.
        
        Args:
            api_key: Raw API key string
        
        Returns:
            SHA-256 hash of the API key
        """
        return hashlib.sha256(api_key.encode()).hexdigest()
    
    
    def verify_api_key(api_key: str, key_hash: str) -> bool:
        """Verify an API key against its hash.
        
        Args:
            api_key: Raw API key to verify
            key_hash: Stored hash to compare against
        
        Returns:
            True if the API key matches the hash
        """
        return hash_api_key(api_key) == key_hash
    ```
    
    Avoid: Do NOT store passwords in plain text, do NOT use weak hashing algorithms.
  </action>
  <verify>Password hashing works, JWT creation/validation works, API key generation secure</verify>
  <done>Security utilities: password hashing, JWT tokens, API key management</done>
</task>

<task type="auto">
  <n>Task 3: Update core module exports and create .env.example</n>
  <files>src/codestory/core/__init__.py, .env.example</files>
  <action>
    Update core module exports:
    
    ```python
    # src/codestory/core/__init__.py
    """Core utilities for Code Story."""
    from .config import Settings, get_settings, get_config
    from .security import (
        verify_password,
        hash_password,
        create_access_token,
        create_refresh_token,
        decode_token,
        generate_api_key,
        hash_api_key,
        verify_api_key,
    )
    
    __all__ = [
        "Settings",
        "get_settings",
        "get_config",
        "verify_password",
        "hash_password",
        "create_access_token",
        "create_refresh_token",
        "decode_token",
        "generate_api_key",
        "hash_api_key",
        "verify_api_key",
    ]
    ```
    
    Create comprehensive `.env.example`:
    ```bash
    # .env.example
    # Code Story Configuration
    # Copy this file to .env and fill in your values
    
    # =============================================================================
    # Application
    # =============================================================================
    APP_NAME="Code Story"
    APP_VERSION="0.1.0"
    DEBUG=false
    ENVIRONMENT=development  # development, staging, production
    
    # =============================================================================
    # Server
    # =============================================================================
    HOST=0.0.0.0
    PORT=8000
    WORKERS=1
    
    # =============================================================================
    # Database (PostgreSQL)
    # =============================================================================
    DATABASE_URL=postgresql+asyncpg://postgres:postgres@localhost:5432/codestory
    DATABASE_POOL_SIZE=5
    DATABASE_MAX_OVERFLOW=10
    
    # =============================================================================
    # Redis (Cache & Celery)
    # =============================================================================
    REDIS_URL=redis://localhost:6379/0
    
    # =============================================================================
    # Authentication
    # =============================================================================
    # Generate with: python -c "import secrets; print(secrets.token_hex(32))"
    SECRET_KEY=your-super-secret-key-change-in-production
    ACCESS_TOKEN_EXPIRE_MINUTES=1440  # 24 hours
    REFRESH_TOKEN_EXPIRE_DAYS=30
    ALGORITHM=HS256
    
    # =============================================================================
    # Anthropic / Claude API
    # =============================================================================
    ANTHROPIC_API_KEY=sk-ant-api03-...
    CLAUDE_MODEL=claude-opus-4-5-20251101
    CLAUDE_MAX_TOKENS=8192
    CLAUDE_EFFORT=high  # low, medium, high
    
    # =============================================================================
    # ElevenLabs (Voice Synthesis)
    # =============================================================================
    ELEVENLABS_API_KEY=your-elevenlabs-api-key
    ELEVENLABS_DEFAULT_VOICE=21m00Tcm4TlvDq8ikWAM  # Rachel
    ELEVENLABS_MODEL=eleven_multilingual_v2
    
    # =============================================================================
    # GitHub
    # =============================================================================
    GITHUB_TOKEN=ghp_your-github-token
    GITHUB_API_BASE=https://api.github.com
    
    # =============================================================================
    # AWS S3 (Audio Storage)
    # =============================================================================
    AWS_ACCESS_KEY_ID=your-aws-access-key
    AWS_SECRET_ACCESS_KEY=your-aws-secret-key
    AWS_REGION=us-east-1
    S3_BUCKET=codestory-audio
    # S3_ENDPOINT_URL=  # Optional: for S3-compatible storage (MinIO, etc.)
    
    # =============================================================================
    # Celery (Task Queue) - Optional, defaults to Redis URL
    # =============================================================================
    # CELERY_BROKER_URL=redis://localhost:6379/0
    # CELERY_RESULT_BACKEND=redis://localhost:6379/0
    
    # =============================================================================
    # Rate Limiting
    # =============================================================================
    RATE_LIMIT_REQUESTS=100
    RATE_LIMIT_WINDOW_SECONDS=3600
    
    # =============================================================================
    # Feature Flags
    # =============================================================================
    ENABLE_VOICE_SYNTHESIS=true
    ENABLE_GITHUB_PRIVATE_REPOS=false
    ENABLE_ANALYTICS=true
    MAX_STORY_DURATION_MINUTES=30
    MAX_REPO_SIZE_MB=100
    ```
    
    Avoid: Do NOT include real secrets in .env.example, do NOT skip documentation comments.
  </action>
  <verify>All exports working, .env.example comprehensive and documented</verify>
  <done>Core module exports and comprehensive .env.example with all configuration options</done>
</task>

</tasks>

<verification>
Before declaring phase complete:
- [ ] `uv run python -c "from codestory.core import get_settings"` succeeds
- [ ] Settings loads from environment variables correctly
- [ ] Password hashing and verification works
- [ ] JWT token creation and validation works
- [ ] .env.example contains all required variables with documentation
</verification>

<success_criteria>
- All configuration centralized in Settings class
- Environment variables properly loaded and validated
- Security utilities production-ready
- Comprehensive .env.example for easy setup
</success_criteria>

<o>
After completion, create `plans/01-foundation/01-04-SUMMARY.md`
</o>
