# Plan 12-03: Kubernetes Manifests and Helm Charts

## Overview
Create production-ready Kubernetes manifests and a Helm chart for deploying Code Story to any Kubernetes cluster. This includes all necessary resources for the API, workers, databases, and supporting services with proper configuration management, scaling, and monitoring integration.

## Dependencies
- Plan 12-01 complete (Docker Compose configuration)
- Plan 12-02 complete (Production Docker images)
- Understanding of target Kubernetes environments (EKS, GKE, AKS, self-hosted)

## Implementation

### 1. Helm Chart Structure

**charts/code-story/Chart.yaml:**
```yaml
apiVersion: v2
name: code-story
description: Transform code repositories into engaging audio narratives
type: application
version: 1.0.0
appVersion: "1.0.0"
keywords:
  - code
  - audio
  - ai
  - documentation
maintainers:
  - name: Code Story Team
    email: team@codestory.dev
dependencies:
  - name: postgresql
    version: "14.0.0"
    repository: "https://charts.bitnami.com/bitnami"
    condition: postgresql.enabled
  - name: redis
    version: "18.0.0"
    repository: "https://charts.bitnami.com/bitnami"
    condition: redis.enabled
```

### 2. Values Configuration

**charts/code-story/values.yaml:**
```yaml
# =============================================================================
# Code Story Helm Chart - Default Values
# =============================================================================

# Global settings
global:
  imageRegistry: ""
  imagePullSecrets: []
  storageClass: ""

# -----------------------------------------------------------------------------
# API Configuration
# -----------------------------------------------------------------------------
api:
  replicaCount: 2
  
  image:
    repository: codestory/api
    tag: "latest"
    pullPolicy: IfNotPresent
  
  service:
    type: ClusterIP
    port: 8000
  
  ingress:
    enabled: true
    className: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/proxy-body-size: "100m"
    hosts:
      - host: api.codestory.dev
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: api-tls
        hosts:
          - api.codestory.dev
  
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 2Gi
  
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 10
    targetCPUUtilizationPercentage: 70
    targetMemoryUtilizationPercentage: 80
  
  podDisruptionBudget:
    enabled: true
    minAvailable: 1
  
  nodeSelector: {}
  tolerations: []
  affinity: {}

# -----------------------------------------------------------------------------
# Celery Worker Configuration
# -----------------------------------------------------------------------------
celeryWorker:
  replicaCount: 2
  
  image:
    repository: codestory/api
    tag: "latest"
    pullPolicy: IfNotPresent
  
  command:
    - celery
    - -A
    - workers.celery_app
    - worker
    - --loglevel=info
    - --concurrency=4
  
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 4Gi
  
  autoscaling:
    enabled: true
    minReplicas: 2
    maxReplicas: 20
    # Scale based on Celery queue length via KEDA
    kedaEnabled: false
    kedaTriggers: []
  
  nodeSelector: {}
  tolerations: []
  affinity: {}

# -----------------------------------------------------------------------------
# Celery Beat (Scheduler)
# -----------------------------------------------------------------------------
celeryBeat:
  enabled: true
  
  image:
    repository: codestory/api
    tag: "latest"
    pullPolicy: IfNotPresent
  
  command:
    - celery
    - -A
    - workers.celery_app
    - beat
    - --loglevel=info
  
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi

# -----------------------------------------------------------------------------
# Web Frontend
# -----------------------------------------------------------------------------
web:
  enabled: true
  replicaCount: 2
  
  image:
    repository: codestory/web
    tag: "latest"
    pullPolicy: IfNotPresent
  
  service:
    type: ClusterIP
    port: 80
  
  ingress:
    enabled: true
    className: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
    hosts:
      - host: app.codestory.dev
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: web-tls
        hosts:
          - app.codestory.dev
  
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi

# -----------------------------------------------------------------------------
# Admin Dashboard
# -----------------------------------------------------------------------------
admin:
  enabled: true
  replicaCount: 1
  
  image:
    repository: codestory/admin
    tag: "latest"
    pullPolicy: IfNotPresent
  
  service:
    type: ClusterIP
    port: 80
  
  ingress:
    enabled: true
    className: nginx
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/whitelist-source-range: "10.0.0.0/8"  # Internal only
    hosts:
      - host: admin.codestory.dev
        paths:
          - path: /
            pathType: Prefix
    tls:
      - secretName: admin-tls
        hosts:
          - admin.codestory.dev
  
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi

# -----------------------------------------------------------------------------
# PostgreSQL (Bitnami subchart)
# -----------------------------------------------------------------------------
postgresql:
  enabled: true
  auth:
    postgresPassword: ""  # Set via secret
    username: codestory
    password: ""  # Set via secret
    database: codestory
  primary:
    persistence:
      enabled: true
      size: 50Gi
      storageClass: ""
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        cpu: 2000m
        memory: 4Gi
  metrics:
    enabled: true

# External PostgreSQL (when postgresql.enabled=false)
externalDatabase:
  host: ""
  port: 5432
  username: codestory
  database: codestory
  existingSecret: ""
  existingSecretPasswordKey: password

# -----------------------------------------------------------------------------
# Redis (Bitnami subchart)
# -----------------------------------------------------------------------------
redis:
  enabled: true
  architecture: standalone
  auth:
    enabled: true
    password: ""  # Set via secret
  master:
    persistence:
      enabled: true
      size: 10Gi
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 1Gi
  metrics:
    enabled: true

# External Redis (when redis.enabled=false)
externalRedis:
  host: ""
  port: 6379
  password: ""
  existingSecret: ""
  existingSecretPasswordKey: password

# -----------------------------------------------------------------------------
# S3/Object Storage
# -----------------------------------------------------------------------------
s3:
  # For AWS S3
  bucket: code-story-audio
  region: us-east-1
  # For S3-compatible (MinIO, etc.)
  endpoint: ""
  # Credentials via secret
  existingSecret: ""
  accessKeyId: ""
  secretAccessKey: ""

# -----------------------------------------------------------------------------
# Secrets (API Keys)
# -----------------------------------------------------------------------------
secrets:
  # Create secret from values or use existing
  create: true
  existingSecret: ""
  
  # Only used when secrets.create=true
  jwtSecret: ""  # Generate: openssl rand -hex 32
  anthropicApiKey: ""
  elevenLabsApiKey: ""
  githubToken: ""

# -----------------------------------------------------------------------------
# Service Account
# -----------------------------------------------------------------------------
serviceAccount:
  create: true
  annotations: {}
  name: ""

# -----------------------------------------------------------------------------
# Monitoring
# -----------------------------------------------------------------------------
metrics:
  enabled: true
  serviceMonitor:
    enabled: false
    namespace: ""
    interval: 30s
    scrapeTimeout: 10s

# -----------------------------------------------------------------------------
# Network Policies
# -----------------------------------------------------------------------------
networkPolicy:
  enabled: true
  # Allow ingress only from ingress controller
  ingressRules: []
  # Allow egress to external APIs
  egressRules:
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
      ports:
        - port: 443
          protocol: TCP
```

### 3. API Deployment Template

**charts/code-story/templates/api/deployment.yaml:**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "code-story.fullname" . }}-api
  labels:
    {{- include "code-story.labels" . | nindent 4 }}
    app.kubernetes.io/component: api
spec:
  {{- if not .Values.api.autoscaling.enabled }}
  replicas: {{ .Values.api.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "code-story.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: api
  template:
    metadata:
      annotations:
        checksum/secret: {{ include (print $.Template.BasePath "/secrets.yaml") . | sha256sum }}
      labels:
        {{- include "code-story.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: api
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "code-story.serviceAccountName" . }}
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      containers:
        - name: api
          image: "{{ .Values.api.image.repository }}:{{ .Values.api.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.api.image.pullPolicy }}
          ports:
            - name: http
              containerPort: 8000
              protocol: TCP
          env:
            - name: ENVIRONMENT
              value: "production"
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: {{ include "code-story.secretName" . }}
                  key: database-url
            - name: REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: {{ include "code-story.secretName" . }}
                  key: redis-url
            - name: CELERY_BROKER_URL
              valueFrom:
                secretKeyRef:
                  name: {{ include "code-story.secretName" . }}
                  key: celery-broker-url
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: {{ include "code-story.secretName" . }}
                  key: jwt-secret
            - name: ANTHROPIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ include "code-story.secretName" . }}
                  key: anthropic-api-key
            - name: ELEVENLABS_API_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ include "code-story.secretName" . }}
                  key: elevenlabs-api-key
            - name: GITHUB_TOKEN
              valueFrom:
                secretKeyRef:
                  name: {{ include "code-story.secretName" . }}
                  key: github-token
            - name: AWS_S3_BUCKET
              value: {{ .Values.s3.bucket | quote }}
            - name: AWS_REGION
              value: {{ .Values.s3.region | quote }}
            {{- if .Values.s3.endpoint }}
            - name: AWS_S3_ENDPOINT
              value: {{ .Values.s3.endpoint | quote }}
            {{- end }}
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: {{ include "code-story.secretName" . }}
                  key: aws-access-key-id
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ include "code-story.secretName" . }}
                  key: aws-secret-access-key
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 3
          resources:
            {{- toYaml .Values.api.resources | nindent 12 }}
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir: {}
      {{- with .Values.api.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.api.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.api.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
```

### 4. Celery Worker Deployment

**charts/code-story/templates/celery-worker/deployment.yaml:**
```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ include "code-story.fullname" . }}-celery-worker
  labels:
    {{- include "code-story.labels" . | nindent 4 }}
    app.kubernetes.io/component: celery-worker
spec:
  {{- if not .Values.celeryWorker.autoscaling.enabled }}
  replicas: {{ .Values.celeryWorker.replicaCount }}
  {{- end }}
  selector:
    matchLabels:
      {{- include "code-story.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: celery-worker
  template:
    metadata:
      annotations:
        checksum/secret: {{ include (print $.Template.BasePath "/secrets.yaml") . | sha256sum }}
      labels:
        {{- include "code-story.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: celery-worker
    spec:
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "code-story.serviceAccountName" . }}
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        fsGroup: 1000
      containers:
        - name: worker
          image: "{{ .Values.celeryWorker.image.repository }}:{{ .Values.celeryWorker.image.tag | default .Chart.AppVersion }}"
          imagePullPolicy: {{ .Values.celeryWorker.image.pullPolicy }}
          command:
            {{- toYaml .Values.celeryWorker.command | nindent 12 }}
          env:
            - name: ENVIRONMENT
              value: "production"
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: {{ include "code-story.secretName" . }}
                  key: database-url
            - name: REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: {{ include "code-story.secretName" . }}
                  key: redis-url
            - name: CELERY_BROKER_URL
              valueFrom:
                secretKeyRef:
                  name: {{ include "code-story.secretName" . }}
                  key: celery-broker-url
            - name: CELERY_RESULT_BACKEND
              valueFrom:
                secretKeyRef:
                  name: {{ include "code-story.secretName" . }}
                  key: celery-result-backend
            - name: ANTHROPIC_API_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ include "code-story.secretName" . }}
                  key: anthropic-api-key
            - name: ELEVENLABS_API_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ include "code-story.secretName" . }}
                  key: elevenlabs-api-key
            - name: GITHUB_TOKEN
              valueFrom:
                secretKeyRef:
                  name: {{ include "code-story.secretName" . }}
                  key: github-token
            - name: AWS_S3_BUCKET
              value: {{ .Values.s3.bucket | quote }}
            - name: AWS_REGION
              value: {{ .Values.s3.region | quote }}
            {{- if .Values.s3.endpoint }}
            - name: AWS_S3_ENDPOINT
              value: {{ .Values.s3.endpoint | quote }}
            {{- end }}
            - name: AWS_ACCESS_KEY_ID
              valueFrom:
                secretKeyRef:
                  name: {{ include "code-story.secretName" . }}
                  key: aws-access-key-id
            - name: AWS_SECRET_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ include "code-story.secretName" . }}
                  key: aws-secret-access-key
          resources:
            {{- toYaml .Values.celeryWorker.resources | nindent 12 }}
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          volumeMounts:
            - name: tmp
              mountPath: /tmp
      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 2Gi
      {{- with .Values.celeryWorker.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.celeryWorker.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.celeryWorker.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
```

### 5. Secrets Template

**charts/code-story/templates/secrets.yaml:**
```yaml
{{- if .Values.secrets.create }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "code-story.fullname" . }}
  labels:
    {{- include "code-story.labels" . | nindent 4 }}
type: Opaque
stringData:
  {{- if .Values.postgresql.enabled }}
  database-url: "postgresql://{{ .Values.postgresql.auth.username }}:{{ .Values.postgresql.auth.password }}@{{ include "code-story.fullname" . }}-postgresql:5432/{{ .Values.postgresql.auth.database }}"
  {{- else }}
  database-url: "postgresql://{{ .Values.externalDatabase.username }}:{{ .Values.externalDatabase.password }}@{{ .Values.externalDatabase.host }}:{{ .Values.externalDatabase.port }}/{{ .Values.externalDatabase.database }}"
  {{- end }}
  
  {{- if .Values.redis.enabled }}
  redis-url: "redis://:{{ .Values.redis.auth.password }}@{{ include "code-story.fullname" . }}-redis-master:6379/0"
  celery-broker-url: "redis://:{{ .Values.redis.auth.password }}@{{ include "code-story.fullname" . }}-redis-master:6379/1"
  celery-result-backend: "redis://:{{ .Values.redis.auth.password }}@{{ include "code-story.fullname" . }}-redis-master:6379/2"
  {{- else }}
  redis-url: "redis://:{{ .Values.externalRedis.password }}@{{ .Values.externalRedis.host }}:{{ .Values.externalRedis.port }}/0"
  celery-broker-url: "redis://:{{ .Values.externalRedis.password }}@{{ .Values.externalRedis.host }}:{{ .Values.externalRedis.port }}/1"
  celery-result-backend: "redis://:{{ .Values.externalRedis.password }}@{{ .Values.externalRedis.host }}:{{ .Values.externalRedis.port }}/2"
  {{- end }}
  
  jwt-secret: {{ .Values.secrets.jwtSecret | quote }}
  anthropic-api-key: {{ .Values.secrets.anthropicApiKey | quote }}
  elevenlabs-api-key: {{ .Values.secrets.elevenLabsApiKey | quote }}
  github-token: {{ .Values.secrets.githubToken | quote }}
  aws-access-key-id: {{ .Values.s3.accessKeyId | quote }}
  aws-secret-access-key: {{ .Values.s3.secretAccessKey | quote }}
{{- end }}
```

### 6. HorizontalPodAutoscaler

**charts/code-story/templates/api/hpa.yaml:**
```yaml
{{- if .Values.api.autoscaling.enabled }}
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: {{ include "code-story.fullname" . }}-api
  labels:
    {{- include "code-story.labels" . | nindent 4 }}
    app.kubernetes.io/component: api
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: {{ include "code-story.fullname" . }}-api
  minReplicas: {{ .Values.api.autoscaling.minReplicas }}
  maxReplicas: {{ .Values.api.autoscaling.maxReplicas }}
  metrics:
    {{- if .Values.api.autoscaling.targetCPUUtilizationPercentage }}
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: {{ .Values.api.autoscaling.targetCPUUtilizationPercentage }}
    {{- end }}
    {{- if .Values.api.autoscaling.targetMemoryUtilizationPercentage }}
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: {{ .Values.api.autoscaling.targetMemoryUtilizationPercentage }}
    {{- end }}
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 10
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
        - type: Percent
          value: 100
          periodSeconds: 15
        - type: Pods
          value: 4
          periodSeconds: 15
      selectPolicy: Max
{{- end }}
```

### 7. Network Policy

**charts/code-story/templates/networkpolicy.yaml:**
```yaml
{{- if .Values.networkPolicy.enabled }}
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: {{ include "code-story.fullname" . }}
  labels:
    {{- include "code-story.labels" . | nindent 4 }}
spec:
  podSelector:
    matchLabels:
      {{- include "code-story.selectorLabels" . | nindent 6 }}
  policyTypes:
    - Ingress
    - Egress
  ingress:
    # Allow traffic from ingress controller
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - protocol: TCP
          port: 8000
        - protocol: TCP
          port: 80
    # Allow internal pod-to-pod communication
    - from:
        - podSelector:
            matchLabels:
              {{- include "code-story.selectorLabels" . | nindent 14 }}
  egress:
    # Allow DNS
    - to:
        - namespaceSelector: {}
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53
    # Allow internal services (PostgreSQL, Redis)
    - to:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 5432
        - protocol: TCP
          port: 6379
    # Allow external HTTPS (Anthropic, ElevenLabs, GitHub APIs)
    - to:
        - ipBlock:
            cidr: 0.0.0.0/0
            except:
              - 10.0.0.0/8
              - 172.16.0.0/12
              - 192.168.0.0/16
      ports:
        - protocol: TCP
          port: 443
{{- end }}
```

### 8. PodDisruptionBudget

**charts/code-story/templates/api/pdb.yaml:**
```yaml
{{- if .Values.api.podDisruptionBudget.enabled }}
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: {{ include "code-story.fullname" . }}-api
  labels:
    {{- include "code-story.labels" . | nindent 4 }}
    app.kubernetes.io/component: api
spec:
  minAvailable: {{ .Values.api.podDisruptionBudget.minAvailable }}
  selector:
    matchLabels:
      {{- include "code-story.selectorLabels" . | nindent 6 }}
      app.kubernetes.io/component: api
{{- end }}
```

### 9. Database Migration Job

**charts/code-story/templates/jobs/migration.yaml:**
```yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "code-story.fullname" . }}-migrate-{{ now | date "20060102150405" }}
  labels:
    {{- include "code-story.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 600
  template:
    metadata:
      labels:
        {{- include "code-story.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: migration
    spec:
      restartPolicy: OnFailure
      {{- with .Values.global.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      serviceAccountName: {{ include "code-story.serviceAccountName" . }}
      containers:
        - name: migrate
          image: "{{ .Values.api.image.repository }}:{{ .Values.api.image.tag | default .Chart.AppVersion }}"
          command:
            - alembic
            - upgrade
            - head
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: {{ include "code-story.secretName" . }}
                  key: database-url
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
```

### 10. Production Values Override

**charts/code-story/values-production.yaml:**
```yaml
# Production overrides for Code Story

api:
  replicaCount: 3
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      cpu: 2000m
      memory: 4Gi
  autoscaling:
    enabled: true
    minReplicas: 3
    maxReplicas: 20

celeryWorker:
  replicaCount: 5
  resources:
    requests:
      cpu: 1000m
      memory: 2Gi
    limits:
      cpu: 4000m
      memory: 8Gi
  autoscaling:
    enabled: true
    minReplicas: 5
    maxReplicas: 50

postgresql:
  enabled: false  # Use managed PostgreSQL (RDS, Cloud SQL)

externalDatabase:
  host: "codestory-prod.xxx.us-east-1.rds.amazonaws.com"
  existingSecret: "codestory-db-credentials"

redis:
  enabled: false  # Use managed Redis (ElastiCache, Memorystore)

externalRedis:
  host: "codestory-prod.xxx.cache.amazonaws.com"
  existingSecret: "codestory-redis-credentials"

s3:
  bucket: "codestory-production-audio"
  region: "us-east-1"
  existingSecret: "codestory-s3-credentials"

secrets:
  create: false
  existingSecret: "codestory-app-secrets"

metrics:
  enabled: true
  serviceMonitor:
    enabled: true
    namespace: monitoring

networkPolicy:
  enabled: true
```

## File Structure
```
charts/
└── code-story/
    ├── Chart.yaml
    ├── values.yaml
    ├── values-production.yaml
    ├── templates/
    │   ├── _helpers.tpl
    │   ├── secrets.yaml
    │   ├── serviceaccount.yaml
    │   ├── networkpolicy.yaml
    │   ├── api/
    │   │   ├── deployment.yaml
    │   │   ├── service.yaml
    │   │   ├── ingress.yaml
    │   │   ├── hpa.yaml
    │   │   └── pdb.yaml
    │   ├── celery-worker/
    │   │   ├── deployment.yaml
    │   │   └── hpa.yaml
    │   ├── celery-beat/
    │   │   └── deployment.yaml
    │   ├── web/
    │   │   ├── deployment.yaml
    │   │   ├── service.yaml
    │   │   └── ingress.yaml
    │   ├── admin/
    │   │   ├── deployment.yaml
    │   │   ├── service.yaml
    │   │   └── ingress.yaml
    │   └── jobs/
    │       └── migration.yaml
    └── README.md
```

## Validation Gates

### Gate 1: Helm Lint
```bash
helm lint charts/code-story
# Expected: 0 errors, 0 warnings
```

### Gate 2: Template Rendering
```bash
helm template code-story charts/code-story \
  --set secrets.jwtSecret=test \
  --set secrets.anthropicApiKey=test \
  --set secrets.elevenLabsApiKey=test \
  --set secrets.githubToken=test \
  > /tmp/rendered.yaml

kubectl apply --dry-run=client -f /tmp/rendered.yaml
```

### Gate 3: Local Deployment (minikube/kind)
```bash
# Create cluster
kind create cluster --name code-story-test

# Install
helm install code-story charts/code-story \
  --set postgresql.auth.password=testpass \
  --set redis.auth.password=testpass \
  --set secrets.jwtSecret=$(openssl rand -hex 32) \
  --set secrets.anthropicApiKey=$ANTHROPIC_API_KEY \
  --set secrets.elevenLabsApiKey=$ELEVENLABS_API_KEY \
  --set secrets.githubToken=$GITHUB_TOKEN \
  --wait --timeout=10m

# Verify
kubectl get pods
kubectl get svc
helm test code-story
```

### Gate 4: API Health
```bash
kubectl port-forward svc/code-story-api 8000:8000 &
curl http://localhost:8000/health
# Expected: {"status": "healthy", ...}
```

## Definition of Done
- [ ] Helm chart passes lint checks
- [ ] All templates render without errors
- [ ] Deploys successfully to local Kubernetes
- [ ] API responds to health checks
- [ ] Celery workers connect to Redis
- [ ] Database migrations run via Helm hook
- [ ] HPA scales pods based on load
- [ ] Network policies restrict traffic correctly
- [ ] Production values override defaults properly
- [ ] README documents installation process
