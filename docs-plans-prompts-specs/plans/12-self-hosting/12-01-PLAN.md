---
phase: 12-self-hosting
plan: 01
type: execute
domain: devops
---

<objective>
Create Docker Compose configuration for local development with all services (PostgreSQL, Redis, backend, frontend, admin dashboard).
</objective>

<context>
@BRIEF.md
@plans/06-fastapi-backend/06-01-PLAN.md
@plans/07-react-frontend/07-01-PLAN.md
</context>

<tasks>

<task type="auto">
  <n>Task 1: Create docker-compose.yml for development</n>
  <files>codestory/docker-compose.yml, codestory/.env.example</files>
  <action>
Create docker-compose.yml:

```yaml
version: '3.8'

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: codestory-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-codestory}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-codestory_dev}
      POSTGRES_DB: ${POSTGRES_DB:-codestory}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-codestory}"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - codestory-network

  # Redis Cache and Queue
  redis:
    image: redis:7-alpine
    container_name: codestory-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - codestory-network

  # FastAPI Backend
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: codestory-backend
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-codestory}:${POSTGRES_PASSWORD:-codestory_dev}@postgres:5432/${POSTGRES_DB:-codestory}
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-dev-secret-key-change-in-production}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_S3_BUCKET=${AWS_S3_BUCKET:-codestory-audio-dev}
      - ENVIRONMENT=development
    volumes:
      - ./backend:/app
      - backend_cache:/app/.cache
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - codestory-network

  # Celery Worker
  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile.dev
    container_name: codestory-celery
    command: celery -A app.celery_app worker --loglevel=info
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-codestory}:${POSTGRES_PASSWORD:-codestory_dev}@postgres:5432/${POSTGRES_DB:-codestory}
      - REDIS_URL=redis://redis:6379/0
      - CELERY_BROKER_URL=redis://redis:6379/1
      - CELERY_RESULT_BACKEND=redis://redis:6379/2
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - ELEVENLABS_API_KEY=${ELEVENLABS_API_KEY}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_S3_BUCKET=${AWS_S3_BUCKET:-codestory-audio-dev}
    volumes:
      - ./backend:/app
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - codestory-network

  # React Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: codestory-frontend
    environment:
      - VITE_API_URL=http://localhost:8000
      - VITE_WS_URL=ws://localhost:8000
    volumes:
      - ./frontend:/app
      - /app/node_modules
    ports:
      - "3000:3000"
    depends_on:
      - backend
    networks:
      - codestory-network

  # Admin Dashboard
  admin-dashboard:
    build:
      context: ./admin
      dockerfile: Dockerfile.dev
    container_name: codestory-admin
    environment:
      - VITE_API_URL=http://localhost:8000
    volumes:
      - ./admin:/app
      - /app/node_modules
    ports:
      - "3001:3001"
    depends_on:
      - backend
    networks:
      - codestory-network

  # Expo Mobile (Web Export)
  mobile:
    build:
      context: ./mobile
      dockerfile: Dockerfile.dev
    container_name: codestory-mobile
    environment:
      - EXPO_PUBLIC_API_URL=http://localhost:8000
    volumes:
      - ./mobile:/app
      - /app/node_modules
    ports:
      - "19006:19006"
    depends_on:
      - backend
    networks:
      - codestory-network

volumes:
  postgres_data:
  redis_data:
  backend_cache:

networks:
  codestory-network:
    driver: bridge
```

Create .env.example:

```bash
# Database
POSTGRES_USER=codestory
POSTGRES_PASSWORD=codestory_dev
POSTGRES_DB=codestory

# Authentication
JWT_SECRET_KEY=your-super-secret-jwt-key-change-in-production
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=30
JWT_REFRESH_TOKEN_EXPIRE_DAYS=7

# API Keys
ANTHROPIC_API_KEY=sk-ant-xxxxx
ELEVENLABS_API_KEY=xxxxx

# AWS S3
AWS_ACCESS_KEY_ID=xxxxx
AWS_SECRET_ACCESS_KEY=xxxxx
AWS_S3_BUCKET=codestory-audio-dev
AWS_REGION=us-east-1

# GitHub (for repo analysis)
GITHUB_TOKEN=ghp_xxxxx

# Environment
ENVIRONMENT=development
```
  </action>
  <verify>docker compose config</verify>
  <done>Docker Compose configuration created</done>
</task>

<task type="auto">
  <n>Task 2: Create development Dockerfiles</n>
  <files>codestory/backend/Dockerfile.dev, codestory/frontend/Dockerfile.dev</files>
  <action>
Create backend/Dockerfile.dev:

```dockerfile
FROM python:3.12-slim

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y \
    curl \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

# Install uv
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.cargo/bin:$PATH"

# Copy dependency files
COPY pyproject.toml uv.lock ./

# Install dependencies
RUN uv sync --frozen

# Copy application code
COPY . .

# Set environment
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Expose port
EXPOSE 8000

# Run with hot reload
CMD ["uv", "run", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
```

Create frontend/Dockerfile.dev:

```dockerfile
FROM node:20-alpine

WORKDIR /app

# Install dependencies
COPY package.json package-lock.json ./
RUN npm ci

# Copy application code
COPY . .

# Expose port
EXPOSE 3000

# Run development server
CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0"]
```

Create admin/Dockerfile.dev:

```dockerfile
FROM node:20-alpine

WORKDIR /app

# Install dependencies
COPY package.json package-lock.json ./
RUN npm ci

# Copy application code
COPY . .

# Expose port
EXPOSE 3001

# Run development server
CMD ["npm", "run", "dev", "--", "--host", "0.0.0.0", "--port", "3001"]
```

Create mobile/Dockerfile.dev:

```dockerfile
FROM node:20-alpine

WORKDIR /app

# Install dependencies
COPY package.json package-lock.json ./
RUN npm ci

# Install Expo CLI globally
RUN npm install -g expo-cli

# Copy application code
COPY . .

# Expose Expo web port
EXPOSE 19006

# Run Expo web
CMD ["npx", "expo", "start", "--web", "--port", "19006"]
```
  </action>
  <verify>docker build -f backend/Dockerfile.dev -t codestory-backend-dev ./backend</verify>
  <done>Development Dockerfiles created</done>
</task>

<task type="auto">
  <n>Task 3: Create Makefile and helper scripts</n>
  <files>codestory/Makefile, codestory/scripts/init-db.sql</files>
  <action>
Create Makefile:

```makefile
.PHONY: help up down logs migrate seed shell test clean

# Default target
help:
	@echo "Code Story Development Commands"
	@echo "================================"
	@echo "make up        - Start all services"
	@echo "make down      - Stop all services"
	@echo "make logs      - View service logs"
	@echo "make logs-f    - Follow service logs"
	@echo "make migrate   - Run database migrations"
	@echo "make seed      - Seed database with test data"
	@echo "make shell     - Open backend shell"
	@echo "make test      - Run tests"
	@echo "make clean     - Remove all containers and volumes"
	@echo "make rebuild   - Rebuild all containers"

# Start all services
up:
	docker compose up -d
	@echo "Services starting..."
	@echo "Frontend: http://localhost:3000"
	@echo "Backend API: http://localhost:8000"
	@echo "Admin Dashboard: http://localhost:3001"
	@echo "API Docs: http://localhost:8000/docs"

# Stop all services
down:
	docker compose down

# View logs
logs:
	docker compose logs

logs-f:
	docker compose logs -f

logs-backend:
	docker compose logs -f backend celery-worker

# Database operations
migrate:
	docker compose exec backend uv run alembic upgrade head

migrate-create:
	docker compose exec backend uv run alembic revision --autogenerate -m "$(msg)"

seed:
	docker compose exec backend uv run python -m scripts.seed_db

# Shell access
shell:
	docker compose exec backend bash

shell-db:
	docker compose exec postgres psql -U codestory -d codestory

shell-redis:
	docker compose exec redis redis-cli

# Testing
test:
	docker compose exec backend uv run pytest -v

test-cov:
	docker compose exec backend uv run pytest --cov=app --cov-report=html

# Cleanup
clean:
	docker compose down -v --remove-orphans
	docker system prune -f

# Rebuild
rebuild:
	docker compose down
	docker compose build --no-cache
	docker compose up -d

# Health check
health:
	@echo "Checking service health..."
	@curl -s http://localhost:8000/health | jq . || echo "Backend not ready"
	@curl -s http://localhost:3000 > /dev/null && echo "Frontend: OK" || echo "Frontend: Not ready"
```

Create scripts/init-db.sql:

```sql
-- Initialize extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- Create enum types
DO $$ BEGIN
    CREATE TYPE story_status AS ENUM ('pending', 'analyzing', 'generating', 'synthesizing', 'completed', 'failed');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
    CREATE TYPE narrative_style AS ENUM ('fiction', 'documentary', 'tutorial', 'podcast', 'technical');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
    CREATE TYPE user_plan AS ENUM ('free', 'pro', 'enterprise');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;

-- Grant permissions
GRANT ALL PRIVILEGES ON DATABASE codestory TO codestory;
```
  </action>
  <verify>make help</verify>
  <done>Makefile and helper scripts created</done>
</task>

</tasks>

<playwright_validation_gate>
```
Playwright Action: Run 'make up' to start services
Expected: All containers start successfully

Playwright Action: Check http://localhost:8000/health
Expected: Backend returns healthy status

Playwright Action: Check http://localhost:3000
Expected: Frontend loads successfully

Playwright Action: Run 'make migrate'
Expected: Database migrations complete
```
</playwright_validation_gate>
